{% extends "base.html" %}
{% block title %}Stoklarım - Minibar Takip Sistemi{% endblock %}
{% block page_title %}Stoklarım{% endblock %}
{% block page_icon_bg %}bg-gradient-to-br from-emerald-500 to-teal-600{% endblock %}
{% block page_icon %}fas fa-boxes{% endblock %}

{% block extra_head %}
<style>
  /* Bu sayfada header'daki otel seçimini gizle */
  #header_otel_secim { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
  <!-- Başlık ve İstatistikler -->
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6"
  >
    <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-4">
      {% if secili_otel_id and secili_otel_adi %}
      <i class="fas fa-hotel mr-2 text-indigo-500"></i>{{ secili_otel_adi }} - Depo Stok Durumu
      {% else %}
      <i class="fas fa-globe mr-2 text-amber-500"></i>Tüm Oteller - Depo Stok Durumu
      {% endif %}
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      {% set toplam = stok_bilgileri|length %} {% set tukenen =
      stok_bilgileri|selectattr('durum', 'equalto', 'tukendi')|list|length %} {%
      set kritik = stok_bilgileri|selectattr('durum', 'equalto',
      'kritik')|list|length %} {% set yeterli =
      stok_bilgileri|selectattr('durum', 'equalto', 'yeterli')|list|length %}

      <div
        class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-blue-600 dark:text-blue-400 font-medium">
              Toplam Ürün
            </p>
            <p class="text-3xl font-bold text-blue-900 dark:text-blue-100 mt-1">
              {{ toplam }}
            </p>
          </div>
          <i class="fas fa-boxes text-4xl text-blue-400"></i>
        </div>
      </div>

      <div
        class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 border border-green-200 dark:border-green-800"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-green-600 dark:text-green-400 font-medium">
              Yeterli Stok
            </p>
            <p
              class="text-3xl font-bold text-green-900 dark:text-green-100 mt-1"
            >
              {{ yeterli }}
            </p>
          </div>
          <i class="fas fa-check-circle text-4xl text-green-400"></i>
        </div>
      </div>

      <div
        class="bg-orange-50 dark:bg-orange-900/20 rounded-lg p-4 border border-orange-200 dark:border-orange-800"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-orange-600 dark:text-orange-400 font-medium">
              Kritik Seviye
            </p>
            <p
              class="text-3xl font-bold text-orange-900 dark:text-orange-100 mt-1"
            >
              {{ kritik }}
            </p>
          </div>
          <i class="fas fa-exclamation-triangle text-4xl text-orange-400"></i>
        </div>
      </div>

      <div
        class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 border border-red-200 dark:border-red-800"
      >
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm text-red-600 dark:text-red-400 font-medium">
              Tükenen
            </p>
            <p class="text-3xl font-bold text-red-900 dark:text-red-100 mt-1">
              {{ tukenen }}
            </p>
          </div>
          <i class="fas fa-times-circle text-4xl text-red-400"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Filtreler -->
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-4"
  >
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label
          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          ><i class="fas fa-hotel mr-1 text-indigo-500"></i>Otel Filtresi</label
        >
        <select
          id="otel_filtre"
          onchange="otelDegistir(this.value)"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-900 dark:text-white"
        >
          <option value="">Tüm Oteller</option>
          {% for otel in otel_secenekleri %}
          <option value="{{ otel.id }}" {% if otel.id == secili_otel_id %}selected{% endif %}>{{ otel.ad }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label
          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >Durum Filtresi</label
        >
        <select
          id="durum_filtre"
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-900 dark:text-white"
        >
          <option value="tumu">Tümü</option>
          <option value="tukendi">Tükenenler</option>
          <option value="kritik">Kritik Seviye</option>
          <option value="yeterli">Yeterli Stok</option>
        </select>
      </div>
      <div>
        <label
          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >Ürün Ara</label
        >
        <input
          type="text"
          id="urun_ara"
          placeholder="Ürün adı..."
          class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-900 dark:text-white"
        />
      </div>
      <div class="flex items-end">
        <button
          onclick="filtreleriTemizle()"
          class="w-full px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg transition-colors font-medium"
        >
          <i class="fas fa-redo mr-2"></i>Filtreleri Temizle
        </button>
      </div>
    </div>
  </div>

  <!-- Stok Listesi -->
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden"
  >
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700" id="stok_tablosu">
        <thead class="bg-slate-50 dark:bg-slate-900">
          <tr>
            <th
              class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors select-none"
              data-sort="urun" onclick="sirala('urun')"
            >
              <div class="flex items-center gap-2">
                Ürün
                <i class="fas fa-sort text-slate-400 sort-icon" data-col="urun"></i>
              </div>
            </th>
            <th
              class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors select-none"
              data-sort="grup" onclick="sirala('grup')"
            >
              <div class="flex items-center justify-center gap-2">
                Grup
                <i class="fas fa-sort text-slate-400 sort-icon" data-col="grup"></i>
              </div>
            </th>
            <th
              class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors select-none"
              data-sort="stok" onclick="sirala('stok')"
            >
              <div class="flex items-center justify-center gap-2">
                Mevcut Stok
                <i class="fas fa-sort text-slate-400 sort-icon" data-col="stok"></i>
              </div>
            </th>
            <th
              class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors select-none"
              data-sort="kritik" onclick="sirala('kritik')"
            >
              <div class="flex items-center justify-center gap-2">
                Kritik Seviye
                <i class="fas fa-sort text-slate-400 sort-icon" data-col="kritik"></i>
              </div>
            </th>
            <th
              class="px-6 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase cursor-pointer hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors select-none"
              data-sort="durum" onclick="sirala('durum')"
            >
              <div class="flex items-center justify-center gap-2">
                Durum
                <i class="fas fa-sort text-slate-400 sort-icon" data-col="durum"></i>
              </div>
            </th>
          </tr>
        </thead>
        <tbody
          class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700"
          id="stok_listesi"
        >
          {% for item in stok_bilgileri %}
          <tr
            data-durum="{{ item.durum }}"
            data-urun-adi="{{ item.urun.urun_adi|lower }}"
            data-grup="{{ item.urun.grup.grup_adi|lower if item.urun.grup else '' }}"
            data-stok="{{ item.mevcut_stok }}"
            data-kritik="{{ item.kritik_seviye }}"
          >
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div
                  class="w-10 h-10 bg-slate-100 dark:bg-slate-700 rounded-lg flex items-center justify-center mr-3"
                >
                  <i class="fas fa-box text-slate-600 dark:text-slate-400"></i>
                </div>
                <div>
                  <div
                    class="text-sm font-medium text-slate-900 dark:text-white"
                  >
                    {{ item.urun.urun_adi }}
                  </div>
                  <div class="text-sm text-slate-500 dark:text-slate-400">
                    {{ item.urun.birim }}
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span class="text-sm text-slate-600 dark:text-slate-400">
                {{ item.urun.grup.grup_adi if item.urun.grup else '-' }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span
                class="text-lg font-bold {% if item.durum == 'tukendi' %}text-red-600{% elif item.durum == 'kritik' %}text-orange-600{% else %}text-green-600{% endif %}"
              >
                {{ item.mevcut_stok }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              <span class="text-sm text-slate-600 dark:text-slate-400"
                >{{ item.kritik_seviye }}</span
              >
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-center">
              {% if item.durum == 'tukendi' %}
              <span
                class="inline-flex items-center px-3 py-1 bg-red-100 dark:bg-red-900/30 text-red-800 dark:text-red-200 rounded-full text-xs font-semibold"
              >
                <i class="fas fa-times-circle mr-1"></i>Tükendi
              </span>
              {% elif item.durum == 'kritik' %}
              <span
                class="inline-flex items-center px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-800 dark:text-orange-200 rounded-full text-xs font-semibold"
              >
                <i class="fas fa-exclamation-triangle mr-1"></i>Kritik
              </span>
              {% else %}
              <span
                class="inline-flex items-center px-3 py-1 bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200 rounded-full text-xs font-semibold"
              >
                <i class="fas fa-check-circle mr-1"></i>Yeterli
              </span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // Sıralama durumu
  let siralaDurum = { kolon: null, yon: 'asc' };
  
  // Otel değiştirme
  function otelDegistir(otelId) {
    if (otelId) {
      window.location.href = '/depo-stoklarim?otel_id=' + otelId;
    } else {
      window.location.href = '/depo-stoklarim';
    }
  }

  // Durum filtreleme
  document.getElementById("durum_filtre").addEventListener("change", function () {
    filtrele();
  });

  // Ürün arama
  document.getElementById("urun_ara").addEventListener("input", function () {
    filtrele();
  });

  function filtrele() {
    const durumFiltre = document.getElementById("durum_filtre").value;
    const aramaMetni = document.getElementById("urun_ara").value.toLowerCase();
    const satirlar = document.querySelectorAll("#stok_listesi tr");

    satirlar.forEach((satir) => {
      const durum = satir.dataset.durum;
      const urunAdi = satir.dataset.urunAdi;

      let durumUygun = durumFiltre === "tumu" || durum === durumFiltre;
      let aramaUygun = !aramaMetni || urunAdi.includes(aramaMetni);

      if (durumUygun && aramaUygun) {
        satir.style.display = "";
      } else {
        satir.style.display = "none";
      }
    });
  }

  function filtreleriTemizle() {
    // Otel filtresini de temizle
    document.getElementById("otel_filtre").value = "";
    document.getElementById("durum_filtre").value = "tumu";
    document.getElementById("urun_ara").value = "";
    // Sayfayı yeniden yükle (otel filtresi için)
    window.location.href = '/depo-stoklarim';
  }
  
  // Tablo sıralama fonksiyonu
  function sirala(kolon) {
    const tbody = document.getElementById('stok_listesi');
    const satirlar = Array.from(tbody.querySelectorAll('tr'));
    
    // Sıralama yönünü belirle
    if (siralaDurum.kolon === kolon) {
      siralaDurum.yon = siralaDurum.yon === 'asc' ? 'desc' : 'asc';
    } else {
      siralaDurum.kolon = kolon;
      siralaDurum.yon = 'asc';
    }
    
    // İkonları güncelle
    document.querySelectorAll('.sort-icon').forEach(icon => {
      icon.className = 'fas fa-sort text-slate-400 sort-icon';
      icon.dataset.col = icon.dataset.col;
    });
    
    const aktifIcon = document.querySelector(`.sort-icon[data-col="${kolon}"]`);
    if (aktifIcon) {
      aktifIcon.className = `fas fa-sort-${siralaDurum.yon === 'asc' ? 'up' : 'down'} text-blue-500 sort-icon`;
    }
    
    // Sıralama
    satirlar.sort((a, b) => {
      let degerA, degerB;
      
      switch(kolon) {
        case 'urun':
          degerA = a.dataset.urunAdi || '';
          degerB = b.dataset.urunAdi || '';
          break;
        case 'grup':
          degerA = a.dataset.grup || '';
          degerB = b.dataset.grup || '';
          break;
        case 'stok':
          degerA = parseInt(a.dataset.stok) || 0;
          degerB = parseInt(b.dataset.stok) || 0;
          break;
        case 'kritik':
          degerA = parseInt(a.dataset.kritik) || 0;
          degerB = parseInt(b.dataset.kritik) || 0;
          break;
        case 'durum':
          // Durum sıralaması: tukendi > kritik > yeterli
          const durumSira = { 'tukendi': 0, 'kritik': 1, 'yeterli': 2 };
          degerA = durumSira[a.dataset.durum] ?? 3;
          degerB = durumSira[b.dataset.durum] ?? 3;
          break;
        default:
          return 0;
      }
      
      // Sayısal karşılaştırma
      if (typeof degerA === 'number' && typeof degerB === 'number') {
        return siralaDurum.yon === 'asc' ? degerA - degerB : degerB - degerA;
      }
      
      // String karşılaştırma (Türkçe desteği)
      const karsilastir = degerA.localeCompare(degerB, 'tr', { sensitivity: 'base' });
      return siralaDurum.yon === 'asc' ? karsilastir : -karsilastir;
    });
    
    // DOM'u güncelle
    satirlar.forEach(satir => tbody.appendChild(satir));
  }
</script>
{% endblock %}
