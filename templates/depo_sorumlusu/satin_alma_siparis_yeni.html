{% extends "base.html" %} {% block title %}Satın Alma - Minibar Takip Sistemi{%
endblock %} {% block page_title %}Satın Alma{% endblock %} {% block content %}
<style>
  .urun-card {
    min-height: 100px;
    transition: transform 0.15s, box-shadow 0.15s;
    cursor: pointer;
  }
  .urun-card:active {
    transform: scale(0.98);
  }
  .urun-card.selected {
    ring: 2px;
    ring-color: #3b82f6;
  }
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  .sepet-badge {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 50;
  }
  .stok-toggle-wrapper {
    display: inline-block;
  }
  .stok-toggle-wrapper input[type="checkbox"] {
    display: none;
  }
  .stok-toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    width: 100px;
    height: 32px;
    background: linear-gradient(to bottom, #64748b 0%, #475569 100%);
    border-radius: 16px;
    cursor: pointer;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  .stok-toggle .toggle-handler {
    position: absolute;
    left: 2px;
    width: 28px;
    height: 28px;
    background: linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    transition: left 0.3s ease;
    z-index: 3;
  }
  .stok-toggle .toggle-on,
  .stok-toggle .toggle-off {
    position: absolute;
    font-size: 11px;
    font-weight: 600;
    transition: opacity 0.3s;
    color: white;
  }
  .stok-toggle .toggle-on {
    left: 10px;
    opacity: 0;
  }
  .stok-toggle .toggle-off {
    right: 10px;
    opacity: 1;
  }
  .stok-toggle-wrapper input:checked + .stok-toggle {
    background: linear-gradient(to bottom, #22c55e 0%, #16a34a 100%);
  }
  .stok-toggle-wrapper input:checked + .stok-toggle .toggle-handler {
    left: 70px;
  }
  .stok-toggle-wrapper input:checked + .stok-toggle .toggle-on {
    opacity: 1;
  }
  .stok-toggle-wrapper input:checked + .stok-toggle .toggle-off {
    opacity: 0;
  }
</style>

<div class="space-y-6">
  {% if otel_secenekleri and otel_secenekleri|length > 1 and not secili_otel_id
  %}
  <!-- Otel Seçimi Gerekli -->
  <div
    class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg p-6 text-center"
  >
    <i class="fas fa-hotel text-4xl text-amber-500 mb-4"></i>
    <h3 class="text-lg font-medium text-amber-800 dark:text-amber-200 mb-2">
      Otel Seçimi Gerekli
    </h3>
    <p class="text-sm text-amber-600 dark:text-amber-400 mb-4">
      Satın alma siparişi oluşturmak için lütfen bir otel seçin.
    </p>
    <div class="flex justify-center gap-2 flex-wrap">
      {% for otel in otel_secenekleri %}
      <a
        href="?otel_id={{ otel.id }}"
        class="px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg"
        >{{ otel.ad }}</a
      >
      {% endfor %}
    </div>
  </div>
  {% else %}
</div>

<!-- Kritik Stok Önerileri -->
{% if siparis_onerileri %}
<div
  class="bg-gradient-to-r from-red-50 to-orange-50 dark:from-red-900/20 dark:to-orange-900/20 rounded-lg shadow-md border border-red-200 dark:border-red-800"
>
  <div class="px-4 py-4 sm:p-5">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle text-red-500 mr-3 text-xl"></i>
        <h3 class="text-base font-medium text-slate-900 dark:text-slate-100">
          Kritik Stok Uyarısı
        </h3>
      </div>
      <span
        class="px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200"
      >
        {{ siparis_onerileri|length }} Ürün
      </span>
    </div>
    <div class="flex flex-wrap gap-2">
      {% for oneri in siparis_onerileri[:6] %}
      <button
        type="button"
        onclick="kritikUrunEkle({{ oneri.urun_id }}, {{ oneri.onerilen_miktar }})"
        class="px-3 py-2 bg-white dark:bg-slate-800 border border-red-200 dark:border-red-700 rounded-lg text-sm font-medium text-red-700 dark:text-red-300"
      >
        <i class="fas fa-plus mr-1"></i>{{ oneri.urun_adi }} ({{
        oneri.mevcut_stok }}/{{ oneri.kritik_seviye }})
      </button>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

<!-- Ana İçerik -->
<div class="bg-white dark:bg-slate-800 shadow rounded-lg">
  <div class="px-4 py-5 sm:p-6">
    <!-- Grup Filtreleri -->
    <div id="grup_butonlari" class="flex flex-wrap items-center gap-2 mb-4">
      <button
        type="button"
        data-grup-id=""
        class="grup-btn px-4 py-2 rounded-lg text-sm font-medium ring-2 ring-offset-2 ring-slate-400"
        style="
          background: linear-gradient(135deg, #475569, #334155);
          color: white;
        "
      >
        Tümü
      </button>
      {% for grup in urun_gruplari %}
      <button
        type="button"
        data-grup-id="{{ grup.id }}"
        data-renk-idx="{{ loop.index0 }}"
        class="grup-btn px-4 py-2 rounded-lg text-sm font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300"
      >
        {{ grup.grup_adi }}
      </button>
      {% endfor %}

      <!-- Stokta Olmayanlar Toggle -->
      <div class="flex items-center gap-2 ml-auto">
        <span class="text-sm font-medium text-slate-600 dark:text-slate-300"
          >Stoksuz:</span
        >
        <div class="stok-toggle-wrapper">
          <input
            type="checkbox"
            id="stoksuz_gizle"
            checked
            onchange="renderGrid()"
          />
          <label for="stoksuz_gizle" class="stok-toggle">
            <span class="toggle-handler"></span>
            <span class="toggle-on">Göster</span>
            <span class="toggle-off">Gizle</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Arama -->
    <div class="mb-4">
      <input
        type="text"
        id="grid_arama"
        placeholder="Ürün ara..."
        oninput="renderGrid()"
        class="px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md text-sm w-64 dark:bg-slate-700 dark:text-white"
      />
    </div>

    <!-- Ürün Grid -->
    <div
      id="urun_grid"
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 max-h-[450px] overflow-y-auto p-1"
    >
      <div class="text-center py-8 text-slate-500 col-span-full">
        <i class="fas fa-spinner fa-spin text-2xl"></i>
        <p>Yükleniyor...</p>
      </div>
    </div>
  </div>
</div>

  <!-- Sepet Paneli -->
  <div id="sepet_panel" class="hidden bg-white dark:bg-slate-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-medium text-slate-900 dark:text-white">
          <i class="fas fa-shopping-cart text-blue-600 mr-2"></i>
          Sipariş Sepeti (<span id="sepet_adet">0</span> ürün)
        </h3>
        <button type="button" onclick="sepetiTemizle()" class="text-sm text-red-600 dark:text-red-400">
          <i class="fas fa-trash mr-1"></i>Temizle
        </button>
      </div>
      
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
          <thead class="bg-slate-50 dark:bg-slate-900">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400">Ürün</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-slate-500 dark:text-slate-400">Miktar</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-slate-500 dark:text-slate-400">Mevcut Stok</th>
              <th class="px-4 py-2 text-center text-xs font-medium text-slate-500 dark:text-slate-400">Sil</th>
            </tr>
          </thead>
          <tbody id="sepet_tbody" class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700"></tbody>
        </table>
      </div>

      <!-- Açıklama -->
      <div class="mt-4">
        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">Açıklama (Opsiyonel)</label>
        <textarea id="siparis_aciklama" rows="2" placeholder="Sipariş hakkında not..."
          class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md text-sm dark:bg-slate-700 dark:text-white"></textarea>
      </div>

      <!-- Butonlar -->
      <div class="flex justify-end gap-3 mt-4">
        <button type="button" onclick="sepetiTemizle()" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg text-sm font-medium">
          <i class="fas fa-times mr-2"></i>İptal
        </button>
        <button type="button" onclick="siparisOlustur()" id="siparis_olustur_btn" disabled
          class="px-6 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed">
          <i class="fas fa-paper-plane mr-2"></i>Onaya Gönder
        </button>
      </div>
    </div>
  </div>

  <!-- Floating Sepet Butonu -->
  <div id="sepet_badge" class="sepet-badge hidden">
    <button type="button" onclick="scrollToSepet()"
      class="flex items-center gap-2 px-4 py-3 bg-blue-600 text-white rounded-full shadow-lg font-medium">
      <i class="fas fa-shopping-cart"></i>
      <span id="sepet_badge_adet">0</span> Ürün
    </button>
  </div>

  {% endif %}
</div>

<!-- Miktar Modal -->
<div id="miktar_modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-slate-800 rounded-lg p-6 w-full max-w-sm mx-4 shadow-2xl">
    <div id="modal_urun_bilgi" class="mb-4 p-3 rounded-lg border-2">
      <p class="font-semibold text-lg text-white drop-shadow-md" id="modal_urun_adi"></p>
      <p class="text-sm text-white/80" id="modal_urun_grup"></p>
      <p class="text-sm font-bold mt-1 text-white" id="modal_urun_stok"></p>
    </div>
    
    <div class="mb-4">
      <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Sipariş Miktarı:</label>
      <input type="number" id="modal_miktar" min="1" value="100"
        class="w-full px-4 py-3 text-xl text-center border-2 border-slate-300 dark:border-slate-600 rounded-lg focus:border-blue-500 dark:bg-slate-700 dark:text-white">
    </div>
    
    <div class="grid grid-cols-4 gap-2 mb-4">
      <button type="button" class="miktar-btn px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg font-medium text-sm" data-miktar="10">+10</button>
      <button type="button" class="miktar-btn px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg font-medium text-sm" data-miktar="25">+25</button>
      <button type="button" class="miktar-btn px-3 py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 rounded-lg font-medium text-sm" data-miktar="50">+50</button>
      <button type="button" class="miktar-btn px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg font-medium text-sm" data-miktar="100">+100</button>
      <button type="button" class="miktar-btn px-3 py-2 bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-300 rounded-lg font-medium text-sm" data-miktar="200">+200</button>
      <button type="button" class="miktar-btn px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg font-medium text-sm" data-miktar="500">+500</button>
      <button type="button" class="miktar-btn px-3 py-2 bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-300 rounded-lg font-medium text-sm" data-miktar="1000">+1000</button>
      <button type="button" onclick="document.getElementById('modal_miktar').value=0" class="px-3 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg font-medium text-sm">Sıfırla</button>
    </div>
    
    <div class="flex gap-2">
      <button type="button" onclick="modalKapat()" class="flex-1 px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg font-medium">İptal</button>
      <button type="button" onclick="sepeteEkle()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium">
        <i class="fas fa-cart-plus mr-2"></i>Sepete Ekle
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Renk paleti
const grupRenkleri = [
  {bg: 'linear-gradient(135deg, #3b82f6, #1d4ed8)', text: 'white'},
  {bg: 'linear-gradient(135deg, #22c55e, #16a34a)', text: 'white'},
  {bg: 'linear-gradient(135deg, #f59e0b, #d97706)', text: 'white'},
  {bg: 'linear-gradient(135deg, #ef4444, #dc2626)', text: 'white'},
  {bg: 'linear-gradient(135deg, #8b5cf6, #7c3aed)', text: 'white'},
  {bg: 'linear-gradient(135deg, #ec4899, #db2777)', text: 'white'},
  {bg: 'linear-gradient(135deg, #06b6d4, #0891b2)', text: 'white'},
  {bg: 'linear-gradient(135deg, #84cc16, #65a30d)', text: 'white'}
];

// Global değişkenler
let tumUrunler = [];
let sepet = {}; // {urun_id: {urun_adi, grup_adi, miktar, stok, renk}}
let aktifGrup = '';
let seciliUrun = null;

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
  urunleriYukle();
  grupButonlariniAyarla();
  miktarButonlariniAyarla();
});

// Ürünleri API'den yükle
async function urunleriYukle() {
  try {
    const response = await fetch('/api/urunler-stok');
    const data = await response.json();
    if (data.success) {
      tumUrunler = data.urunler;
      renderGrid();
    }
  } catch (error) {
    console.error('Ürün yükleme hatası:', error);
    document.getElementById('urun_grid').innerHTML = '<div class="col-span-full text-center py-8 text-red-500"><i class="fas fa-exclamation-circle text-2xl"></i><p>Ürünler yüklenemedi</p></div>';
  }
}

// Grid render
function renderGrid() {
  const container = document.getElementById('urun_grid');
  const aramaText = document.getElementById('grid_arama').value.toLowerCase();
  const stoksuzGizle = document.getElementById('stoksuz_gizle').checked;
  
  let filtrelenmis = tumUrunler.filter(u => {
    if (aktifGrup && u.grup_id != aktifGrup) return false;
    if (aramaText && !u.urun_adi.toLowerCase().includes(aramaText)) return false;
    if (!stoksuzGizle && u.stok <= 0) return false;
    return true;
  });
  
  if (filtrelenmis.length === 0) {
    container.innerHTML = '<div class="col-span-full text-center py-8 text-slate-500"><i class="fas fa-search text-2xl mb-2"></i><p>Ürün bulunamadı</p></div>';
    return;
  }
  
  let html = '';
  filtrelenmis.forEach(urun => {
    const renkIdx = (urun.grup_id || 0) % grupRenkleri.length;
    const renk = grupRenkleri[renkIdx];
    const sepette = sepet[urun.id];
    
    html += `
      <div class="urun-card rounded-lg p-3 border-2 ${sepette ? 'border-blue-500 ring-2 ring-blue-300' : 'border-slate-200 dark:border-slate-700'}"
           style="background: ${renk.bg};" onclick="urunSec(${urun.id})">
        <p class="font-semibold text-sm line-clamp-2 mb-1" style="color: ${renk.text}">${urun.urun_adi}</p>
        <p class="text-xs opacity-80" style="color: ${renk.text}">${urun.grup_adi || 'Genel'}</p>
        <div class="flex justify-between items-center mt-2">
          <span class="text-xs font-bold px-2 py-1 rounded ${urun.stok > 0 ? 'bg-white/20' : 'bg-red-500'}" style="color: ${renk.text}">
            Stok: ${urun.stok}
          </span>
          ${sepette ? `<span class="text-xs font-bold px-2 py-1 rounded bg-white text-blue-600"><i class="fas fa-cart-plus mr-1"></i>${sepette.miktar}</span>` : ''}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Grup butonları
function grupButonlariniAyarla() {
  document.querySelectorAll('.grup-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      aktifGrup = this.dataset.grupId;
      document.querySelectorAll('.grup-btn').forEach(b => {
        b.classList.remove('ring-2', 'ring-offset-2', 'ring-slate-400');
        b.style.background = '';
      });
      this.classList.add('ring-2', 'ring-offset-2', 'ring-slate-400');
      if (!this.dataset.grupId) {
        this.style.background = 'linear-gradient(135deg, #475569, #334155)';
      }
      renderGrid();
    });
  });
}

// Miktar butonları
function miktarButonlariniAyarla() {
  document.querySelectorAll('.miktar-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const miktar = parseInt(this.dataset.miktar);
      const input = document.getElementById('modal_miktar');
      input.value = parseInt(input.value || 0) + miktar;
    });
  });
}

// Ürün seçimi - Modal aç
function urunSec(urunId) {
  const urun = tumUrunler.find(u => u.id === urunId);
  if (!urun) return;
  
  seciliUrun = urun;
  const renkIdx = (urun.grup_id || 0) % grupRenkleri.length;
  const renk = grupRenkleri[renkIdx];
  
  document.getElementById('modal_urun_adi').textContent = urun.urun_adi;
  document.getElementById('modal_urun_grup').textContent = urun.grup_adi || 'Genel';
  document.getElementById('modal_urun_stok').textContent = 'Mevcut Stok: ' + urun.stok;
  document.getElementById('modal_urun_bilgi').style.background = renk.bg;
  
  // Sepette varsa miktarı göster
  const sepette = sepet[urunId];
  document.getElementById('modal_miktar').value = sepette ? sepette.miktar : 100;
  
  document.getElementById('miktar_modal').classList.remove('hidden');
}

// Modal kapat
function modalKapat() {
  document.getElementById('miktar_modal').classList.add('hidden');
  seciliUrun = null;
}

// Sepete ekle
function sepeteEkle() {
  if (!seciliUrun) return;
  
  const miktar = parseInt(document.getElementById('modal_miktar').value) || 0;
  if (miktar <= 0) {
    // Sepetten çıkar
    delete sepet[seciliUrun.id];
  } else {
    const renkIdx = (seciliUrun.grup_id || 0) % grupRenkleri.length;
    sepet[seciliUrun.id] = {
      urun_adi: seciliUrun.urun_adi,
      grup_adi: seciliUrun.grup_adi || 'Genel',
      miktar: miktar,
      stok: seciliUrun.stok,
      renk: grupRenkleri[renkIdx]
    };
  }
  
  modalKapat();
  renderGrid();
  sepetiGuncelle();
}

// Kritik ürün ekle
function kritikUrunEkle(urunId, miktar) {
  const urun = tumUrunler.find(u => u.id === urunId);
  if (!urun) return;
  
  const renkIdx = (urun.grup_id || 0) % grupRenkleri.length;
  sepet[urunId] = {
    urun_adi: urun.urun_adi,
    grup_adi: urun.grup_adi || 'Genel',
    miktar: miktar,
    stok: urun.stok,
    renk: grupRenkleri[renkIdx]
  };
  
  renderGrid();
  sepetiGuncelle();
}

// Sepeti güncelle
function sepetiGuncelle() {
  const keys = Object.keys(sepet);
  const adet = keys.length;
  
  document.getElementById('sepet_adet').textContent = adet;
  document.getElementById('sepet_badge_adet').textContent = adet;
  
  // Panel ve badge görünürlüğü
  if (adet > 0) {
    document.getElementById('sepet_panel').classList.remove('hidden');
    document.getElementById('sepet_badge').classList.remove('hidden');
    document.getElementById('siparis_olustur_btn').disabled = false;
  } else {
    document.getElementById('sepet_panel').classList.add('hidden');
    document.getElementById('sepet_badge').classList.add('hidden');
    document.getElementById('siparis_olustur_btn').disabled = true;
  }
  
  // Tablo güncelle
  let html = '';
  keys.forEach(urunId => {
    const item = sepet[urunId];
    html += `
      <tr>
        <td class="px-4 py-3">
          <div class="flex items-center">
            <div class="w-3 h-3 rounded-full mr-2" style="background: ${item.renk.bg}"></div>
            <div>
              <p class="text-sm font-medium text-slate-900 dark:text-white">${item.urun_adi}</p>
              <p class="text-xs text-slate-500 dark:text-slate-400">${item.grup_adi}</p>
            </div>
          </div>
        </td>
        <td class="px-4 py-3 text-center">
          <input type="number" value="${item.miktar}" min="1" onchange="sepetMiktarGuncelle(${urunId}, this.value)"
            class="w-20 px-2 py-1 text-center border border-slate-300 dark:border-slate-600 rounded text-sm dark:bg-slate-700 dark:text-white">
        </td>
        <td class="px-4 py-3 text-center text-sm text-slate-600 dark:text-slate-400">${item.stok}</td>
        <td class="px-4 py-3 text-center">
          <button type="button" onclick="sepettenCikar(${urunId})" class="text-red-500 p-1">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `;
  });
  
  document.getElementById('sepet_tbody').innerHTML = html || '<tr><td colspan="4" class="text-center py-4 text-slate-500">Sepet boş</td></tr>';
}

// Sepet miktar güncelle
function sepetMiktarGuncelle(urunId, miktar) {
  miktar = parseInt(miktar) || 0;
  if (miktar <= 0) {
    delete sepet[urunId];
  } else {
    sepet[urunId].miktar = miktar;
  }
  renderGrid();
  sepetiGuncelle();
}

// Sepetten çıkar
function sepettenCikar(urunId) {
  delete sepet[urunId];
  renderGrid();
  sepetiGuncelle();
}

// Sepeti temizle
function sepetiTemizle() {
  sepet = {};
  renderGrid();
  sepetiGuncelle();
}

// Sepete scroll
function scrollToSepet() {
  document.getElementById('sepet_panel').scrollIntoView({ behavior: 'smooth' });
}

// Sipariş oluştur
async function siparisOlustur() {
  const keys = Object.keys(sepet);
  if (keys.length === 0) {
    alert('Sepette ürün yok!');
    return;
  }
  
  const aciklama = document.getElementById('siparis_aciklama').value;
  
  // Ürün listesi hazırla
  const urunler = keys.map(urunId => ({
    urun_id: parseInt(urunId),
    miktar: sepet[urunId].miktar
  }));
  
  // Butonu devre dışı bırak
  const btn = document.getElementById('siparis_olustur_btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Gönderiliyor...';
  
  try {
    const response = await fetch('/api/satin-alma/siparis-olustur', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        urunler: urunler,
        aciklama: aciklama
      })
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Başarılı
      alert('Sipariş başarıyla oluşturuldu!\nSipariş No: ' + data.siparis_no + '\n\nSistem yöneticisi onayı bekleniyor.');
      sepet = {};
      sepetiGuncelle();
      renderGrid();
      document.getElementById('siparis_aciklama').value = '';
      
      // Sipariş listesine yönlendir
      window.location.href = '/siparis-listesi';
    } else {
      alert('Hata: ' + data.message);
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Onaya Gönder';
    }
  } catch (error) {
    console.error('Sipariş hatası:', error);
    alert('Sipariş oluşturulurken bir hata oluştu!');
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Onaya Gönder';
  }
}

// Modal dışına tıklayınca kapat
document.getElementById('miktar_modal').addEventListener('click', function(e) {
  if (e.target === this) {
    modalKapat();
  }
});

// ESC tuşu ile modal kapat
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    modalKapat();
  }
});
</script>
{% endblock %}
