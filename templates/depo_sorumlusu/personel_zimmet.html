{% extends "base.html" %}
{% block title %}Otel Zimmet Atama{% endblock %}
{% block page_title %}Otel Zimmet Atama{% endblock %}

{% block content %}
<style>
    .urun-card { min-height: 130px; cursor: pointer; transition: transform 0.1s; border-radius: 8px; display: flex; flex-direction: column; }
    .urun-card:active { transform: scale(0.98); }
    .urun-card-header { padding: 6px 10px; border-radius: 8px 8px 0 0; font-size: 11px; font-weight: 700; text-transform: uppercase; text-align: center; }
    .urun-card-body { flex: 1; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; background: #fff; border-radius: 0 0 8px 8px; }
    .urun-card-name { font-size: 13px; font-weight: 600; color: #1e293b; text-align: center; line-height: 1.3; margin-bottom: 8px; }
    .urun-card-footer { display: flex; justify-content: space-between; font-size: 13px; margin-top: auto; padding-top: 8px; border-top: 1px solid #e2e8f0; }
    .urun-card-footer span { display: flex; flex-direction: column; }
    .urun-card-footer .label { color: #64748b; font-weight: 600; font-size: 11px; }
    .urun-card-footer .value { font-weight: 800; font-size: 16px; }
    .grup-btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; border: 2px solid transparent; transition: all 0.2s; }
    .grup-btn.aktif { box-shadow: 0 0 0 3px rgba(255,255,255,0.5); }
    .zimmet-kart { background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
    .zimmet-kart-header { padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .personel-chip { display: inline-flex; align-items: center; padding: 4px 10px; background: rgba(99,102,241,0.2); color: #a5b4fc; border-radius: 16px; font-size: 12px; font-weight: 500; margin: 2px; }
</style>

<div class="space-y-6">
    <!-- Otel Seçimi ve Ürün Ekle Butonu -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-6">
        <div class="flex flex-wrap items-end gap-4">
            <div class="flex-1 min-w-[250px]">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    <i class="fas fa-hotel mr-2 text-blue-500"></i>Otel Seçin
                </label>
                <select id="otel_select" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-lg text-base dark:bg-slate-700 dark:text-white">
                    <option value="">-- Otel Seçiniz --</option>
                    {% for otel in otel_secenekleri %}
                    <option value="{{ otel.id }}" data-ad="{{ otel.ad }}" {% if otel.id == secili_otel_id %}selected{% endif %}>{{ otel.ad }}</option>
                    {% endfor %}
                </select>
            </div>
            <button id="urun_ekle_btn" onclick="modalAc()" disabled class="px-6 py-3 bg-green-600 hover:bg-green-700 disabled:bg-slate-400 disabled:cursor-not-allowed text-white rounded-lg font-bold text-base transition-colors">
                <i class="fas fa-plus mr-2"></i>Ürün Ekle
            </button>
        </div>
    </div>

    <!-- Zimmet Atama İşlemleri Listesi -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
            <i class="fas fa-list mr-2 text-indigo-500"></i>Zimmet Atama İşlemleri
        </h3>
        <div id="zimmet_listesi">
            <div class="text-center py-8 text-slate-500">
                <i class="fas fa-hotel text-4xl mb-3 opacity-50"></i>
                <p>Otel seçiniz...</p>
            </div>
        </div>
    </div>
</div>

<!-- Zimmet Atama Modal -->
<div id="zimmet_modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
        <div class="px-6 py-4 border-b border-slate-700 flex items-center justify-between">
            <h3 class="text-xl font-bold text-white"><i class="fas fa-hotel mr-2"></i><span id="modal_otel_adi">Otel</span> - Zimmet Ekle</h3>
            <button type="button" onclick="modalKapat()" class="text-white text-3xl leading-none">&times;</button>
        </div>
        <div class="flex-1 overflow-y-auto p-6">
            <div id="grup_butonlari" class="flex flex-wrap gap-2 mb-4"></div>
            <div class="mb-4">
                <input type="text" id="urun_ara" placeholder="Ürün ara..." class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white w-64">
            </div>
            <div id="urun_kartlari" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3 p-1">
                <div class="col-span-full text-center py-8 text-slate-400"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">Yükleniyor...</p></div>
            </div>
        </div>
    </div>
</div>

<!-- Miktar Giriş Modal -->
<div id="miktar_modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4" style="background: rgba(0,0,0,0.5);">
    <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-sm" onclick="event.stopPropagation()">
        <div id="miktar_modal_header" class="px-6 py-4 rounded-t-xl">
            <h4 id="miktar_urun_adi" class="text-lg font-bold text-white text-center"></h4>
            <p id="miktar_urun_stok" class="text-sm text-white/80 text-center mt-1"></p>
        </div>
        <div class="p-6">
            <input type="hidden" id="miktar_urun_id">
            <label class="block text-sm font-medium text-slate-300 mb-2 text-center">Miktar Giriniz</label>
            <input type="number" id="miktar_input" min="0" value="0" class="w-full px-4 py-4 text-3xl text-center border-2 border-slate-600 rounded-lg bg-slate-700 text-white font-bold">
            <div class="grid grid-cols-4 gap-2 mt-3">
                <button type="button" class="miktar-btn px-3 py-2 bg-blue-500 text-white rounded-lg font-bold" data-miktar="5">+5</button>
                <button type="button" class="miktar-btn px-3 py-2 bg-blue-500 text-white rounded-lg font-bold" data-miktar="10">+10</button>
                <button type="button" class="miktar-btn px-3 py-2 bg-blue-500 text-white rounded-lg font-bold" data-miktar="20">+20</button>
                <button type="button" class="miktar-btn px-3 py-2 bg-green-500 text-white rounded-lg font-bold" data-miktar="50">+50</button>
                <button type="button" class="miktar-btn px-3 py-2 bg-green-500 text-white rounded-lg font-bold" data-miktar="100">+100</button>
                <button type="button" class="miktar-btn px-3 py-2 bg-purple-500 text-white rounded-lg font-bold" data-miktar="200">+200</button>
                <button type="button" class="miktar-btn px-3 py-2 bg-purple-500 text-white rounded-lg font-bold" data-miktar="500">+500</button>
                <button type="button" class="miktar-sifirla px-3 py-2 bg-slate-400 text-white rounded-lg font-bold">0</button>
            </div>
            <div class="flex gap-3 mt-4">
                <button type="button" onclick="miktarModalKapat()" class="flex-1 py-3 bg-slate-500 text-white rounded-lg font-bold text-lg">İptal</button>
                <button type="button" onclick="miktarOnaylaVeKaydet()" class="flex-1 py-3 bg-green-600 text-white rounded-lg font-bold text-lg">Tamam</button>
            </div>
        </div>
    </div>
</div>

<!-- Bildirim Modal -->
<div id="bildirim_modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4" style="background: rgba(0,0,0,0.6);">
    <div class="bg-slate-800 rounded-xl shadow-2xl w-full max-w-md p-6 text-center">
        <div id="bildirim_icon" class="text-5xl mb-4"></div>
        <h4 id="bildirim_baslik" class="text-xl font-bold text-white mb-2"></h4>
        <p id="bildirim_mesaj" class="text-slate-300 mb-6"></p>
        <button type="button" onclick="bildirimKapat()" class="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg">Tamam</button>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
const csrfToken = '{{ csrf_token() }}';
let urunListesi = [];
let grupListesi = [];
let seciliOtelId = null;
let seciliOtelAdi = '';
let seciliGrup = '';

function bildirimGoster(mesaj, tip = 'info', baslik = null) {
    const icons = { success: '✅', error: '❌', warning: '⚠️', info: 'ℹ️' };
    const titles = { success: 'Başarılı!', error: 'Hata!', warning: 'Dikkat!', info: 'Bilgi' };
    document.getElementById('bildirim_icon').textContent = icons[tip] || icons.info;
    document.getElementById('bildirim_baslik').textContent = baslik || titles[tip] || titles.info;
    document.getElementById('bildirim_mesaj').textContent = mesaj;
    document.getElementById('bildirim_modal').classList.remove('hidden');
}

function bildirimKapat() { document.getElementById('bildirim_modal').classList.add('hidden'); }
function formatSayi(sayi) { return (sayi || 0).toLocaleString('tr-TR'); }

const GRUP_RENK_PALETI = [
  {header: '#dc2626', border: '#fca5a5'}, {header: '#f97316', border: '#fdba74'},
  {header: '#7c3aed', border: '#c4b5fd'}, {header: '#0891b2', border: '#67e8f9'},
  {header: '#16a34a', border: '#86efac'}, {header: '#db2777', border: '#f9a8d4'},
  {header: '#2563eb', border: '#93c5fd'}, {header: '#ca8a04', border: '#fde047'}
];
function getGrupRenk(grupId) { return GRUP_RENK_PALETI[(parseInt(grupId) || 0) % GRUP_RENK_PALETI.length]; }

document.addEventListener('DOMContentLoaded', function() {
    const otelSelect = document.getElementById('otel_select');
    const urunEkleBtn = document.getElementById('urun_ekle_btn');
    
    otelSelect.addEventListener('change', function() {
        if (this.value) {
            seciliOtelId = this.value;
            seciliOtelAdi = this.options[this.selectedIndex].dataset.ad;
            urunEkleBtn.disabled = false;
            zimmetListesiYukle();
        } else {
            seciliOtelId = null;
            urunEkleBtn.disabled = true;
            document.getElementById('zimmet_listesi').innerHTML = '<div class="text-center py-8 text-slate-500"><i class="fas fa-hotel text-4xl mb-3 opacity-50"></i><p>Otel seçiniz...</p></div>';
        }
    });
    
    if (otelSelect.value) {
        seciliOtelId = otelSelect.value;
        seciliOtelAdi = otelSelect.options[otelSelect.selectedIndex].dataset.ad;
        urunEkleBtn.disabled = false;
        zimmetListesiYukle();
    }
    
    document.querySelectorAll('.miktar-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = document.getElementById('miktar_input');
            input.value = parseInt(input.value || 0) + parseInt(this.dataset.miktar);
        });
    });
    document.querySelector('.miktar-sifirla').addEventListener('click', () => document.getElementById('miktar_input').value = 0);
    document.getElementById('urun_ara')?.addEventListener('input', function() {
        const q = this.value.toLowerCase();
        urunleriRenderle(urunListesi.filter(u => u.urun_adi.toLowerCase().includes(q) && (seciliGrup === '' || u.grup_id == seciliGrup)));
    });
});

async function zimmetListesiYukle() {
    const container = document.getElementById('zimmet_listesi');
    container.innerHTML = '<div class="text-center py-8 text-slate-500"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">Yükleniyor...</p></div>';
    
    try {
        const response = await fetch(`/api/otel-zimmet-islemleri?otel_id=${seciliOtelId}`);
        const data = await response.json();
        
        if (data.success && data.islemler.length > 0) {
            container.innerHTML = data.islemler.map(islem => {
                const personelChips = islem.personeller.map(p => `<span class="personel-chip"><i class="fas fa-user mr-1"></i>${p}</span>`).join('');
                const urunRows = islem.urunler.map(u => `
                    <tr class="border-b border-slate-700/50">
                        <td class="px-4 py-3 text-white font-medium">${u.urun_adi}</td>
                        <td class="px-4 py-3 text-center text-green-400 font-bold">+${formatSayi(u.eklenen)}</td>
                        <td class="px-4 py-3 text-center text-slate-400">${formatSayi(u.onceki)}</td>
                        <td class="px-4 py-3 text-center text-blue-400 font-bold">${formatSayi(u.toplam)}</td>
                    </tr>
                `).join('');
                
                return `
                    <div class="zimmet-kart">
                        <div class="zimmet-kart-header">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div>
                                    <h4 class="text-lg font-bold text-white">${islem.otel_adi}</h4>
                                    <div class="flex flex-wrap gap-1 mt-2">${personelChips || '<span class="text-slate-400 text-sm">Tüm Kat Sorumluları</span>'}</div>
                                </div>
                                <div class="text-right">
                                    <span class="px-3 py-1 bg-indigo-500/20 text-indigo-300 rounded-full text-sm font-bold">${islem.urun_cesidi} ürün</span>
                                    <p class="text-slate-400 text-sm mt-1">${islem.tarih}</p>
                                </div>
                            </div>
                        </div>
                        <table class="w-full">
                            <thead>
                                <tr class="bg-slate-900/50 text-slate-400 text-xs uppercase">
                                    <th class="px-4 py-2 text-left">Ürün Adı</th>
                                    <th class="px-4 py-2 text-center">Eklenen</th>
                                    <th class="px-4 py-2 text-center">Önceki</th>
                                    <th class="px-4 py-2 text-center">Toplam</th>
                                </tr>
                            </thead>
                            <tbody>${urunRows}</tbody>
                        </table>
                    </div>
                `;
            }).join('');
        } else {
            container.innerHTML = '<div class="text-center py-8 text-slate-500"><i class="fas fa-inbox text-4xl mb-3 opacity-50"></i><p>Bu otelde henüz zimmet işlemi yok.</p></div>';
        }
    } catch (error) {
        container.innerHTML = '<div class="text-center py-8 text-red-500"><i class="fas fa-exclamation-triangle text-2xl"></i><p class="mt-2">Yükleme hatası!</p></div>';
    }
}

async function modalAc() {
    if (!seciliOtelId) { bildirimGoster('Lütfen önce bir otel seçin!', 'warning'); return; }
    document.getElementById('modal_otel_adi').textContent = seciliOtelAdi;
    document.getElementById('zimmet_modal').classList.remove('hidden');
    await urunleriYukle();
}

function modalKapat() {
    document.getElementById('zimmet_modal').classList.add('hidden');
    zimmetListesiYukle();
}
</script>

<script>
async function urunleriYukle() {
    try {
        const response = await fetch(`/api/urunler-zimmet-icin?otel_id=${seciliOtelId}`);
        const data = await response.json();
        if (data.success) {
            urunListesi = data.urunler;
            const grupMap = {};
            urunListesi.forEach(u => { if (u.grup_id && !grupMap[u.grup_id]) grupMap[u.grup_id] = u.grup_adi; });
            grupListesi = Object.entries(grupMap).map(([id, adi]) => ({id: parseInt(id), adi}));
            grupButonlariniRenderle();
            urunleriRenderle(urunListesi);
        }
    } catch (error) { console.error('Ürün yükleme hatası:', error); }
}

function grupButonlariniRenderle() {
    const container = document.getElementById('grup_butonlari');
    let html = `<button type="button" data-grup="" class="grup-btn aktif" style="background: #374151; color: white;">Tümü</button>`;
    grupListesi.forEach(g => {
        const renk = getGrupRenk(g.id);
        html += `<button type="button" data-grup="${g.id}" class="grup-btn" style="background: ${renk.header}; color: white;">${g.adi}</button>`;
    });
    container.innerHTML = html;
    container.querySelectorAll('.grup-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            container.querySelectorAll('.grup-btn').forEach(b => b.classList.remove('aktif'));
            this.classList.add('aktif');
            seciliGrup = this.dataset.grup;
            urunleriRenderle(seciliGrup === '' ? urunListesi : urunListesi.filter(u => u.grup_id == seciliGrup));
        });
    });
}

function urunleriRenderle(urunler) {
    const container = document.getElementById('urun_kartlari');
    if (urunler.length === 0) { container.innerHTML = '<div class="col-span-full text-center py-8 text-slate-400">Ürün bulunamadı.</div>'; return; }
    container.innerHTML = urunler.map(u => {
        const renk = getGrupRenk(u.grup_id);
        return `
            <div class="urun-card" style="border: 3px solid ${renk.border};" onclick="urunSec(event, ${u.id}, '${u.urun_adi.replace(/'/g, "\\'")}', ${u.ana_depo_stok}, '${renk.header}', '${u.grup_adi || 'Genel'}')">
                <div class="urun-card-header" style="background: ${renk.header}; color: white;">${u.grup_adi || 'GENEL'}</div>
                <div class="urun-card-body">
                    <div class="urun-card-name">${u.urun_adi}</div>
                    <div class="urun-card-footer">
                        <span><span class="label">Ana Depo:</span><span class="value" style="color: ${u.ana_depo_stok > 0 ? '#16a34a' : '#dc2626'};">${formatSayi(u.ana_depo_stok)}</span></span>
                        <span style="text-align: right;"><span class="label">Zimmet:</span><span class="value" style="color: ${u.otel_zimmet_stok > 0 ? '#2563eb' : '#94a3b8'};">${formatSayi(u.otel_zimmet_stok)}</span></span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function urunSec(event, urunId, urunAdi, stok, renk, grupAdi) {
    event.stopPropagation();
    document.getElementById('miktar_urun_id').value = urunId;
    document.getElementById('miktar_urun_adi').textContent = urunAdi;
    document.getElementById('miktar_urun_stok').textContent = `Ana Depo: ${formatSayi(stok)} | ${grupAdi}`;
    document.getElementById('miktar_modal_header').style.background = renk;
    document.getElementById('miktar_input').value = 0;
    document.getElementById('miktar_modal').classList.remove('hidden');
    setTimeout(() => document.getElementById('miktar_input').focus(), 100);
}

function miktarModalKapat() { document.getElementById('miktar_modal').classList.add('hidden'); }

async function miktarOnaylaVeKaydet() {
    const urunId = document.getElementById('miktar_urun_id').value;
    const miktar = parseInt(document.getElementById('miktar_input').value) || 0;
    if (miktar <= 0) { bildirimGoster('Geçerli bir miktar giriniz!', 'warning'); return; }
    
    try {
        const response = await fetch('/api/otel-zimmet-ekle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ otel_id: parseInt(seciliOtelId), urun_id: parseInt(urunId), miktar: miktar })
        });
        const data = await response.json();
        if (data.success) {
            const urun = urunListesi.find(u => u.id == urunId);
            if (urun) urun.otel_zimmet_stok = (urun.otel_zimmet_stok || 0) + miktar;
            urunleriRenderle(seciliGrup === '' ? urunListesi : urunListesi.filter(u => u.grup_id == seciliGrup));
            miktarModalKapat();
            bildirimGoster(`${formatSayi(miktar)} adet ürün otel zimmetine eklendi.`, 'success');
        } else {
            bildirimGoster(data.error || 'Bir hata oluştu!', 'error');
        }
    } catch (error) { bildirimGoster('Bir hata oluştu!', 'error'); }
}
</script>
{% endblock %}
