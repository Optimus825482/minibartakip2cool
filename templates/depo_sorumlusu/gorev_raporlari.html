{% extends "base.html" %} {% block title %}G√∂rev Raporlarƒ± - Minibar Takip
Sistemi{% endblock %} {% block page_title %}G√∂rev Raporlarƒ±{% endblock %} {%
block page_icon_bg %}bg-gradient-to-br from-amber-500 to-orange-600{% endblock
%} {% block page_icon %}fas fa-tasks{% endblock %} {% block content %}
<div class="space-y-6">
  <!-- Manuel Rapor G√∂nderim Kartlarƒ± -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- G√∂rev Tamamlanma Raporu -->
    <div
      class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white"
    >
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold">üìã G√∂rev Tamamlanma Raporu</h3>
          <p class="text-blue-100 text-sm mt-1">
            Kat sorumlusu g√∂rev istatistikleri
          </p>
        </div>
        <i class="fas fa-tasks text-4xl text-blue-200"></i>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-blue-100 text-xs">Rapor Tarihi</label>
          <input
            type="date"
            id="gorevRaporTarihi"
            value="{{ (today - timedelta(days=1)).strftime('%Y-%m-%d') if today else '' }}"
            class="w-full mt-1 px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-blue-200 text-sm focus:outline-none focus:ring-2 focus:ring-white/50"
          />
        </div>
        <button
          onclick="gonderGorevRaporu()"
          class="w-full px-4 py-2.5 bg-white text-blue-600 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all duration-200"
        >
          <i class="fas fa-paper-plane"></i>
          <span>Raporu Email ile G√∂nder</span>
        </button>
      </div>
    </div>

    <!-- Minibar Sarfiyat Raporu -->
    <div
      class="bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl shadow-lg p-6 text-white"
    >
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-semibold">üç´ Minibar Sarfiyat Raporu</h3>
          <p class="text-amber-100 text-sm mt-1">
            Oda bazlƒ± √ºr√ºn t√ºketimi ve stok
          </p>
        </div>
        <i class="fas fa-wine-bottle text-4xl text-amber-200"></i>
      </div>
      <div class="space-y-3">
        <div>
          <label class="text-amber-100 text-xs">Rapor Tarihi</label>
          <input
            type="date"
            id="minibarRaporTarihi"
            value="{{ (today - timedelta(days=1)).strftime('%Y-%m-%d') if today else '' }}"
            class="w-full mt-1 px-3 py-2 bg-white/20 border border-white/30 rounded-lg text-white placeholder-amber-200 text-sm focus:outline-none focus:ring-2 focus:ring-white/50"
          />
        </div>
        <button
          onclick="gonderMinibarRaporu()"
          class="w-full px-4 py-2.5 bg-white text-amber-600 rounded-lg font-medium text-sm flex items-center justify-center gap-2 transition-all duration-200"
        >
          <i class="fas fa-paper-plane"></i>
          <span>Raporu Email ile G√∂nder</span>
        </button>
      </div>
    </div>
  </div>

  <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-medium text-slate-900 dark:text-white">
        <i class="fas fa-chart-bar mr-2 text-blue-600"></i>G√∂rev Raporlarƒ±
      </h3>
      <form method="GET" class="flex items-center gap-2">
        <input
          type="date"
          name="baslangic"
          value="{{ baslangic.isoformat() }}"
          class="rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white text-sm"
        />
        <span class="text-slate-500">-</span>
        <input
          type="date"
          name="bitis"
          value="{{ bitis.isoformat() }}"
          class="rounded-lg border-slate-300 dark:border-slate-600 dark:bg-slate-700 dark:text-white text-sm"
        />
        <button
          type="submit"
          class="px-4 py-2 bg-slate-600 text-white rounded-lg text-sm"
        >
          <i class="fas fa-filter mr-1"></i>Filtrele
        </button>
      </form>
    </div>

    {% if raporlar %}
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="bg-slate-100 dark:bg-slate-900">
          <tr>
            <th class="px-4 py-3 text-left text-slate-700 dark:text-slate-300">
              Tarih
            </th>
            <th
              class="px-4 py-3 text-center text-slate-700 dark:text-slate-300"
            >
              Toplam
            </th>
            <th
              class="px-4 py-3 text-center text-slate-700 dark:text-slate-300"
            >
              Tamamlanan
            </th>
            <th
              class="px-4 py-3 text-center text-slate-700 dark:text-slate-300"
            >
              Bekleyen
            </th>
            <th
              class="px-4 py-3 text-center text-slate-700 dark:text-slate-300"
            >
              DND
            </th>
            <th
              class="px-4 py-3 text-center text-slate-700 dark:text-slate-300"
            >
              Oran
            </th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
          {% for rapor in raporlar %}
          <tr class="hover:bg-slate-50 dark:hover:bg-slate-900/50">
            <td class="px-4 py-3 text-slate-900 dark:text-white font-medium">
              {{ rapor.tarih }}
            </td>
            <td
              class="px-4 py-3 text-center text-slate-600 dark:text-slate-400"
            >
              {{ rapor.toplam }}
            </td>
            <td
              class="px-4 py-3 text-center text-green-600 dark:text-green-400"
            >
              {{ rapor.tamamlanan }}
            </td>
            <td
              class="px-4 py-3 text-center text-yellow-600 dark:text-yellow-400"
            >
              {{ rapor.bekleyen }}
            </td>
            <td
              class="px-4 py-3 text-center text-orange-600 dark:text-orange-400"
            >
              {{ rapor.dnd }}
            </td>
            <td class="px-4 py-3 text-center">
              <span
                class="px-2 py-1 rounded text-xs font-medium {% if rapor.tamamlanma_orani >= 80 %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400{% elif rapor.tamamlanma_orani >= 50 %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400{% else %}bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400{% endif %}"
              >
                %{{ rapor.tamamlanma_orani }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div class="text-center py-12 text-slate-500 dark:text-slate-400">
      <i class="fas fa-chart-bar text-5xl mb-3"></i>
      <p>Se√ßilen tarih aralƒ±ƒüƒ±nda rapor bulunamadƒ±.</p>
    </div>
    {% endif %}
  </div>
</div>

<!-- Rapor G√∂nderim Sonu√ß Modal -->
<div
  id="raporSonucModal"
  class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50"
>
  <div
    class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden"
  >
    <div id="raporSonucHeader" class="px-6 py-4">
      <h3 id="raporSonucBaslik" class="text-lg font-semibold"></h3>
    </div>
    <div class="px-6 py-4">
      <p id="raporSonucMesaj" class="text-slate-600 dark:text-slate-300"></p>
      <div id="raporSonucDetay" class="mt-4 max-h-48 overflow-y-auto"></div>
    </div>
    <div class="px-6 py-4 bg-slate-50 dark:bg-slate-900 flex justify-end">
      <button
        onclick="kapatRaporModal()"
        class="px-4 py-2 bg-slate-600 text-white rounded-lg text-sm"
      >
        Kapat
      </button>
    </div>
  </div>
</div>

<script>
  // CSRF Token
  const csrfToken =
    document
      .querySelector('meta[name="csrf-token"]')
      ?.getAttribute("content") || "";

  // G√∂rev Tamamlanma Raporu G√∂nder
  async function gonderGorevRaporu() {
    const tarih = document.getElementById("gorevRaporTarihi").value;
    const btn = event.target.closest("button");
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√∂nderiliyor...';

    try {
      const response = await fetch("/api/rapor/gorev-tamamlanma-gonder", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ tarih: tarih }),
      });

      const data = await response.json();
      gosterRaporSonuc(data, "G√∂rev Tamamlanma Raporu");
    } catch (error) {
      gosterRaporSonuc(
        { success: false, message: "Baƒülantƒ± hatasƒ±: " + error.message },
        "G√∂rev Tamamlanma Raporu"
      );
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  // Minibar Sarfiyat Raporu G√∂nder
  async function gonderMinibarRaporu() {
    const tarih = document.getElementById("minibarRaporTarihi").value;
    const btn = event.target.closest("button");
    const originalText = btn.innerHTML;

    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> G√∂nderiliyor...';

    try {
      const response = await fetch("/api/rapor/minibar-sarfiyat-gonder", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ tarih: tarih }),
      });

      const data = await response.json();
      gosterRaporSonuc(data, "Minibar Sarfiyat Raporu");
    } catch (error) {
      gosterRaporSonuc(
        { success: false, message: "Baƒülantƒ± hatasƒ±: " + error.message },
        "Minibar Sarfiyat Raporu"
      );
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  }

  // Sonu√ß Modal G√∂ster
  function gosterRaporSonuc(data, baslik) {
    const modal = document.getElementById("raporSonucModal");
    const header = document.getElementById("raporSonucHeader");
    const baslikEl = document.getElementById("raporSonucBaslik");
    const mesajEl = document.getElementById("raporSonucMesaj");
    const detayEl = document.getElementById("raporSonucDetay");

    if (data.success) {
      header.className = "px-6 py-4 bg-green-500 text-white";
      baslikEl.innerHTML =
        '<i class="fas fa-check-circle mr-2"></i>' + baslik + " - Ba≈üarƒ±lƒ±";
    } else {
      header.className = "px-6 py-4 bg-red-500 text-white";
      baslikEl.innerHTML =
        '<i class="fas fa-times-circle mr-2"></i>' + baslik + " - Hata";
    }

    mesajEl.textContent = data.message;

    // Detaylarƒ± g√∂ster
    if (data.sonuclar && data.sonuclar.length > 0) {
      let detayHtml = '<div class="space-y-2">';
      data.sonuclar.forEach((s) => {
        const icon =
          s.durum === "ba≈üarƒ±lƒ±"
            ? '<i class="fas fa-check text-green-500"></i>'
            : '<i class="fas fa-times text-red-500"></i>';
        detayHtml += `<div class="flex items-center gap-2 text-sm">
                ${icon}
                <span class="text-slate-700 dark:text-slate-300">${s.ad}</span>
                <span class="text-slate-500 text-xs">(${s.durum})</span>
            </div>`;
      });
      detayHtml += "</div>";
      detayEl.innerHTML = detayHtml;
    } else {
      detayEl.innerHTML = "";
    }

    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }

  // Modal Kapat
  function kapatRaporModal() {
    const modal = document.getElementById("raporSonucModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
  }

  // ESC ile modal kapat
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape") {
      kapatRaporModal();
    }
  });
</script>
{% endblock %}
