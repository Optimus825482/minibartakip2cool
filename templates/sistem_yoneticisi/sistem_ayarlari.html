{% extends "base.html" %} {% block title %}Sistem Ayarları - Minibar Takip
Sistemi{% endblock %} {% block page_title %}Sistem Ayarları{% endblock %} {%
block content %}
<div class="space-y-6">
  <!-- Tab Navigation -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
    <div class="border-b border-slate-200 dark:border-slate-700">
      <nav class="flex -mb-px">
        <a
          href="{{ url_for('sistem_ayarlari') }}"
          class="px-6 py-4 text-sm font-medium border-b-2 transition-colors {% if active_tab == 'genel' %}border-blue-500 text-blue-600 dark:text-blue-400{% else %}border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}"
        >
          <i class="fas fa-cog mr-2"></i>Genel
        </a>
        <a
          href="{{ url_for('sistem_ayarlari_email') }}"
          class="px-6 py-4 text-sm font-medium border-b-2 transition-colors {% if active_tab == 'email' %}border-blue-500 text-blue-600 dark:text-blue-400{% else %}border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}"
        >
          <i class="fas fa-envelope mr-2"></i>Email Ayarları
        </a>
        <a
          href="{{ url_for('email_loglari') }}"
          class="px-6 py-4 text-sm font-medium border-b-2 transition-colors {% if active_tab == 'email_logs' %}border-blue-500 text-blue-600 dark:text-blue-400{% else %}border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}"
        >
          <i class="fas fa-history mr-2"></i>Email Logları
        </a>
        <a
          href="{{ url_for('sistem_ayarlari_yedekleme') }}"
          class="px-6 py-4 text-sm font-medium border-b-2 transition-colors {% if active_tab == 'yedekleme' %}border-blue-500 text-blue-600 dark:text-blue-400{% else %}border-transparent text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-300{% endif %}"
        >
          <i class="fas fa-database mr-2"></i>Yedekleme
        </a>
      </nav>
    </div>
  </div>

  {% if active_tab == 'genel' %}
  <!-- Genel Ayarlar -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
    <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">
      <i class="fas fa-info-circle mr-2 text-blue-500"></i>Sistem Bilgileri
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">
        <div class="text-sm text-slate-500 dark:text-slate-400">Versiyon</div>
        <div class="text-lg font-semibold text-slate-900 dark:text-white">
          {{ config.CACHE_VERSION }}
        </div>
      </div>
      <div class="p-4 bg-slate-50 dark:bg-slate-700 rounded-lg">
        <div class="text-sm text-slate-500 dark:text-slate-400">Ortam</div>
        <div class="text-lg font-semibold text-slate-900 dark:text-white">
          {{ config.ENV }}
        </div>
      </div>
    </div>
  </div>

  {% elif active_tab == 'email' %}
  <!-- Email Ayarları -->
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-6">
      <h3 class="text-lg font-medium text-slate-900 dark:text-white">
        <i class="fas fa-envelope mr-2 text-blue-500"></i>SMTP Email Ayarları
      </h3>
      <button
        type="button"
        onclick="testEmailConnection()"
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors text-sm"
      >
        <i class="fas fa-plug mr-2"></i>Bağlantıyı Test Et
      </button>
    </div>

    <form
      method="POST"
      action="{{ url_for('sistem_ayarlari_email') }}"
      class="space-y-6"
    >
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- SMTP Sunucu -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            SMTP Sunucu <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="smtp_server"
            required
            value="{{ email_ayarlari.smtp_server if email_ayarlari else '' }}"
            placeholder="smtp.gmail.com"
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- SMTP Port -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            SMTP Port <span class="text-red-500">*</span>
          </label>
          <input
            type="number"
            name="smtp_port"
            required
            value="{{ email_ayarlari.smtp_port if email_ayarlari else 587 }}"
            placeholder="587"
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- Kullanıcı Adı -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            Kullanıcı Adı <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="smtp_username"
            required
            value="{{ email_ayarlari.smtp_username if email_ayarlari else '' }}"
            placeholder="email@example.com"
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- Şifre -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            Şifre {% if not email_ayarlari %}<span class="text-red-500">*</span
            >{% endif %}
          </label>
          <input
            type="password"
            name="smtp_password"
            {%
            if
            not
            email_ayarlari
            %}required{%
            endif
            %}
            placeholder="{% if email_ayarlari %}••••••••{% else %}Şifre giriniz{% endif %}"
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500"
          />
          {% if email_ayarlari %}
          <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
            Değiştirmek istemiyorsanız boş bırakın
          </p>
          {% endif %}
        </div>

        <!-- Gönderen Email -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            Gönderen Email <span class="text-red-500">*</span>
          </label>
          <input
            type="email"
            name="sender_email"
            required
            value="{{ email_ayarlari.sender_email if email_ayarlari else '' }}"
            placeholder="noreply@example.com"
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <!-- Gönderen Adı -->
        <div>
          <label
            class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
          >
            Gönderen Adı
          </label>
          <input
            type="text"
            name="sender_name"
            value="{{ email_ayarlari.sender_name if email_ayarlari else 'Minibar Takip Sistemi' }}"
            placeholder="Minibar Takip Sistemi"
            class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500"
          />
        </div>
      </div>

      <!-- TLS/SSL Seçenekleri -->
      <div class="flex items-center space-x-6">
        <label class="flex items-center">
          <input
            type="checkbox"
            name="smtp_use_tls"
            {%
            if
            email_ayarlari
            and
            email_ayarlari.smtp_use_tls
            %}checked{%
            elif
            not
            email_ayarlari
            %}checked{%
            endif
            %}
            class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
          />
          <span class="ml-2 text-sm text-slate-700 dark:text-slate-300"
            >TLS Kullan (Port 587)</span
          >
        </label>
        <label class="flex items-center">
          <input
            type="checkbox"
            name="smtp_use_ssl"
            {%
            if
            email_ayarlari
            and
            email_ayarlari.smtp_use_ssl
            %}checked{%
            endif
            %}
            class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
          />
          <span class="ml-2 text-sm text-slate-700 dark:text-slate-300"
            >SSL Kullan (Port 465)</span
          >
        </label>
      </div>

      <!-- Kaydet Butonu -->
      <div
        class="flex justify-end pt-4 border-t border-slate-200 dark:border-slate-700"
      >
        <button
          type="submit"
          class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
        >
          <i class="fas fa-save mr-2"></i>Kaydet
        </button>
      </div>
    </form>

    <!-- Bilgi Kutusu -->
    <div
      class="mt-6 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800"
    >
      <h4 class="text-sm font-medium text-blue-800 dark:text-blue-300 mb-2">
        <i class="fas fa-info-circle mr-2"></i>Gmail Kullanıcıları İçin
      </h4>
      <ul class="text-sm text-blue-700 dark:text-blue-400 space-y-1">
        <li>• SMTP Sunucu: smtp.gmail.com</li>
        <li>• Port: 587 (TLS) veya 465 (SSL)</li>
        <li>• "Uygulama Şifresi" oluşturmanız gerekebilir</li>
        <li>
          • Google Hesabı → Güvenlik → 2 Adımlı Doğrulama → Uygulama Şifreleri
        </li>
      </ul>
    </div>
  </div>
  {% elif active_tab == 'yedekleme' %}
  <!-- Yedekleme Ayarları -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Sol Panel - Ayarlar -->
    <div class="lg:col-span-1 space-y-6">
      <!-- İstatistikler -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">
          <i class="fas fa-chart-bar mr-2 text-blue-500"></i>İstatistikler
        </h3>
        <div class="space-y-4">
          <div class="flex justify-between items-center">
            <span class="text-slate-600 dark:text-slate-400">Toplam Yedek</span>
            <span class="font-semibold text-slate-900 dark:text-white"
              >{{ backup_istatistikler.total_backups }}</span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-600 dark:text-slate-400">Toplam Boyut</span>
            <span class="font-semibold text-slate-900 dark:text-white"
              >{{ backup_istatistikler.total_size_mb }} MB</span
            >
          </div>
          <div class="flex justify-between items-center">
            <span class="text-slate-600 dark:text-slate-400">Son Yedek</span>
            <span class="font-semibold text-slate-900 dark:text-white">
              {% if backup_istatistikler.last_backup %} {{
              backup_istatistikler.last_backup.strftime('%d.%m.%Y %H:%M') }} {%
              else %} - {% endif %}
            </span>
          </div>
        </div>
      </div>

      <!-- Ayarlar Formu -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">
          <i class="fas fa-cog mr-2 text-green-500"></i>Otomatik Yedekleme
        </h3>
        <form
          method="POST"
          action="{{ url_for('sistem_ayarlari_yedekleme') }}"
          class="space-y-4"
        >
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

          <label class="flex items-center">
            <input
              type="checkbox"
              name="otomatik_yedekleme"
              {%
              if
              backup_ayarlari.otomatik_yedekleme
              %}checked{%
              endif
              %}
              class="w-4 h-4 text-blue-600 border-slate-300 rounded focus:ring-blue-500"
            />
            <span class="ml-2 text-sm text-slate-700 dark:text-slate-300"
              >Otomatik yedekleme aktif</span
            >
          </label>

          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Yedekleme Saati
            </label>
            <input
              type="time"
              name="yedekleme_saati"
              value="{{ backup_ayarlari.yedekleme_saati }}"
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
            />
          </div>

          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Saklama Süresi (Gün)
            </label>
            <input
              type="number"
              name="saklama_suresi"
              min="1"
              max="365"
              value="{{ backup_ayarlari.saklama_suresi }}"
              class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg bg-white dark:bg-slate-700 text-slate-900 dark:text-white"
            />
            <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">
              {{ backup_ayarlari.saklama_suresi }} günden eski yedekler otomatik
              silinir
            </p>
          </div>

          <button
            type="submit"
            class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg transition-colors"
          >
            <i class="fas fa-save mr-2"></i>Ayarları Kaydet
          </button>
        </form>
      </div>

      <!-- Hızlı İşlemler -->
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
        <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-4">
          <i class="fas fa-bolt mr-2 text-yellow-500"></i>Hızlı İşlemler
        </h3>
        <div class="space-y-3">
          <form method="POST" action="{{ url_for('yedek_olustur') }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <button
              type="submit"
              class="w-full px-4 py-2 bg-green-600 text-white rounded-lg transition-colors"
            >
              <i class="fas fa-plus mr-2"></i>Manuel Yedek Al
            </button>
          </form>
          <button
            onclick="temizleEskiYedekler()"
            class="w-full px-4 py-2 bg-orange-600 text-white rounded-lg transition-colors"
          >
            <i class="fas fa-broom mr-2"></i>Eski Yedekleri Temizle
          </button>
        </div>
      </div>
    </div>

    <!-- Sağ Panel - Yedek Listesi -->
    <div class="lg:col-span-2">
      <div class="bg-white dark:bg-slate-800 rounded-lg shadow">
        <div class="p-6 border-b border-slate-200 dark:border-slate-700">
          <h3 class="text-lg font-medium text-slate-900 dark:text-white">
            <i class="fas fa-list mr-2 text-purple-500"></i>Yedek Listesi
          </h3>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-50 dark:bg-slate-700">
              <tr>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
                >
                  Tarih
                </th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
                >
                  Dosya
                </th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
                >
                  Boyut
                </th>
                <th
                  class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
                >
                  Oluşturan
                </th>
                <th
                  class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
                >
                  İşlemler
                </th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
              {% for yedek in yedekler %}
              <tr
                class="{% if not yedek.file_exists %}bg-red-50 dark:bg-red-900/20{% endif %}"
              >
                <td class="px-4 py-3 text-sm text-slate-900 dark:text-white">
                  {{ yedek.created_at.strftime('%d.%m.%Y %H:%M') }}
                </td>
                <td class="px-4 py-3 text-sm">
                  <div class="flex items-center">
                    {% if yedek.file_exists %}
                    <i class="fas fa-file-archive text-green-500 mr-2"></i>
                    {% else %}
                    <i
                      class="fas fa-exclamation-triangle text-red-500 mr-2"
                    ></i>
                    {% endif %}
                    <span
                      class="text-slate-600 dark:text-slate-400 truncate max-w-xs"
                      title="{{ yedek.filename }}"
                    >
                      {{ yedek.filename[:30] }}...
                    </span>
                  </div>
                </td>
                <td
                  class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400"
                >
                  {{ yedek.file_size_mb }} MB
                </td>
                <td
                  class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400"
                >
                  {{ yedek.created_by }}
                </td>
                <td class="px-4 py-3 text-center">
                  <div class="flex items-center justify-center space-x-2">
                    {% if yedek.file_exists %}
                    <a
                      href="{{ url_for('yedek_indir', backup_id=yedek.backup_id) }}"
                      class="p-2 text-blue-600 rounded transition-colors"
                      title="İndir"
                    >
                      <i class="fas fa-download"></i>
                    </a>
                    <button
                      onclick="geriYukle('{{ yedek.backup_id }}')"
                      class="p-2 text-green-600 rounded transition-colors"
                      title="Geri Yükle"
                    >
                      <i class="fas fa-undo"></i>
                    </button>
                    {% endif %}
                    <button
                      onclick="yedekSil('{{ yedek.backup_id }}')"
                      class="p-2 text-red-600 rounded transition-colors"
                      title="Sil"
                    >
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td
                  colspan="5"
                  class="px-4 py-8 text-center text-slate-500 dark:text-slate-400"
                >
                  <i class="fas fa-database text-4xl mb-2 opacity-50"></i>
                  <p>Henüz yedek bulunmuyor</p>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<script>
  function testEmailConnection() {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML =
      '<i class="fas fa-spinner fa-spin mr-2"></i>Test Ediliyor...';
    btn.disabled = true;

    fetch('{{ url_for("sistem_ayarlari_email_test") }}', {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("✅ " + data.message);
        } else {
          alert("❌ " + data.message);
        }
      })
      .catch((error) => {
        alert("❌ Bağlantı hatası: " + error);
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
  }

  // Yedekleme İşlemleri
  function yedekSil(backupId) {
    if (!confirm("Bu yedeği silmek istediğinizden emin misiniz?")) return;

    fetch(`/sistem-ayarlari/yedekleme/sil/${backupId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("✅ " + data.message);
          location.reload();
        } else {
          alert("❌ " + data.message);
        }
      })
      .catch((error) => alert("❌ Hata: " + error));
  }

  function geriYukle(backupId) {
    if (
      !confirm(
        "⚠️ DİKKAT!\n\nBu işlem mevcut veritabanını yedekle değiştirecektir.\nDevam etmek istediğinizden emin misiniz?"
      )
    )
      return;
    if (!confirm("Son kez onaylayın: Veritabanı geri yüklenecek!")) return;

    const btn = event.target;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    fetch(`/sistem-ayarlari/yedekleme/geri-yukle/${backupId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("✅ " + data.message);
          location.reload();
        } else {
          alert("❌ " + data.message);
        }
      })
      .catch((error) => alert("❌ Hata: " + error))
      .finally(() => {
        btn.innerHTML = '<i class="fas fa-undo"></i>';
        btn.disabled = false;
      });
  }

  function temizleEskiYedekler() {
    if (!confirm("Saklama süresini geçmiş eski yedekler silinecek. Devam?"))
      return;

    fetch("/sistem-ayarlari/yedekleme/temizle", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token() }}",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("✅ " + data.message);
          location.reload();
        } else {
          alert("❌ " + data.message);
        }
      })
      .catch((error) => alert("❌ Hata: " + error));
  }
</script>
{% endblock %}
