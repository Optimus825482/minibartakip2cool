{% extends "base.html" %}

{% block title %}Fiyat Karşılaştırma - {{ urun.urun_adi }}{% endblock %}
{% block page_title %}Fiyat Karşılaştırma{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Başlık ve Geri Butonu -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white">{{ urun.urun_adi }}</h2>
            <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">Tedarikçi Fiyat Karşılaştırması</p>
        </div>
        <a href="{{ url_for('urun_tedarikci_fiyat') }}" 
           class="inline-flex items-center px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>Geri
        </a>
    </div>

    <!-- Ürün Bilgileri -->
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <p class="text-sm opacity-90">Ürün Grubu</p>
                <p class="text-lg font-semibold mt-1">{{ urun.urun_grubu.grup_adi if urun.urun_grubu else '-' }}</p>
            </div>
            <div>
                <p class="text-sm opacity-90">Satış Fiyatı</p>
                <p class="text-lg font-semibold mt-1">{{ "%.2f"|format(urun.satis_fiyati) if urun.satis_fiyati else '-' }} ₺</p>
            </div>
            <div>
                <p class="text-sm opacity-90">Mevcut Stok</p>
                <p class="text-lg font-semibold mt-1">{{ toplam_stok }} adet</p>
            </div>
            <div>
                <p class="text-sm opacity-90">Tedarikçi Sayısı</p>
                <p class="text-lg font-semibold mt-1">{{ fiyatlar|length }} tedarikçi</p>
            </div>
        </div>
    </div>

    <!-- En İyi Fiyat Vurgulama -->
    {% if en_iyi_fiyat %}
    <div class="bg-green-50 dark:bg-green-900/20 border-2 border-green-500 dark:border-green-600 rounded-lg p-6">
        <div class="flex items-center gap-4">
            <div class="flex-shrink-0 w-16 h-16 bg-green-500 rounded-full flex items-center justify-center">
                <i class="fas fa-trophy text-white text-2xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="text-lg font-bold text-green-900 dark:text-green-100">En Uygun Fiyat</h3>
                <p class="text-sm text-green-700 dark:text-green-300 mt-1">
                    <span class="font-semibold">{{ en_iyi_fiyat.tedarikci.tedarikci_adi }}</span> - 
                    <span class="text-2xl font-bold">{{ "%.2f"|format(en_iyi_fiyat.alis_fiyati) }} ₺</span>
                    {% if urun.satis_fiyati %}
                    <span class="ml-2 text-sm">(Kar Marjı: {{ "%.1f"|format(((urun.satis_fiyati - en_iyi_fiyat.alis_fiyati) / en_iyi_fiyat.alis_fiyati * 100) if en_iyi_fiyat.alis_fiyati > 0 else 0) }}%)</span>
                    {% endif %}
                </p>
                <p class="text-xs text-green-600 dark:text-green-400 mt-1">
                    Min. Sipariş: {{ en_iyi_fiyat.minimum_miktar }} adet
                </p>
            </div>
            {% if en_iyi_fiyat.tedarikci.performans_skoru %}
            <div class="text-center">
                <p class="text-xs text-green-700 dark:text-green-300">Performans</p>
                <p class="text-2xl font-bold text-green-900 dark:text-green-100">{{ "%.0f"|format(en_iyi_fiyat.tedarikci.performans_skoru) }}</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Fiyat Karşılaştırma Tablosu -->
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700">
        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-white">
                <i class="fas fa-balance-scale mr-2 text-blue-600 dark:text-blue-400"></i>
                Tedarikçi Fiyat Karşılaştırması
            </h3>
        </div>
        
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Tedarikçi</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Alış Fiyatı</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Kar Marjı</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Min. Miktar</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Performans</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Geçerlilik</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">Durum</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-slate-700 dark:text-slate-300 uppercase">İşlem</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200 dark:divide-slate-700">
                    {% if fiyatlar %}
                        {% for fiyat in fiyatlar %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors
                            {% if en_iyi_fiyat and fiyat.id == en_iyi_fiyat.id %}bg-green-50 dark:bg-green-900/10{% endif %}">
                            <td class="px-6 py-4">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 bg-blue-100 dark:bg-blue-900/30 rounded-full flex items-center justify-center">
                                        <i class="fas fa-truck text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div class="ml-4">
                                        <div class="text-sm font-medium text-slate-900 dark:text-white">
                                            {{ fiyat.tedarikci.tedarikci_adi }}
                                            {% if en_iyi_fiyat and fiyat.id == en_iyi_fiyat.id %}
                                            <i class="fas fa-crown text-yellow-500 ml-2" title="En İyi Fiyat"></i>
                                            {% endif %}
                                        </div>
                                        <div class="text-xs text-slate-500 dark:text-slate-400">
                                            {{ fiyat.tedarikci.telefon or '-' }}
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="text-lg font-bold text-slate-900 dark:text-white">
                                    {{ "%.2f"|format(fiyat.alis_fiyati) }} ₺
                                </div>
                                {% if en_iyi_fiyat and fiyat.id != en_iyi_fiyat.id %}
                                <div class="text-xs text-red-600 dark:text-red-400">
                                    +{{ "%.2f"|format(fiyat.alis_fiyati - en_iyi_fiyat.alis_fiyati) }} ₺
                                </div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right">
                                {% if urun.satis_fiyati %}
                                    {% set kar_marji = ((urun.satis_fiyati - fiyat.alis_fiyati) / fiyat.alis_fiyati * 100) if fiyat.alis_fiyati > 0 else 0 %}
                                    <div class="text-sm font-semibold 
                                        {% if kar_marji >= 30 %}text-green-600 dark:text-green-400
                                        {% elif kar_marji >= 15 %}text-yellow-600 dark:text-yellow-400
                                        {% else %}text-red-600 dark:text-red-400{% endif %}">
                                        {{ "%.1f"|format(kar_marji) }}%
                                    </div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">
                                        {{ "%.2f"|format(urun.satis_fiyati - fiyat.alis_fiyati) }} ₺
                                    </div>
                                {% else %}
                                <span class="text-sm text-slate-500 dark:text-slate-400">-</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-right text-sm text-slate-900 dark:text-white">
                                {{ fiyat.minimum_miktar }} adet
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if fiyat.tedarikci.performans_skoru %}
                                <div class="flex flex-col items-center">
                                    <div class="text-lg font-bold 
                                        {% if fiyat.tedarikci.performans_skoru >= 80 %}text-green-600 dark:text-green-400
                                        {% elif fiyat.tedarikci.performans_skoru >= 60 %}text-yellow-600 dark:text-yellow-400
                                        {% else %}text-red-600 dark:text-red-400{% endif %}">
                                        {{ "%.0f"|format(fiyat.tedarikci.performans_skoru) }}
                                    </div>
                                    <div class="w-16 bg-slate-200 dark:bg-slate-700 rounded-full h-1.5 mt-1">
                                        <div class="h-1.5 rounded-full 
                                            {% if fiyat.tedarikci.performans_skoru >= 80 %}bg-green-500
                                            {% elif fiyat.tedarikci.performans_skoru >= 60 %}bg-yellow-500
                                            {% else %}bg-red-500{% endif %}"
                                            style="width: {{ fiyat.tedarikci.performans_skoru }}%">
                                        </div>
                                    </div>
                                </div>
                                {% else %}
                                <span class="text-sm text-slate-500 dark:text-slate-400">Veri yok</span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center text-sm text-slate-600 dark:text-slate-400">
                                <div>{{ fiyat.baslangic_tarihi.strftime('%d.%m.%Y') }}</div>
                                {% if fiyat.bitis_tarihi %}
                                <div class="text-xs">{{ fiyat.bitis_tarihi.strftime('%d.%m.%Y') }}</div>
                                {% else %}
                                <div class="text-xs text-green-600 dark:text-green-400">Süresiz</div>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                {% if fiyat.aktif %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                                    Aktif
                                </span>
                                {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 text-slate-800 dark:bg-slate-700 dark:text-slate-400">
                                    Pasif
                                </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-4 text-center">
                                <a href="{{ url_for('tedarikci_performans', tedarikci_id=fiyat.tedarikci_id) }}" 
                                   class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300"
                                   title="Performans Detayı">
                                    <i class="fas fa-chart-line"></i>
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="8" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-slate-300 dark:text-slate-600 text-5xl mb-4"></i>
                                <p class="text-slate-500 dark:text-slate-400 text-lg">Bu ürün için fiyat tanımı bulunamadı</p>
                                <a href="{{ url_for('urun_tedarikci_fiyat') }}?urun_id={{ urun.id }}" 
                                   class="mt-4 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                                    Fiyat Tanımla
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Fiyat Trend Grafiği -->
    {% if fiyat_gecmisi %}
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6">
        <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">
            <i class="fas fa-chart-line mr-2 text-purple-600 dark:text-purple-400"></i>
            Fiyat Trend Analizi (Son 12 Ay)
        </h3>
        <canvas id="fiyatTrendGrafik" height="80"></canvas>
    </div>
    {% endif %}

    <!-- İstatistikler -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="text-center">
                <p class="text-sm text-slate-600 dark:text-slate-400">En Düşük Fiyat</p>
                <p class="text-2xl font-bold text-green-600 dark:text-green-400 mt-2">
                    {{ "%.2f"|format(en_dusuk_fiyat) if en_dusuk_fiyat else '-' }} ₺
                </p>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="text-center">
                <p class="text-sm text-slate-600 dark:text-slate-400">En Yüksek Fiyat</p>
                <p class="text-2xl font-bold text-red-600 dark:text-red-400 mt-2">
                    {{ "%.2f"|format(en_yuksek_fiyat) if en_yuksek_fiyat else '-' }} ₺
                </p>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="text-center">
                <p class="text-sm text-slate-600 dark:text-slate-400">Ortalama Fiyat</p>
                <p class="text-2xl font-bold text-blue-600 dark:text-blue-400 mt-2">
                    {{ "%.2f"|format(ortalama_fiyat) if ortalama_fiyat else '-' }} ₺
                </p>
            </div>
        </div>

        <div class="bg-white dark:bg-slate-800 rounded-lg shadow-sm border border-slate-200 dark:border-slate-700 p-6">
            <div class="text-center">
                <p class="text-sm text-slate-600 dark:text-slate-400">Fiyat Farkı</p>
                <p class="text-2xl font-bold text-purple-600 dark:text-purple-400 mt-2">
                    {{ "%.2f"|format(en_yuksek_fiyat - en_dusuk_fiyat) if (en_yuksek_fiyat and en_dusuk_fiyat) else '-' }} ₺
                </p>
            </div>
        </div>
    </div>
</div>

{% if fiyat_gecmisi %}
<script>
// Fiyat Trend Grafiği
const ctx = document.getElementById('fiyatTrendGrafik').getContext('2d');

// Tedarikçilere göre veri setleri oluştur
const datasets = [];
const tedarikciRenkler = [
    { bg: 'rgba(59, 130, 246, 0.2)', border: 'rgb(59, 130, 246)' },
    { bg: 'rgba(16, 185, 129, 0.2)', border: 'rgb(16, 185, 129)' },
    { bg: 'rgba(245, 158, 11, 0.2)', border: 'rgb(245, 158, 11)' },
    { bg: 'rgba(239, 68, 68, 0.2)', border: 'rgb(239, 68, 68)' },
    { bg: 'rgba(139, 92, 246, 0.2)', border: 'rgb(139, 92, 246)' }
];

{% for tedarikci_adi, veriler in fiyat_gecmisi.items() %}
    {% set loop_index = loop.index0 % 5 %}
    datasets.push({
        label: '{{ tedarikci_adi }}',
        data: {{ veriler|tojson }},
        backgroundColor: tedarikciRenkler[{{ loop_index }}].bg,
        borderColor: tedarikciRenkler[{{ loop_index }}].border,
        borderWidth: 2,
        tension: 0.4,
        fill: true
    });
{% endfor %}

new Chart(ctx, {
    type: 'line',
    data: {
        labels: {{ aylar|tojson }},
        datasets: datasets
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + ' ₺';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: false,
                ticks: {
                    callback: function(value) {
                        return value.toFixed(2) + ' ₺';
                    }
                }
            }
        }
    }
});
</script>
{% endif %}
{% endblock %}
