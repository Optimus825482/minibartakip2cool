{% extends "base.html" %} {% from "_form_helpers.html" import flash_messages %}
{% block title %}Setup Yönetimi - Minibar Takip Sistemi{% endblock %} {% block
page_title %}Setup Yönetimi{% endblock %} {% block content %}
<div class="space-y-6">
  {{ flash_messages() }}

  <!-- Başlık ve Yeni Ekle Butonu -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex items-center justify-between">
        <h3
          class="text-lg leading-6 font-medium text-slate-900 dark:text-slate-100"
        >
          Setup Tanımları
        </h3>
        <button
          onclick="yeniSetupModal()"
          class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
        >
          <svg
            class="h-5 w-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            ></path>
          </svg>
          Yeni Setup Ekle
        </button>
      </div>
    </div>
  </div>

  <!-- Setup Listesi -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div id="setupListesiYukleniyor" class="text-center py-8">
        <div
          class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"
        ></div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">
          Setup'lar yükleniyor...
        </p>
      </div>

      <div id="setupListesiIcerik" style="display: none">
        <table
          class="min-w-full divide-y divide-slate-200 dark:divide-slate-700"
        >
          <thead class="bg-slate-50 dark:bg-slate-900">
            <tr>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                Setup Adı
              </th>
              <th
                class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                Açıklama
              </th>
              <th
                class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                Yerleşim
              </th>
              <th
                class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                Ürün Sayısı
              </th>
              <th
                class="px-4 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                Maliyet
              </th>
              <th
                class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                Atanan Oda Tipleri
              </th>
              <th
                class="px-4 py-3 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase"
              >
                İşlemler
              </th>
            </tr>
          </thead>
          <tbody
            id="setupListesiTablo"
            class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700"
          ></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Yeni Setup Modal -->
<div id="yeniSetupModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        Yeni Setup Ekle
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <form id="yeniSetupForm" onsubmit="setupKaydet(event)">
      <div class="p-6">
        <div class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Setup Adı <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="yeni_setup_ad"
              name="ad"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Örn: MINI, MAXI"
              required
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Açıklama
            </label>
            <textarea
              id="yeni_setup_aciklama"
              name="aciklama"
              rows="3"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Setup hakkında açıklama..."
            ></textarea>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Yerleşim <span class="text-red-500">*</span>
            </label>
            <select
              id="yeni_setup_dolap_ici"
              name="dolap_ici"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              required
            >
              <option value="true">Dolap İçi</option>
              <option value="false">Dolap Dışı</option>
            </select>
          </div>
        </div>
      </div>
      <div
        class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
      >
        <a
          href="#"
          rel="modal:close"
          class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-50 dark:hover:bg-slate-600"
        >
          İptal
        </a>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
        >
          Kaydet
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Setup Düzenleme Modal -->
<div id="setupDuzenleModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        Setup Düzenle
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <form id="setupDuzenleForm" onsubmit="setupGuncelle(event)">
      <div class="p-6">
        <input type="hidden" id="duzenle_setup_id" />
        <div class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Setup Adı <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="duzenle_setup_ad"
              name="ad"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Örn: MINI, MAXI"
              required
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Açıklama
            </label>
            <textarea
              id="duzenle_setup_aciklama"
              name="aciklama"
              rows="3"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Setup hakkında açıklama..."
            ></textarea>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Yerleşim <span class="text-red-500">*</span>
            </label>
            <select
              id="duzenle_setup_dolap_ici"
              name="dolap_ici"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              required
            >
              <option value="true">Dolap İçi</option>
              <option value="false">Dolap Dışı</option>
            </select>
          </div>
        </div>
      </div>
      <div
        class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
      >
        <a
          href="#"
          rel="modal:close"
          class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-50 dark:hover:bg-slate-600"
        >
          İptal
        </a>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
        >
          Güncelle
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Setup İçerik Düzenleme Modal -->
<div id="setupIcerikModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-3xl w-full mx-auto max-h-[90vh] overflow-y-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-800"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        <span id="setupIcerikBaslik"></span> - İçerik Düzenleme
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <div class="p-6">
      <input type="hidden" id="icerik_setup_id" />

      <!-- Ürün Ekleme Formu -->
      <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg mb-4">
        <h6 class="text-sm font-medium text-slate-900 dark:text-slate-100 mb-3">
          Yeni Ürün Ekle
        </h6>

        <!-- Ürün Grubu Seçimi -->
        <div class="mb-3">
          <label
            class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2"
            >Ürün Grubu</label
          >
          <select
            id="icerik_urun_grup_id"
            onchange="urunGrubuDegisti()"
            class="no-choices w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
          >
            <option value="tumu">Tümü</option>
          </select>
        </div>

        <!-- Ürün Seçimi ve Ekleme -->
        <div class="flex gap-3">
          <div class="flex-1">
            <label
              class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2"
              >Ürün</label
            >
            <select
              id="icerik_urun_id"
              class="no-choices w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
            >
              <option value="">Ürün Seçin...</option>
            </select>
          </div>
          <div class="w-24">
            <label
              class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2"
              >Adet</label
            >
            <input
              type="number"
              id="icerik_adet"
              min="1"
              value="1"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Adet"
            />
          </div>
          <div class="flex items-end">
            <button
              onclick="urunEkle()"
              class="px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700"
            >
              <svg
                class="h-5 w-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Mevcut Ürünler Listesi -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h6 class="text-sm font-medium text-slate-900 dark:text-slate-100">
            Mevcut Ürünler
          </h6>
          <div class="text-right">
            <div class="text-xs text-slate-500 dark:text-slate-400">
              Toplam Maliyet
            </div>
            <div
              id="toplamMaliyet"
              class="text-lg font-bold text-green-600 dark:text-green-400"
            >
              ₺0.00
            </div>
          </div>
        </div>
        <div id="setupIcerikListesi" class="space-y-2"></div>
      </div>
    </div>
    <div
      class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end sticky bottom-0 bg-white dark:bg-slate-800"
    >
      <a
        href="#"
        rel="modal:close"
        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
      >
        Tamam
      </a>
    </div>
  </div>
</div>

<!-- Oda Tipi Setup Atama Modal -->
<div id="odaTipiSetupModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-auto max-h-[90vh] overflow-y-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-800"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        Oda Tipi - Setup Ataması
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <div class="p-6">
      <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
        Her oda tipi için setup'ları seçin (çoklu seçim yapabilirsiniz):
      </p>
      <div id="odaTipiSetupListesi" class="space-y-4"></div>
    </div>
    <div
      class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 sticky bottom-0 bg-white dark:bg-slate-800"
    >
      <a
        href="#"
        rel="modal:close"
        class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-50 dark:hover:bg-slate-600"
      >
        İptal
      </a>
      <button
        onclick="odaTipiSetupKaydet()"
        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
      >
        Tümünü Kaydet
      </button>
    </div>
  </div>
</div>

{% endblock %} {% block extra_scripts %}
<script>
  let mevcutSetuplar = [];
  let mevcutUrunler = [];
  let mevcutUrunGruplari = [];

  // CSRF token'ı al
  const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute("content");

  // Sayfa yüklendiğinde
  document.addEventListener("DOMContentLoaded", function () {
    setupListesiYukle();
    urunListesiYukle();
    urunGruplariYukle();
  });

  // Setup listesini yükle
  function setupListesiYukle() {
    fetch("/api/setuplar")
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("setupListesiYukleniyor").style.display =
          "none";
        document.getElementById("setupListesiIcerik").style.display = "block";

        if (data.success && data.setuplar) {
          mevcutSetuplar = data.setuplar;
          const tbody = document.getElementById("setupListesiTablo");
          tbody.innerHTML = "";

          data.setuplar.forEach((setup) => {
            const row = document.createElement("tr");
            row.className = "hover:bg-slate-50 dark:hover:bg-slate-700";

            const odaTipleri =
              setup.oda_tipleri && setup.oda_tipleri.length > 0
                ? setup.oda_tipleri
                    .map(
                      (t) =>
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 mr-1">${t}</span>`
                    )
                    .join("")
                : '<span class="text-slate-400">-</span>';

            // Güvenli string escape
            const escapeHtml = (str) => {
              const div = document.createElement("div");
              div.textContent = str;
              return div.innerHTML;
            };

            const escapeQuotes = (str) => {
              return str
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, "\\n");
            };

            // Dolap İçi / Dolap Dışı badge
            const dolapYerlesim = setup.dolap_ici
              ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Dolap İçi</span>'
              : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200">Dolap Dışı</span>';

            row.innerHTML = `
                            <td class="px-4 py-3">
                                <span class="inline-flex items-center px-3 py-1 text-sm font-medium bg-indigo-600 dark:bg-indigo-700 text-white">
                                    ${escapeHtml(setup.ad)}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-slate-600 dark:text-slate-400">${escapeHtml(
                              setup.aciklama || "-"
                            )}</td>
                            <td class="px-4 py-3 text-center">${dolapYerlesim}</td>
                            <td class="px-4 py-3 text-center">
                                <span class="inline-flex items-center px-3 py-1 text-sm font-semibold bg-slate-100 dark:bg-slate-700 text-slate-800 dark:text-slate-200">
                                    ${setup.urun_sayisi || 0}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <span class="text-lg font-bold text-green-600 dark:text-green-400">
                                    ₺${parseFloat(
                                      setup.toplam_maliyet || 0
                                    ).toFixed(2)}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-center">${odaTipleri}</td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex justify-end gap-2">
                                    <button onclick="setupDuzenleModal(${
                                      setup.id
                                    }, '${escapeQuotes(
              setup.ad
            )}', '${escapeQuotes(setup.aciklama || "")}', ${
              setup.dolap_ici
            })" class="p-2 text-white bg-indigo-600 rounded hover:bg-indigo-700" title="Düzenle">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button onclick="setupIcerikModal(${
                                      setup.id
                                    }, '${escapeQuotes(
              setup.ad
            )}')" class="px-3 py-2 text-xs font-medium text-white bg-cyan-600 rounded hover:bg-cyan-700">İçerik</button>
                                    <button onclick="setupAtamaModal(${
                                      setup.id
                                    }, '${escapeQuotes(
              setup.ad
            )}')" class="px-3 py-2 text-xs font-medium text-white bg-amber-600 rounded hover:bg-amber-700">Atama</button>
                                    <button onclick="setupSil(${
                                      setup.id
                                    }, '${escapeQuotes(
              setup.ad
            )}')" class="p-2 text-white bg-red-600 rounded hover:bg-red-700" title="Sil">
                                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        `;
            tbody.appendChild(row);
          });
        }
      });
  }

  // Ürün listesini yükle
  function urunListesiYukle() {
    fetch("/api/urunler-liste")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.urunler) {
          mevcutUrunler = data.urunler;
        }
      });
  }

  // Ürün gruplarını yükle
  function urunGruplariYukle() {
    fetch("/api/urun-gruplari-liste")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.gruplar) {
          mevcutUrunGruplari = data.gruplar;
        }
      });
  }

  // Yeni setup modal
  function yeniSetupModal() {
    document.getElementById("yeni_setup_ad").value = "";
    document.getElementById("yeni_setup_aciklama").value = "";
    $("#yeniSetupModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });
  }

  // Setup kaydet
  function setupKaydet(event) {
    event.preventDefault();

    const ad = document.getElementById("yeni_setup_ad").value.trim();
    const aciklama = document
      .getElementById("yeni_setup_aciklama")
      .value.trim();
    const dolap_ici =
      document.getElementById("yeni_setup_dolap_ici").value === "true";

    fetch("/api/setuplar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ ad, aciklama, dolap_ici }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          $.modal.close();
          setupListesiYukle();
          alert("Setup başarıyla eklendi");
        } else {
          alert("Hata: " + data.error);
        }
      });
  }

  // Setup içerik modal
  function setupIcerikModal(setupId, setupAd) {
    console.log("setupIcerikModal çağrıldı:", setupId, setupAd);

    document.getElementById("icerik_setup_id").value = setupId;
    document.getElementById("setupIcerikBaslik").textContent = setupAd;

    // Modal'ı aç
    $("#setupIcerikModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });

    // Ürün gruplarını yükle
    fetch("/api/urun-gruplari-liste")
      .then((response) => response.json())
      .then((gruplarData) => {
        console.log("Ürün grupları geldi:", gruplarData);

        if (gruplarData.success && gruplarData.gruplar) {
          mevcutUrunGruplari = gruplarData.gruplar;

          // Ürün grubu listesini doldur
          const grupSelect = document.getElementById("icerik_urun_grup_id");
          grupSelect.innerHTML = '<option value="tumu">Tümü</option>';
          gruplarData.gruplar.forEach((grup) => {
            grupSelect.innerHTML += `<option value="${grup.id}">${grup.ad}</option>`;
          });
          console.log("Ürün grupları dropdown dolduruldu");
        }

        // Ürünleri yükle
        return fetch("/api/urunler-liste");
      })
      .then((response) => response.json())
      .then((urunlerData) => {
        console.log("Ürünler geldi:", urunlerData);

        if (urunlerData.success && urunlerData.urunler) {
          mevcutUrunler = urunlerData.urunler;
          console.log("Ürünler kaydedildi, toplam:", mevcutUrunler.length);

          // Ürünler yüklendikten SONRA tüm ürünleri göster
          urunGrubuDegisti();
        }

        // Mevcut içeriği yükle
        setupIcerikYukle(setupId);
      })
      .catch((error) => {
        console.error("Hata:", error);
      });
  }

  // Ürün grubu değiştiğinde
  function urunGrubuDegisti() {
    const grupId = document.getElementById("icerik_urun_grup_id").value;
    const urunSelect = document.getElementById("icerik_urun_id");

    let filtreliUrunler;

    if (grupId === "tumu") {
      // Tümü seçiliyse tüm ürünleri göster
      filtreliUrunler = mevcutUrunler;
    } else {
      // Seçilen gruba ait ürünleri filtrele
      filtreliUrunler = mevcutUrunler.filter((urun) => urun.grup_id == grupId);
    }

    urunSelect.innerHTML = '<option value="">Ürün Seçin...</option>';
    filtreliUrunler.forEach((urun) => {
      urunSelect.innerHTML += `<option value="${urun.id}">${urun.ad}</option>`;
    });
  }

  // Setup içeriğini yükle
  function setupIcerikYukle(setupId) {
    fetch(`/api/setuplar/${setupId}/icerik`)
      .then((response) => response.json())
      .then((data) => {
        const liste = document.getElementById("setupIcerikListesi");
        liste.innerHTML = "";

        if (data.success && data.icerikler && data.icerikler.length > 0) {
          data.icerikler.forEach((icerik) => {
            const div = document.createElement("div");
            div.className =
              "flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900 rounded-lg";
            div.innerHTML = `
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-slate-900 dark:text-slate-100">${
                                      icerik.urun_ad
                                    }</span>
                                    <span class="text-sm text-slate-500 dark:text-slate-400">x${
                                      icerik.adet
                                    }</span>
                                </div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    ₺${icerik.alis_fiyati.toFixed(2)} × ${
              icerik.adet
            } = ₺${icerik.tutar.toFixed(2)}
                                </div>
                            </div>
                            <button onclick="urunSil(${
                              icerik.id
                            })" class="text-red-600 hover:text-red-800">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        `;
            liste.appendChild(div);
          });

          // Toplam maliyeti güncelle
          document.getElementById(
            "toplamMaliyet"
          ).textContent = `₺${data.toplam_maliyet.toFixed(2)}`;
        } else {
          liste.innerHTML =
            '<p class="text-center text-slate-400 py-4">Henüz ürün eklenmemiş</p>';
          document.getElementById("toplamMaliyet").textContent = "₺0.00";
        }
      });
  }

  // Ürün ekle
  function urunEkle() {
    const setupId = document.getElementById("icerik_setup_id").value;
    const urunId = document.getElementById("icerik_urun_id").value;
    const adet = document.getElementById("icerik_adet").value;

    if (!urunId) {
      alert("Lütfen ürün seçin");
      return;
    }

    fetch(`/api/setuplar/${setupId}/icerik`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ urun_id: parseInt(urunId), adet: parseInt(adet) }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          setupIcerikYukle(setupId);
          document.getElementById("icerik_urun_id").value = "";
          document.getElementById("icerik_adet").value = "1";
        } else {
          alert("Hata: " + data.error);
        }
      });
  }

  // Ürün sil
  function urunSil(icerikId) {
    if (!confirm("Bu ürünü silmek istediğinizden emin misiniz?")) return;

    const setupId = document.getElementById("icerik_setup_id").value;

    fetch(`/api/setup-icerik/${icerikId}`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          setupIcerikYukle(setupId);
        } else {
          alert("Hata: " + data.error);
        }
      });
  }

  // Setup içerik modal kapat
  function setupIcerikModalKapat() {
    $.modal.close();
    // Setup listesini yenile (ürün sayısını güncellemek için)
    setupListesiYukle();
  }

  // Oda Tipi Setup Atama Modal
  function setupAtamaModal(setupId, setupAd) {
    // Tüm oda tiplerini ve setup'ları yükle
    Promise.all([
      fetch("/api/oda-tipleri").then((r) => r.json()),
      fetch("/api/setuplar").then((r) => r.json()),
    ])
      .then(([odaTipleriData, setuplarData]) => {
        console.log("Oda Tipleri:", odaTipleriData);
        console.log("Setup'lar:", setuplarData);

        if (odaTipleriData.success && setuplarData.success) {
          const liste = document.getElementById("odaTipiSetupListesi");
          liste.innerHTML = "";

          if (
            !odaTipleriData.oda_tipleri ||
            odaTipleriData.oda_tipleri.length === 0
          ) {
            liste.innerHTML =
              '<p class="text-center text-slate-500 py-4">Henüz oda tipi tanımlanmamış</p>';
            return;
          }

          if (!setuplarData.setuplar || setuplarData.setuplar.length === 0) {
            liste.innerHTML =
              '<p class="text-center text-slate-500 py-4">Henüz setup tanımlanmamış</p>';
            return;
          }

          odaTipleriData.oda_tipleri.forEach((odaTipi) => {
            const div = document.createElement("div");
            div.className = "p-4 bg-slate-50 dark:bg-slate-900 rounded-lg";

            let setupCheckboxes = "";
            setuplarData.setuplar.forEach((setup) => {
              // setup_ids array kontrolü
              const setupIds = odaTipi.setup_ids || [];
              const checked = setupIds.includes(setup.id) ? "checked" : "";

              setupCheckboxes += `
              <label class="flex items-center p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded cursor-pointer">
                <input type="checkbox"
                       class="h-4 w-4 text-indigo-600 border-slate-300 rounded"
                       data-oda-tipi="${odaTipi.id}"
                       data-setup="${setup.id}"
                       ${checked}>
                <span class="ml-2 text-sm text-slate-900 dark:text-slate-100">${setup.ad}</span>
              </label>
            `;
            });

            div.innerHTML = `
            <div class="font-medium text-slate-900 dark:text-slate-100 mb-2">
              ${odaTipi.ad}
            </div>
            <div class="space-y-1">
              ${setupCheckboxes}
            </div>
          `;
            liste.appendChild(div);
          });
        } else {
          const liste = document.getElementById("odaTipiSetupListesi");
          liste.innerHTML =
            '<p class="text-center text-red-500 py-4">Veri yüklenirken hata oluştu</p>';
          console.error("API Hataları:", odaTipleriData, setuplarData);
        }
      })
      .catch((error) => {
        console.error("Modal yükleme hatası:", error);
        const liste = document.getElementById("odaTipiSetupListesi");
        liste.innerHTML =
          '<p class="text-center text-red-500 py-4">Veri yüklenirken hata oluştu: ' +
          error.message +
          "</p>";
      });

    $("#odaTipiSetupModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });
  }

  function odaTipiSetupModalKapat() {
    $.modal.close();
  }

  // Oda Tipi Setup Atama Kaydet
  function odaTipiSetupKaydet() {
    const checkboxes = document.querySelectorAll(
      '#odaTipiSetupListesi input[type="checkbox"]'
    );

    // Oda tipi bazında setup'ları grupla
    const atamalar = {};
    checkboxes.forEach((cb) => {
      const odaTipiId = parseInt(cb.dataset.odaTipi);
      const setupId = parseInt(cb.dataset.setup);

      if (!atamalar[odaTipiId]) {
        atamalar[odaTipiId] = [];
      }

      if (cb.checked) {
        atamalar[odaTipiId].push(setupId);
      }
    });

    console.log("Atamalar:", atamalar);

    // Her oda tipi için ayrı ayrı kaydet
    const promises = Object.keys(atamalar).map((odaTipiId) => {
      const payload = {
        oda_tipi_id: parseInt(odaTipiId),
        setup_ids: atamalar[odaTipiId],
      };
      console.log("Gönderilen:", payload);

      return fetch("/api/setup-atama", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify(payload),
      })
        .then((r) => {
          if (!r.ok) {
            return r.json().then((err) => {
              console.error("API Hatası:", err);
              throw new Error(err.error || "Bilinmeyen hata");
            });
          }
          return r.json();
        })
        .catch((error) => {
          console.error("Fetch hatası:", error);
          return { success: false, error: error.message };
        });
    });

    Promise.all(promises).then((results) => {
      const basarili = results.every((r) => r.success);
      if (basarili) {
        $.modal.close();
        setupListesiYukle();
        alert("Tüm atamalar başarıyla kaydedildi");
      } else {
        alert("Bazı atamalar kaydedilemedi");
      }
    });
  }

  // Setup düzenle modal
  function setupDuzenleModal(setupId, setupAd, setupAciklama, dolapIci) {
    document.getElementById("duzenle_setup_id").value = setupId;
    document.getElementById("duzenle_setup_ad").value = setupAd;
    document.getElementById("duzenle_setup_aciklama").value =
      setupAciklama || "";
    document.getElementById("duzenle_setup_dolap_ici").value =
      dolapIci === true || dolapIci === "true" ? "true" : "false";
    $("#setupDuzenleModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });
  }

  // Setup güncelle
  function setupGuncelle(event) {
    event.preventDefault();

    const setupId = document.getElementById("duzenle_setup_id").value;
    const ad = document.getElementById("duzenle_setup_ad").value.trim();
    const aciklama = document
      .getElementById("duzenle_setup_aciklama")
      .value.trim();
    const dolap_ici =
      document.getElementById("duzenle_setup_dolap_ici").value === "true";

    if (!ad) {
      alert("Setup adı boş olamaz");
      return;
    }

    fetch(`/api/setuplar/${setupId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ ad, aciklama, dolap_ici, _method: "PUT" }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (data.success) {
          $.modal.close();
          setupListesiYukle();
          alert("Setup başarıyla güncellendi");
        } else {
          alert("Hata: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Güncelleme hatası:", error);
        alert("Setup güncellenirken bir hata oluştu: " + error.message);
      });
  }

  // Setup sil
  function setupSil(setupId, setupAd) {
    if (!confirm(`"${setupAd}" setup'ını silmek istediğinizden emin misiniz?`))
      return;

    fetch(`/api/setuplar/${setupId}`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (data.success) {
          setupListesiYukle();
          alert("Setup başarıyla silindi");
        } else {
          alert("Hata: " + (data.error || "Bilinmeyen hata"));
        }
      })
      .catch((error) => {
        console.error("Silme hatası:", error);
        alert("Setup silinirken bir hata oluştu: " + error.message);
      });
  }
</script>
{% endblock %}
