{% extends "base.html" %} {% from "_form_helpers.html" import flash_messages %}
{% block title %}Setup Yönetimi - Minibar Takip Sistemi{% endblock %} {% block
page_title %}Setup Yönetimi{% endblock %} {% block content %}
<div class="space-y-6">
  {{ flash_messages() }}

  <!-- Başlık ve Yeni Ekle Butonu -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div class="flex items-center justify-between">
        <h3
          class="text-lg leading-6 font-medium text-slate-900 dark:text-slate-100"
        >
          Setup Tanımları
        </h3>
        <button
          onclick="yeniSetupModal()"
          class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700"
        >
          <svg
            class="h-5 w-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v16m8-8H4"
            ></path>
          </svg>
          Yeni Setup Ekle
        </button>
      </div>
    </div>
  </div>

  <!-- Setup Listesi -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
      <div id="setupListesiYukleniyor" class="text-center py-8">
        <div
          class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"
        ></div>
        <p class="mt-4 text-slate-600 dark:text-slate-400">
          Setup'lar yükleniyor...
        </p>
      </div>

      <div id="setupListesiIcerik" style="display: none">
        <!-- Kart Görünümü - Desktop: 3 sütun, Tablet: 2 sütun, Mobil: 1 sütun -->
        <div
          id="setupListesiKartlar"
          class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        ></div>
      </div>
    </div>
  </div>
</div>

<!-- Yeni Setup Modal -->
<div id="yeniSetupModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        Yeni Setup Ekle
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <form id="yeniSetupForm" onsubmit="setupKaydet(event)">
      <div class="p-6">
        <div class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Setup Adı <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="yeni_setup_ad"
              name="ad"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Örn: MINI, MAXI"
              required
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Açıklama
            </label>
            <textarea
              id="yeni_setup_aciklama"
              name="aciklama"
              rows="3"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Setup hakkında açıklama..."
            ></textarea>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Yerleşim <span class="text-red-500">*</span>
            </label>
            <select
              id="yeni_setup_dolap_ici"
              name="dolap_ici"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              required
            >
              <option value="true">Dolap İçi</option>
              <option value="false">Dolap Dışı</option>
            </select>
          </div>
        </div>
      </div>
      <div
        class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
      >
        <a
          href="#"
          rel="modal:close"
          class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-50 dark:hover:bg-slate-600"
        >
          İptal
        </a>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
        >
          Kaydet
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Setup Düzenleme Modal -->
<div id="setupDuzenleModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        Setup Düzenle
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <form id="setupDuzenleForm" onsubmit="setupGuncelle(event)">
      <div class="p-6">
        <input type="hidden" id="duzenle_setup_id" />
        <div class="space-y-4">
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Setup Adı <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="duzenle_setup_ad"
              name="ad"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Örn: MINI, MAXI"
              required
            />
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Açıklama
            </label>
            <textarea
              id="duzenle_setup_aciklama"
              name="aciklama"
              rows="3"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Setup hakkında açıklama..."
            ></textarea>
          </div>
          <div>
            <label
              class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
            >
              Yerleşim <span class="text-red-500">*</span>
            </label>
            <select
              id="duzenle_setup_dolap_ici"
              name="dolap_ici"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              required
            >
              <option value="true">Dolap İçi</option>
              <option value="false">Dolap Dışı</option>
            </select>
          </div>
        </div>
      </div>
      <div
        class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3"
      >
        <a
          href="#"
          rel="modal:close"
          class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-50 dark:hover:bg-slate-600"
        >
          İptal
        </a>
        <button
          type="submit"
          class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
        >
          Güncelle
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Setup İçerik Düzenleme Modal -->
<div id="setupIcerikModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-3xl w-full mx-auto max-h-[90vh] overflow-y-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-800"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        <span id="setupIcerikBaslik"></span> - İçerik Düzenleme
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <div class="p-6">
      <input type="hidden" id="icerik_setup_id" />

      <!-- Ürün Ekleme Formu -->
      <div class="bg-slate-50 dark:bg-slate-900 p-4 rounded-lg mb-4">
        <h6 class="text-sm font-medium text-slate-900 dark:text-slate-100 mb-3">
          Yeni Ürün Ekle
        </h6>

        <!-- Ürün Grubu Seçimi -->
        <div class="mb-3">
          <label
            class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2"
            >Ürün Grubu</label
          >
          <select
            id="icerik_urun_grup_id"
            onchange="urunGrubuDegisti()"
            class="no-choices w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
          >
            <option value="tumu">Tümü</option>
          </select>
        </div>

        <!-- Ürün Seçimi ve Ekleme -->
        <div class="flex gap-3">
          <div class="flex-1">
            <label
              class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2"
              >Ürün</label
            >
            <select
              id="icerik_urun_id"
              class="no-choices w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
            >
              <option value="">Ürün Seçin...</option>
            </select>
          </div>
          <div class="w-24">
            <label
              class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-2"
              >Adet</label
            >
            <input
              type="number"
              id="icerik_adet"
              min="1"
              value="1"
              class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
              placeholder="Adet"
            />
          </div>
          <div class="flex items-end">
            <button
              onclick="urunEkle()"
              class="px-4 py-2 text-white bg-green-600 rounded-md hover:bg-green-700"
            >
              <svg
                class="h-5 w-5"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 4v16m8-8H4"
                ></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Mevcut Ürünler Listesi -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <h6 class="text-sm font-medium text-slate-900 dark:text-slate-100">
            Mevcut Ürünler
          </h6>
        </div>
        <div id="setupIcerikListesi" class="space-y-2"></div>
      </div>
    </div>
    <div
      class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end sticky bottom-0 bg-white dark:bg-slate-800"
    >
      <a
        href="#"
        rel="modal:close"
        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700"
      >
        Tamam
      </a>
    </div>
  </div>
</div>

<!-- Oda Tipi Setup Atama Modal -->
<div id="odaTipiSetupModal" class="modal p-4 sm:p-6 md:p-8">
  <div
    class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-md w-full mx-auto max-h-[90vh] overflow-y-auto"
  >
    <div
      class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-800"
    >
      <h5 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
        <span id="setupAtamaBaslik">Setup Ataması</span>
      </h5>
      <a href="#" rel="modal:close" class="text-slate-400 hover:text-slate-600">
        <svg
          class="h-6 w-6"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          ></path>
        </svg>
      </a>
    </div>
    <div class="p-6">
      <!-- Seçilen Setup Bilgisi -->
      <div
        class="mb-4 p-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-lg border border-indigo-200 dark:border-indigo-800"
      >
        <div class="flex items-center gap-2">
          <svg
            class="h-5 w-5 text-indigo-600 dark:text-indigo-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
            ></path>
          </svg>
          <span class="text-sm font-medium text-indigo-800 dark:text-indigo-200"
            >Setup:</span
          >
          <span
            id="seciliSetupAdi"
            class="text-sm font-bold text-indigo-900 dark:text-indigo-100"
          ></span>
        </div>
      </div>

      <input type="hidden" id="seciliSetupId" value="" />

      <!-- Otel Seçimi -->
      <div class="mb-4">
        <label
          class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2"
        >
          <svg
            class="inline-block h-4 w-4 mr-1"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
            ></path>
          </svg>
          Otel Seçin
        </label>
        <select
          id="setupAtamaOtelSecim"
          onchange="otelSecildiSetupAtama()"
          class="w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100"
        >
          <option value="">-- Otel Seçin --</option>
        </select>
      </div>

      <p class="text-sm text-slate-600 dark:text-slate-400 mb-4">
        Bu setup'ı atamak istediğiniz oda tiplerini seçin:
      </p>
      <div id="odaTipiSetupListesi" class="space-y-2">
        <p class="text-center text-slate-400 py-4">Önce bir otel seçin</p>
      </div>
    </div>
    <div
      class="px-6 py-4 border-t border-slate-200 dark:border-slate-700 flex justify-end gap-3 sticky bottom-0 bg-white dark:bg-slate-800"
    >
      <a
        href="#"
        rel="modal:close"
        class="px-4 py-2 text-sm font-medium text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md hover:bg-slate-50 dark:hover:bg-slate-600"
      >
        İptal
      </a>
      <button
        onclick="setupAtamaKaydet()"
        id="btnOdaTipiSetupKaydet"
        disabled
        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        Kaydet
      </button>
    </div>
  </div>
</div>

{% endblock %} {% block extra_scripts %}
<script>
  let mevcutSetuplar = [];
  let mevcutUrunler = [];
  let mevcutUrunGruplari = [];

  // CSRF token'ı al
  const csrfToken = document
    .querySelector('meta[name="csrf-token"]')
    .getAttribute("content");

  // Sayfa yüklendiğinde
  document.addEventListener("DOMContentLoaded", function () {
    setupListesiYukle();
    urunListesiYukle();
    urunGruplariYukle();
  });

  // Setup listesini yükle
  function setupListesiYukle() {
    fetch("/api/setuplar")
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("setupListesiYukleniyor").style.display =
          "none";
        document.getElementById("setupListesiIcerik").style.display = "block";

        if (data.success && data.setuplar) {
          mevcutSetuplar = data.setuplar;
          const kartlar = document.getElementById("setupListesiKartlar");
          kartlar.innerHTML = "";

          // Güvenli string escape fonksiyonları
          const escapeHtml = (str) => {
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
          };

          const escapeQuotes = (str) => {
            return str
              .replace(/'/g, "\\'")
              .replace(/"/g, '\\"')
              .replace(/\n/g, "\\n");
          };

          data.setuplar.forEach((setup) => {
            // Otel bazlı oda tipleri HTML'i oluştur
            let otelOdaTipleriHTML = "";
            if (
              setup.otel_oda_tipleri &&
              Object.keys(setup.otel_oda_tipleri).length > 0
            ) {
              otelOdaTipleriHTML = Object.entries(setup.otel_oda_tipleri)
                .map(([otelAdi, odaTipleri]) => {
                  const odaTipleriBadges = odaTipleri
                    .map(
                      (tip) =>
                        `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200">${tip}</span>`
                    )
                    .join(" ");
                  return `
                  <div class="mb-2 last:mb-0">
                    <div class="flex items-center gap-1 mb-1">
                      <svg class="h-3.5 w-3.5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                      </svg>
                      <span class="text-xs font-medium text-amber-600 dark:text-amber-400">${escapeHtml(
                        otelAdi
                      )}</span>
                    </div>
                    <div class="flex flex-wrap gap-1 pl-4">${odaTipleriBadges}</div>
                  </div>
                `;
                })
                .join("");
            } else {
              otelOdaTipleriHTML =
                '<span class="text-slate-400 text-sm">Henüz atama yapılmamış</span>';
            }

            // Dolap İçi / Dolap Dışı badge
            const dolapYerlesim = setup.dolap_ici
              ? '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200">Dolap İçi</span>'
              : '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 dark:bg-orange-900 text-orange-800 dark:text-orange-200">Dolap Dışı</span>';

            // === KART ===
            const kart = document.createElement("div");
            kart.className =
              "bg-slate-50 dark:bg-slate-900 rounded-xl p-4 border border-slate-200 dark:border-slate-700 hover:shadow-lg transition-shadow";
            kart.innerHTML = `
              <!-- Başlık ve Yerleşim -->
              <div class="flex items-start justify-between mb-3">
                <div>
                  <span class="inline-flex items-center px-3 py-1.5 text-sm font-semibold bg-indigo-600 dark:bg-indigo-700 text-white rounded-lg">
                    ${escapeHtml(setup.ad)}
                  </span>
                </div>
                ${dolapYerlesim}
              </div>
              
              <!-- Açıklama -->
              ${
                setup.aciklama
                  ? `<p class="text-sm text-slate-600 dark:text-slate-400 mb-3">${escapeHtml(
                      setup.aciklama
                    )}</p>`
                  : ""
              }
              
              <!-- Ürün Sayısı -->
              <div class="flex items-center gap-2 mb-3">
                <span class="text-xs text-slate-500 dark:text-slate-400">Ürün Sayısı:</span>
                <span class="inline-flex items-center px-2 py-1 text-xs font-semibold bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 rounded">
                  ${setup.urun_sayisi || 0}
                </span>
              </div>
              
              <!-- Otel Bazlı Oda Tipleri -->
              <div class="mb-3">
                <span class="text-xs text-slate-500 dark:text-slate-400 block mb-2">Atanan Oteller ve Oda Tipleri:</span>
                <div class="bg-white dark:bg-slate-800 rounded-lg p-2 border border-slate-200 dark:border-slate-600">
                  ${otelOdaTipleriHTML}
                </div>
              </div>
              
              <!-- İşlem Butonları - 2x2 Grid -->
              <div class="grid grid-cols-2 gap-2 pt-3 border-t border-slate-200 dark:border-slate-700">
                <button onclick="setupDuzenleModal(${setup.id}, '${escapeQuotes(
              setup.ad
            )}', '${escapeQuotes(setup.aciklama || "")}', ${
              setup.dolap_ici
            })" class="py-2.5 px-3 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-blue-100 text-blue-800 hover:bg-blue-200 focus:outline-hidden focus:bg-blue-200 dark:text-blue-400 dark:bg-blue-800/30 dark:hover:bg-blue-800/20 dark:focus:bg-blue-800/20">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                  Düzenle
                </button>
                <button onclick="setupIcerikModal(${setup.id}, '${escapeQuotes(
              setup.ad
            )}')" class="py-2.5 px-3 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-teal-100 text-teal-800 hover:bg-teal-200 focus:outline-hidden focus:bg-teal-200 dark:text-teal-400 dark:bg-teal-800/30 dark:hover:bg-teal-800/20 dark:focus:bg-teal-800/20">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                  </svg>
                  İçerik
                </button>
                <button onclick="setupAtamaModal(${setup.id}, '${escapeQuotes(
              setup.ad
            )}')" class="py-2.5 px-3 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-yellow-100 text-yellow-800 hover:bg-yellow-200 focus:outline-hidden focus:bg-yellow-200 dark:text-yellow-500 dark:bg-yellow-800/30 dark:hover:bg-yellow-800/20 dark:focus:bg-yellow-800/20">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                  </svg>
                  Oda Tipi
                </button>
                <button onclick="setupSil(${setup.id}, '${escapeQuotes(
              setup.ad
            )}')" class="py-2.5 px-3 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-red-100 text-red-800 hover:bg-red-200 focus:outline-hidden focus:bg-red-200 dark:text-red-500 dark:bg-red-800/30 dark:hover:bg-red-800/20 dark:focus:bg-red-800/20">
                  <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                  Sil
                </button>
              </div>
            `;
            kartlar.appendChild(kart);
          });
        }
      });
  }

  // Ürün listesini yükle
  function urunListesiYukle() {
    fetch("/api/urunler-liste")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.urunler) {
          mevcutUrunler = data.urunler;
        }
      });
  }

  // Ürün gruplarını yükle
  function urunGruplariYukle() {
    fetch("/api/urun-gruplari-liste")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.gruplar) {
          mevcutUrunGruplari = data.gruplar;
        }
      });
  }

  // Yeni setup modal
  function yeniSetupModal() {
    document.getElementById("yeni_setup_ad").value = "";
    document.getElementById("yeni_setup_aciklama").value = "";
    $("#yeniSetupModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });
  }

  // Setup kaydet
  function setupKaydet(event) {
    event.preventDefault();

    const ad = document.getElementById("yeni_setup_ad").value.trim();
    const aciklama = document
      .getElementById("yeni_setup_aciklama")
      .value.trim();
    const dolap_ici =
      document.getElementById("yeni_setup_dolap_ici").value === "true";

    fetch("/api/setuplar", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ ad, aciklama, dolap_ici }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          $.modal.close();
          setupListesiYukle();
          alert("Setup başarıyla eklendi");
        } else {
          alert("Hata: " + data.error);
        }
      });
  }

  // Setup içerik modal
  function setupIcerikModal(setupId, setupAd) {
    console.log("setupIcerikModal çağrıldı:", setupId, setupAd);

    document.getElementById("icerik_setup_id").value = setupId;
    document.getElementById("setupIcerikBaslik").textContent = setupAd;

    // Modal'ı aç
    $("#setupIcerikModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });

    // Ürün gruplarını yükle
    fetch("/api/urun-gruplari-liste")
      .then((response) => response.json())
      .then((gruplarData) => {
        console.log("Ürün grupları geldi:", gruplarData);

        if (gruplarData.success && gruplarData.gruplar) {
          mevcutUrunGruplari = gruplarData.gruplar;

          // Ürün grubu listesini doldur
          const grupSelect = document.getElementById("icerik_urun_grup_id");
          grupSelect.innerHTML = '<option value="tumu">Tümü</option>';
          gruplarData.gruplar.forEach((grup) => {
            grupSelect.innerHTML += `<option value="${grup.id}">${grup.ad}</option>`;
          });
          console.log("Ürün grupları dropdown dolduruldu");
        }

        // Ürünleri yükle
        return fetch("/api/urunler-liste");
      })
      .then((response) => response.json())
      .then((urunlerData) => {
        console.log("Ürünler geldi:", urunlerData);

        if (urunlerData.success && urunlerData.urunler) {
          mevcutUrunler = urunlerData.urunler;
          console.log("Ürünler kaydedildi, toplam:", mevcutUrunler.length);

          // Ürünler yüklendikten SONRA tüm ürünleri göster
          urunGrubuDegisti();
        }

        // Mevcut içeriği yükle
        setupIcerikYukle(setupId);
      })
      .catch((error) => {
        console.error("Hata:", error);
      });
  }

  // Ürün grubu değiştiğinde
  function urunGrubuDegisti() {
    const grupId = document.getElementById("icerik_urun_grup_id").value;
    const urunSelect = document.getElementById("icerik_urun_id");

    let filtreliUrunler;

    if (grupId === "tumu") {
      // Tümü seçiliyse tüm ürünleri göster
      filtreliUrunler = mevcutUrunler;
    } else {
      // Seçilen gruba ait ürünleri filtrele
      filtreliUrunler = mevcutUrunler.filter((urun) => urun.grup_id == grupId);
    }

    urunSelect.innerHTML = '<option value="">Ürün Seçin...</option>';
    filtreliUrunler.forEach((urun) => {
      urunSelect.innerHTML += `<option value="${urun.id}">${urun.ad}</option>`;
    });
  }

  // Setup içeriğini yükle
  function setupIcerikYukle(setupId) {
    fetch(`/api/setuplar/${setupId}/icerik`)
      .then((response) => response.json())
      .then((data) => {
        const liste = document.getElementById("setupIcerikListesi");
        liste.innerHTML = "";

        if (data.success && data.icerikler && data.icerikler.length > 0) {
          data.icerikler.forEach((icerik) => {
            const div = document.createElement("div");
            div.className =
              "flex items-center justify-between p-3 bg-slate-50 dark:bg-slate-900 rounded-lg";
            div.innerHTML = `
                            <div class="flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-medium text-slate-900 dark:text-slate-100">${icerik.urun_ad}</span>
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200">x${icerik.adet}</span>
                                </div>
                            </div>
                            <button onclick="urunSil(${icerik.id})" class="text-red-600 hover:text-red-800">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        `;
            liste.appendChild(div);
          });
        } else {
          liste.innerHTML =
            '<p class="text-center text-slate-400 py-4">Henüz ürün eklenmemiş</p>';
        }
      });
  }

  // Ürün ekle
  function urunEkle() {
    const setupId = document.getElementById("icerik_setup_id").value;
    const urunId = document.getElementById("icerik_urun_id").value;
    const adet = document.getElementById("icerik_adet").value;

    if (!urunId) {
      alert("Lütfen ürün seçin");
      return;
    }

    fetch(`/api/setuplar/${setupId}/icerik`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ urun_id: parseInt(urunId), adet: parseInt(adet) }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          setupIcerikYukle(setupId);
          document.getElementById("icerik_urun_id").value = "";
          document.getElementById("icerik_adet").value = "1";
        } else {
          alert("Hata: " + data.error);
        }
      });
  }

  // Ürün sil
  function urunSil(icerikId) {
    if (!confirm("Bu ürünü silmek istediğinizden emin misiniz?")) return;

    const setupId = document.getElementById("icerik_setup_id").value;

    fetch(`/api/setup-icerik/${icerikId}`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": csrfToken,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          setupIcerikYukle(setupId);
        } else {
          alert("Hata: " + data.error);
        }
      });
  }

  // Setup içerik modal kapat
  function setupIcerikModalKapat() {
    $.modal.close();
    // Setup listesini yenile (ürün sayısını güncellemek için)
    setupListesiYukle();
  }

  // Oda Tipi Setup Atama Modal
  let seciliOtelIdSetupAtama = null;
  let seciliSetupIdAtama = null;

  function setupAtamaModal(setupId, setupAd) {
    // Seçilen setup bilgisini kaydet
    seciliSetupIdAtama = setupId;
    document.getElementById("seciliSetupId").value = setupId;
    document.getElementById("seciliSetupAdi").textContent = setupAd;
    document.getElementById(
      "setupAtamaBaslik"
    ).textContent = `${setupAd} - Oda Tipi Ataması`;

    // Önce otelleri yükle
    fetch("/api/oteller-liste")
      .then((response) => response.json())
      .then((data) => {
        if (data.success && data.oteller) {
          const otelSelect = document.getElementById("setupAtamaOtelSecim");
          otelSelect.innerHTML = '<option value="">-- Otel Seçin --</option>';

          data.oteller.forEach((otel) => {
            otelSelect.innerHTML += `<option value="${otel.id}">${otel.ad}</option>`;
          });

          // Listeyi temizle
          document.getElementById("odaTipiSetupListesi").innerHTML =
            '<p class="text-center text-slate-400 py-4">Önce bir otel seçin</p>';

          // Kaydet butonunu devre dışı bırak
          document.getElementById("btnOdaTipiSetupKaydet").disabled = true;
          seciliOtelIdSetupAtama = null;
        }
      })
      .catch((error) => {
        console.error("Oteller yüklenirken hata:", error);
      });

    $("#odaTipiSetupModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });
  }

  function otelSecildiSetupAtama() {
    const otelId = document.getElementById("setupAtamaOtelSecim").value;
    const liste = document.getElementById("odaTipiSetupListesi");
    const kaydetBtn = document.getElementById("btnOdaTipiSetupKaydet");
    const setupId = seciliSetupIdAtama;

    if (!otelId) {
      liste.innerHTML =
        '<p class="text-center text-slate-400 py-4">Önce bir otel seçin</p>';
      kaydetBtn.disabled = true;
      seciliOtelIdSetupAtama = null;
      return;
    }

    if (!setupId) {
      liste.innerHTML =
        '<p class="text-center text-red-500 py-4">Setup seçilmedi!</p>';
      kaydetBtn.disabled = true;
      return;
    }

    seciliOtelIdSetupAtama = parseInt(otelId);
    liste.innerHTML =
      '<p class="text-center text-slate-400 py-4">Yükleniyor...</p>';

    // Seçilen oteldeki oda tiplerini ve mevcut atamaları yükle
    Promise.all([
      fetch(`/api/oteller/${otelId}/oda-tipleri-liste`).then((r) => r.json()),
      fetch(`/api/oda-tipleri?otel_id=${otelId}`).then((r) => r.json()),
    ])
      .then(([odaTipleriData, odaTipleriSetupData]) => {
        console.log("Otel Oda Tipleri:", odaTipleriData);
        console.log("Oda Tipleri Setup (Otel bazlı):", odaTipleriSetupData);

        if (odaTipleriData.success && odaTipleriSetupData.success) {
          liste.innerHTML = "";

          if (
            !odaTipleriData.oda_tipleri ||
            odaTipleriData.oda_tipleri.length === 0
          ) {
            liste.innerHTML =
              '<p class="text-center text-slate-500 py-4">Bu otelde henüz oda tipi tanımlanmamış</p>';
            kaydetBtn.disabled = true;
            return;
          }

          // Otel bazlı setup bilgisini map'e çevir (hangi oda tipine hangi setup'lar atanmış)
          const odaTipiSetupMap = {};
          odaTipleriSetupData.oda_tipleri.forEach((tip) => {
            odaTipiSetupMap[tip.id] = tip.setup_ids || [];
          });

          // Oda tiplerini listele - her biri için sadece bu setup atanmış mı checkbox göster
          odaTipleriData.oda_tipleri.forEach((odaTipi) => {
            // Bu oda tipine bu setup atanmış mı?
            const setupIds = odaTipiSetupMap[odaTipi.id] || [];
            const checked = setupIds.includes(setupId) ? "checked" : "";

            const div = document.createElement("div");
            div.className =
              "flex items-center p-3 bg-slate-50 dark:bg-slate-900 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors";

            div.innerHTML = `
              <label class="flex items-center w-full cursor-pointer">
                <input type="checkbox"
                       class="h-5 w-5 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500"
                       data-oda-tipi="${odaTipi.id}"
                       ${checked}>
                <span class="ml-3 text-sm font-medium text-slate-900 dark:text-slate-100">${odaTipi.ad}</span>
              </label>
            `;
            liste.appendChild(div);
          });

          kaydetBtn.disabled = false;
        } else {
          liste.innerHTML =
            '<p class="text-center text-red-500 py-4">Veri yüklenirken hata oluştu</p>';
          kaydetBtn.disabled = true;
          console.error("API Hataları:", odaTipleriData, odaTipleriSetupData);
        }
      })
      .catch((error) => {
        console.error("Modal yükleme hatası:", error);
        liste.innerHTML =
          '<p class="text-center text-red-500 py-4">Veri yüklenirken hata oluştu: ' +
          error.message +
          "</p>";
        kaydetBtn.disabled = true;
      });
  }

  function odaTipiSetupModalKapat() {
    $.modal.close();
  }

  // Setup Atama Kaydet - Seçilen setup'ı seçilen oda tiplerine ata
  function setupAtamaKaydet() {
    if (!seciliOtelIdSetupAtama) {
      alert("Lütfen önce bir otel seçin");
      return;
    }

    if (!seciliSetupIdAtama) {
      alert("Setup seçilmedi!");
      return;
    }

    const checkboxes = document.querySelectorAll(
      '#odaTipiSetupListesi input[type="checkbox"]'
    );

    // Seçilen ve seçilmeyen oda tiplerini ayır
    const secilenOdaTipleri = [];
    const secilemeyenOdaTipleri = [];

    checkboxes.forEach((cb) => {
      const odaTipiId = parseInt(cb.dataset.odaTipi);
      if (cb.checked) {
        secilenOdaTipleri.push(odaTipiId);
      } else {
        secilemeyenOdaTipleri.push(odaTipiId);
      }
    });

    console.log("Seçilen Setup ID:", seciliSetupIdAtama);
    console.log("Otel ID:", seciliOtelIdSetupAtama);
    console.log("Seçilen Oda Tipleri:", secilenOdaTipleri);
    console.log("Seçilmeyen Oda Tipleri:", secilemeyenOdaTipleri);

    // Önce mevcut atamaları al, sonra güncelle
    fetch(`/api/oda-tipleri?otel_id=${seciliOtelIdSetupAtama}`)
      .then((r) => r.json())
      .then((data) => {
        if (!data.success) {
          throw new Error("Mevcut atamalar alınamadı");
        }

        // Her oda tipi için güncelleme yap
        const promises = [];

        // Mevcut oda tipi -> setup_ids map'i
        const odaTipiSetupMap = {};
        data.oda_tipleri.forEach((tip) => {
          odaTipiSetupMap[tip.id] = tip.setup_ids || [];
        });

        // Seçilen oda tiplerine bu setup'ı ekle
        secilenOdaTipleri.forEach((odaTipiId) => {
          let setupIds = [...(odaTipiSetupMap[odaTipiId] || [])];
          if (!setupIds.includes(seciliSetupIdAtama)) {
            setupIds.push(seciliSetupIdAtama);
          }

          const payload = {
            otel_id: seciliOtelIdSetupAtama,
            oda_tipi_id: odaTipiId,
            setup_ids: setupIds,
          };

          promises.push(
            fetch("/api/setup-atama", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              body: JSON.stringify(payload),
            }).then((r) => r.json())
          );
        });

        // Seçilmeyen oda tiplerinden bu setup'ı kaldır
        secilemeyenOdaTipleri.forEach((odaTipiId) => {
          let setupIds = [...(odaTipiSetupMap[odaTipiId] || [])];
          setupIds = setupIds.filter((id) => id !== seciliSetupIdAtama);

          const payload = {
            otel_id: seciliOtelIdSetupAtama,
            oda_tipi_id: odaTipiId,
            setup_ids: setupIds,
          };

          promises.push(
            fetch("/api/setup-atama", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken,
              },
              body: JSON.stringify(payload),
            }).then((r) => r.json())
          );
        });

        return Promise.all(promises);
      })
      .then((results) => {
        const basarili = results.every((r) => r.success);
        if (basarili) {
          $.modal.close();
          setupListesiYukle();
          alert("Atamalar başarıyla kaydedildi");
        } else {
          alert("Bazı atamalar kaydedilemedi");
          console.error(
            "Hatalı sonuçlar:",
            results.filter((r) => !r.success)
          );
        }
      })
      .catch((error) => {
        console.error("Kaydetme hatası:", error);
        alert("Kaydetme sırasında hata oluştu: " + error.message);
      });
  }

  // Setup düzenle modal
  function setupDuzenleModal(setupId, setupAd, setupAciklama, dolapIci) {
    document.getElementById("duzenle_setup_id").value = setupId;
    document.getElementById("duzenle_setup_ad").value = setupAd;
    document.getElementById("duzenle_setup_aciklama").value =
      setupAciklama || "";
    document.getElementById("duzenle_setup_dolap_ici").value =
      dolapIci === true || dolapIci === "true" ? "true" : "false";
    $("#setupDuzenleModal").modal({
      fadeDuration: 200,
      fadeDelay: 0.1,
    });
  }

  // Setup güncelle
  function setupGuncelle(event) {
    event.preventDefault();

    const setupId = document.getElementById("duzenle_setup_id").value;
    const ad = document.getElementById("duzenle_setup_ad").value.trim();
    const aciklama = document
      .getElementById("duzenle_setup_aciklama")
      .value.trim();
    const dolap_ici =
      document.getElementById("duzenle_setup_dolap_ici").value === "true";

    if (!ad) {
      alert("Setup adı boş olamaz");
      return;
    }

    fetch(`/api/setuplar/${setupId}`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrfToken,
      },
      body: JSON.stringify({ ad, aciklama, dolap_ici, _method: "PUT" }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (data.success) {
          $.modal.close();
          setupListesiYukle();
          alert("Setup başarıyla güncellendi");
        } else {
          alert("Hata: " + data.error);
        }
      })
      .catch((error) => {
        console.error("Güncelleme hatası:", error);
        alert("Setup güncellenirken bir hata oluştu: " + error.message);
      });
  }

  // Setup sil
  function setupSil(setupId, setupAd) {
    if (!confirm(`"${setupAd}" setup'ını silmek istediğinizden emin misiniz?`))
      return;

    fetch(`/api/setuplar/${setupId}`, {
      method: "DELETE",
      headers: {
        "X-CSRFToken": csrfToken,
        "Content-Type": "application/json",
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (data.success) {
          setupListesiYukle();
          alert("Setup başarıyla silindi");
        } else {
          alert("Hata: " + (data.error || "Bilinmeyen hata"));
        }
      })
      .catch((error) => {
        console.error("Silme hatası:", error);
        alert("Setup silinirken bir hata oluştu: " + error.message);
      });
  }
</script>
{% endblock %}
