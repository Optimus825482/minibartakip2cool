{% extends "base.html" %}

{% block title %}Depo Stoklarƒ± - Minibar Takip Sistemi{% endblock %}
{% block page_title %} <div>
    <h1 class="text-2xl md:text-3xl font-bold text-slate-900 dark:text-slate-100">üì¶ Depo Stoklarƒ±</h1>
    <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">T√ºm √ºr√ºnlerin depo stok durumlarƒ±nƒ± g√∂r√ºnt√ºleyin</p>
</div>{% endblock %}

{% block content %}
<div class="space-y-4 md:space-y-6">

    <!-- ƒ∞lk Stok Y√ºkleme Butonlarƒ± - Her otel i√ßin ayrƒ± -->
    {% set ilk_stok_bekleyen_oteller = oteller|selectattr('ilk_stok_yuklendi', 'false')|list %}
    {% if ilk_stok_bekleyen_oteller %}
    <div
        class="bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 border border-emerald-200 dark:border-emerald-800 shadow rounded-lg p-4">
        <div class="flex items-start gap-3">
            <div class="flex-shrink-0">
                <svg class="w-6 h-6 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                    </path>
                </svg>
            </div>
            <div class="flex-1">
                <h3 class="text-sm font-semibold text-emerald-800 dark:text-emerald-300 mb-2">ƒ∞lk Stok Y√ºkleme</h3>
                <p class="text-xs text-emerald-700 dark:text-emerald-400 mb-3">A≈üaƒüƒ±daki oteller i√ßin hen√ºz ilk stok
                    y√ºklemesi yapƒ±lmamƒ±≈ü. Excel dosyasƒ± ile toplu stok giri≈üi yapabilirsiniz.</p>
                <div class="flex flex-wrap gap-2">
                    {% for otel in oteller %}
                    {% if not otel.ilk_stok_yuklendi %}
                    <button type="button" onclick="openIlkStokModal({{ otel.id }}, '{{ otel.ad }}')"
                        class="inline-flex items-center px-3 py-1.5 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg transition-colors text-sm font-medium">
                        <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4">
                            </path>
                        </svg>
                        {{ otel.ad }}
                    </button>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Filtre B√∂l√ºm√º -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-4">
        <form id="filtreForm" method="GET" action="{{ url_for('admin_depo_stoklari') }}">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                    <label for="otel_id" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                        Otel
                    </label>
                    <select name="otel_id" id="filtre_otel_id"
                        class="no-choices w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-slate-200">
                        <option value="">T√ºm Oteller</option>
                        {% for otel in oteller %}
                        <option value="{{ otel.id }}" {% if secili_otel_id==otel.id %}selected{% endif %}>
                            {{ otel.ad }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="depo_sorumlusu_id"
                        class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1">
                        Depo Sorumlusu
                    </label>
                    <select name="depo_sorumlusu_id" id="filtre_depo_sorumlusu_id"
                        class="no-choices w-full px-3 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-slate-200"
                        disabled>
                        <option value="">√ñnce otel se√ßin</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    {% if secili_otel_id or secili_depo_id %}
                    <a href="{{ url_for('admin_depo_stoklari') }}"
                        class="px-4 py-2 bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600 text-slate-700 dark:text-slate-200 rounded-lg transition-colors">
                        Temizle
                    </a>
                    {% endif %}
                    {% if secili_otel_id %}
                    <a href="{{ url_for('admin_depo_stoklari', format='excel', otel_id=secili_otel_id, depo_sorumlusu_id=secili_depo_id) }}" id="excelIndirBtn"
                        class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Excel ƒ∞ndir
                    </a>
                    {% else %}
                    <span class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg opacity-50 cursor-not-allowed">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Excel ƒ∞ndir
                    </span>
                    {% endif %}
                </div>
            </div>
        </form>
    </div>


    <!-- Stok Tablosu -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg overflow-hidden">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                <h3 class="text-lg font-medium text-slate-900 dark:text-slate-100">Stok Listesi</h3>
                <div class="flex flex-wrap items-center gap-3">
                   
                </div>
            </div>

            {% if not secili_otel_id %}
            <!-- Otel se√ßilmemi≈ü uyarƒ±sƒ± -->
            <div class="text-center py-16">
                <svg class="mx-auto h-16 w-16 text-blue-400 dark:text-blue-500" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="mt-4 text-lg font-medium text-slate-900 dark:text-slate-100">Otel Se√ßimi Gerekli</h3>
                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">
                    Stok listesini g√∂r√ºnt√ºlemek i√ßin yukarƒ±dan bir otel se√ßin ve filtrele butonuna tƒ±klayƒ±n.
                </p>
            </div>
            {% elif stok_listesi %}
            <div class="table-wrapper">
                <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                    <thead class="bg-slate-50 dark:bg-slate-900">
                        <tr>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                √úr√ºn Adƒ±
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Grup
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Birim
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Depo Stok
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Zimmet Stok
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Toplam Stok
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Kritik Seviye
                            </th>
                            <th
                                class="px-6 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">
                                Durum
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                        {% for item in stok_listesi %}
                        <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                            <td
                                class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-slate-100">
                                {{ item.urun_adi }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-400">
                                {{ item.grup_adi }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-400">
                                {{ item.birim }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-400">
                                {{ item.depo_stok }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 dark:text-blue-400">
                                {{ item.zimmet_stok }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold 
                                {% if item.durum == 'kritik' %}text-red-600 dark:text-red-400
                                {% elif item.durum == 'dikkat' %}text-yellow-600 dark:text-yellow-400
                                {% else %}text-green-600 dark:text-green-400{% endif %}">
                                {{ item.toplam_stok }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600 dark:text-slate-400">
                                {{ item.kritik_stok }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium {{ item.badge_class }}">
                                    {{ item.badge_text }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-slate-400 dark:text-slate-600" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                    </path>
                </svg>
                <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">Se√ßilen filtreye uygun stok kaydƒ± bulunamadƒ±
                </p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
    // Filtre - Otel deƒüi≈ütiƒüinde depo sorumlularƒ±nƒ± y√ºkle ve otomatik filtrele
    document.addEventListener('DOMContentLoaded', function () {
        const otelSelect = document.getElementById('filtre_otel_id');
        const depoSelect = document.getElementById('filtre_depo_sorumlusu_id');
        const filtreForm = document.getElementById('filtreForm');

        // Sayfa y√ºklendiƒüinde eƒüer otel se√ßiliyse depo sorumlularƒ±nƒ± y√ºkle
        var seciliDepoId = {% if secili_depo_id %}{{ secili_depo_id }}{% else %}null{% endif %};
        var seciliOtelId = {% if secili_otel_id %}{{ secili_otel_id }}{% else %}null{% endif %};

        if (otelSelect.value) {
            loadDepoSorumlularƒ±(otelSelect.value, seciliDepoId);
        }

        // Otel deƒüi≈ütiƒüinde - otomatik filtrele
        otelSelect.addEventListener('change', async function () {
            const otelId = this.value;

            if (!otelId) {
                depoSelect.innerHTML = '<option value="">√ñnce otel se√ßin</option>';
                depoSelect.disabled = true;
                // Otel se√ßilmezse sayfayƒ± temizle
                window.location.href = '{{ url_for("admin_depo_stoklari") }}';
                return;
            }

            // Depo sorumlularƒ±nƒ± y√ºkle
            await loadDepoSorumlularƒ±(otelId);
            
            // Otomatik filtrele - sadece otel ile
            filtreForm.submit();
        });

        // Depo sorumlusu deƒüi≈ütiƒüinde - otomatik filtrele
        depoSelect.addEventListener('change', function () {
            if (otelSelect.value) {
                filtreForm.submit();
            }
        });

        // Tablo scroll indicator
        const tableWrapper = document.querySelector('.table-wrapper');
        if (tableWrapper) {
            tableWrapper.addEventListener('scroll', function () {
                if (this.scrollLeft + this.clientWidth >= this.scrollWidth - 10) {
                    this.classList.add('scrolled-end');
                } else {
                    this.classList.remove('scrolled-end');
                }
            });
        }
    });

    // Depo sorumlularƒ±nƒ± y√ºkle
    async function loadDepoSorumlularƒ±(otelId, seciliDepoId = null) {
        const depoSelect = document.getElementById('filtre_depo_sorumlusu_id');

        try {
            depoSelect.innerHTML = '<option value="">Y√ºkleniyor...</option>';
            depoSelect.disabled = true;

            const response = await fetch(`/api/oteller/${otelId}/depo-sorumlularƒ±`);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Hatasƒ±:', response.status, errorText);
                throw new Error(`HTTP ${response.status}: Depo sorumlularƒ± y√ºklenemedi`);
            }

            const depoSorumlular = await response.json();

            depoSelect.innerHTML = '<option value="">T√ºm Depo Sorumlularƒ±</option>';

            if (depoSorumlular.length === 0) {
                depoSelect.innerHTML = '<option value="">Bu otelde depo sorumlusu yok</option>';
                depoSelect.disabled = true;
                return;
            }

            depoSorumlular.forEach(depo => {
                const option = document.createElement('option');
                option.value = depo.id;
                option.textContent = `${depo.ad} ${depo.soyad}`;

                // Eƒüer bu depo sorumlusu se√ßiliyse i≈üaretle
                if (seciliDepoId && depo.id === seciliDepoId) {
                    option.selected = true;
                }

                depoSelect.appendChild(option);
            });

            depoSelect.disabled = false;

        } catch (error) {
            console.error('Depo sorumlularƒ± y√ºklenirken hata:', error);
            depoSelect.innerHTML = '<option value="">Hata olu≈ütu - L√ºtfen tekrar deneyin</option>';
            depoSelect.disabled = true;

            // Kullanƒ±cƒ±ya bildirim g√∂ster
            if (typeof showError === 'function') {
                showError('Depo sorumlularƒ± y√ºklenirken hata olu≈ütu');
            }
        }
    }
</script>

<!-- Stok Giri≈ü Modal - jQuery Modal -->
<div id="stokGirisModal" class="modal bg-white dark:bg-slate-800 shadow-2xl">
    <!-- Header -->
    <div
        class="px-4 sm:px-6 md:px-8 py-4 sm:py-5 md:py-6 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-900 dark:to-slate-800">
        <h5 class="text-lg sm:text-xl font-bold text-slate-900 dark:text-slate-100 flex items-center">
            <svg class="h-5 w-5 sm:h-6 sm:w-6 mr-2 sm:mr-3 text-blue-600 dark:text-blue-400 flex-shrink-0" fill="none"
                stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
            </svg>
            <span class="truncate">Yeni Stok Giri≈üi</span>
        </h5>
    </div>

    <!-- Body -->
    <div class="p-4 sm:p-6 md:p-8 overflow-y-auto" style="max-height: calc(90vh - 180px);">
        <form id="stokGirisForm" class="space-y-4 sm:space-y-6">
            <!-- Otel -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    Otel <span class="text-red-500">*</span>
                </label>
                <select id="otelSelect" required
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-slate-200">
                    <option value="">Otel Se√ßin</option>
                    {% for otel in oteller %}
                    <option value="{{ otel.id }}">{{ otel.ad }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Depo Sorumlusu -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    Depo Sorumlusu <span class="text-red-500">*</span>
                </label>
                <select id="depoSorumlusuSelect" required disabled
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-slate-100 dark:disabled:bg-slate-900 dark:bg-slate-700 dark:text-slate-200">
                    <option value="">√ñnce otel se√ßin</option>
                </select>
            </div>

            <!-- √úr√ºn Grubu -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    √úr√ºn Grubu <span class="text-red-500">*</span>
                </label>
                <select id="grupSelect" required
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-slate-200">
                    <option value="">√úr√ºn Grubu Se√ßin</option>
                </select>
            </div>

            <!-- √úr√ºn -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    √úr√ºn <span class="text-red-500">*</span>
                </label>
                <select id="urunSelect" required disabled
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 disabled:bg-slate-100 dark:disabled:bg-slate-900 dark:bg-slate-700 dark:text-slate-200">
                    <option value="">√ñnce √ºr√ºn grubu se√ßin</option>
                </select>
            </div>

            <!-- Miktar -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    Miktar <span class="text-red-500">*</span>
                </label>
                <input type="number" id="miktarInput" min="1" required
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-slate-200"
                    placeholder="Giri≈ü miktarƒ±nƒ± girin">
            </div>

            <!-- A√ßƒ±klama -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    A√ßƒ±klama
                </label>
                <textarea id="aciklamaInput" rows="3"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:text-slate-200"
                    placeholder="ƒ∞steƒüe baƒülƒ± a√ßƒ±klama"></textarea>
            </div>

            <!-- Butonlar -->
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeStokGirisModal()"
                    class="px-6 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700">
                    ƒ∞ptal
                </button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Stok Giri≈üi Yap
                </button>
            </div>
        </form>
    </div>
</div>
-->
<!-- Modal SONU -->

<!-- Select2 k√ºt√ºphaneleri kaldƒ±rƒ±ldƒ± - Modal ile birlikte gereksiz hale geldi -->

<!--
<script>
let gruplar = [];
let urunler = [];

// Modal a√ßma - KALDIRILDI
function openStokGirisModal() {
    document.getElementById('stokGirisModal').classList.remove('hidden');
    loadGruplar();
    
    // Otel se√ßimi event listener (sadece bir kez ekle)
    const otelSelect = document.getElementById('otelSelect');
    
    // Eski event listener'larƒ± temizle
    const newOtelSelect = otelSelect.cloneNode(true);
    otelSelect.parentNode.replaceChild(newOtelSelect, otelSelect);
    
    // Yeni event listener ekle
    newOtelSelect.addEventListener('change', async function() {
        const otelId = this.value;
        const depoSelect = document.getElementById('depoSorumlusuSelect');
        
        if (!otelId) {
            depoSelect.innerHTML = '<option value="">√ñnce otel se√ßin</option>';
            depoSelect.disabled = true;
            return;
        }
        
        try {
            depoSelect.innerHTML = '<option value="">Y√ºkleniyor...</option>';
            depoSelect.disabled = true;
            
            const response = await fetch(`/api/oteller/${otelId}/depo-sorumlularƒ±`);
            
            if (!response.ok) {
                throw new Error('API hatasƒ±');
            }
            
            const depoSorumlular = await response.json();
            
            depoSelect.innerHTML = '<option value="">Depo Sorumlusu Se√ßin</option>';
            
            depoSorumlular.forEach(depo => {
                const option = document.createElement('option');
                option.value = depo.id;
                option.textContent = `${depo.ad} ${depo.soyad}`;
                depoSelect.appendChild(option);
            });
            
            // Eƒüer tek sorumlu varsa otomatik se√ß
            if (depoSorumlular.length === 1) {
                depoSelect.selectedIndex = 1; // ƒ∞lk ger√ßek se√ßeneƒüi se√ß
            }
            
            depoSelect.disabled = false;
            
        } catch (error) {
            console.error('Depo sorumlular y√ºklenemedi:', error);
            depoSelect.innerHTML = '<option value="">Hata olu≈ütu</option>';
            depoSelect.disabled = true;
        }
    });
}

// Modal kapatma
function closeStokGirisModal() {
    document.getElementById('stokGirisModal').classList.add('hidden');
    document.getElementById('stokGirisForm').reset();
    $('#urunSelect').val(null).trigger('change').prop('disabled', true);
    document.getElementById('depoSorumlusuSelect').disabled = true;
}

// Gruplarƒ± y√ºkle
async function loadGruplar() {
    try {
        const response = await fetch('/api/urun-gruplari');
        gruplar = await response.json();
        
        const grupSelect = document.getElementById('grupSelect');
        grupSelect.innerHTML = '<option value="">√úr√ºn Grubu Se√ßin</option>';
        
        gruplar.forEach(grup => {
            const option = document.createElement('option');
            option.value = grup.id;
            option.textContent = grup.grup_adi;
            grupSelect.appendChild(option);
        });
        
        // Select2 ba≈ülat
        $('#grupSelect').select2({
            placeholder: '√úr√ºn grubu ara...',
            allowClear: true,
            dropdownParent: $('#stokGirisModal'),
            theme: 'default'
        });
        
        // Select2 change event'i
        $('#grupSelect').on('change', loadUrunlerByGrup);
        
    } catch (error) {
        console.error('Gruplar y√ºklenemedi:', error);
        showError('√úr√ºn gruplarƒ± y√ºklenirken hata olu≈ütu');
    }
}

// Grup se√ßildiƒüinde √ºr√ºnleri y√ºkle
async function loadUrunlerByGrup() {
    const grupId = $('#grupSelect').val();
    const urunSelect = document.getElementById('urunSelect');
    
    if (!grupId) {
        urunSelect.innerHTML = '<option value="">√ñnce √ºr√ºn grubu se√ßin</option>';
        urunSelect.disabled = true;
        $('#urunSelect').select2('destroy');
        return;
    }
    
    try {
        const response = await fetch(`/api/urunler-by-grup/${grupId}`);
        urunler = await response.json();
        
        urunSelect.innerHTML = '<option value="">√úr√ºn Se√ßin</option>';
        urunler.forEach(urun => {
            const option = document.createElement('option');
            option.value = urun.id;
            option.textContent = `${urun.urun_adi} (Stok: ${urun.stok_miktari} ${urun.birim})`;
            urunSelect.appendChild(option);
        });
        
        urunSelect.disabled = false;
        
        // Select2 ba≈ülat
        $('#urunSelect').select2({
            placeholder: '√úr√ºn ara...',
            allowClear: true,
            dropdownParent: $('#stokGirisModal'),
            theme: 'default'
        });
        
    } catch (error) {
        console.error('√úr√ºnler y√ºklenemedi:', error);
        showError('√úr√ºnler y√ºklenirken hata olu≈ütu');
    }
}

// Form submit
document.getElementById('stokGirisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const urunId = document.getElementById('urunSelect').value;
    const miktar = document.getElementById('miktarInput').value;
    const aciklama = document.getElementById('aciklamaInput').value;
    
    if (!urunId || !miktar) {
        showWarning('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun');
        return;
    }
    
    // CSRF token'ƒ± meta tag'den al
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    if (!csrfToken) {
        showError('CSRF token bulunamadƒ±', 'G√ºvenlik Hatasƒ±');
        return;
    }
    
    try {
        const response = await fetch('/api/stok-giris', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                urun_id: parseInt(urunId),
                miktar: parseInt(miktar),
                aciklama: aciklama
            })
        });
        
        // Response kontrol√º
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Hatasƒ±:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 100)}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            closeStokGirisModal();
            showSuccess('Stok giri≈üi ba≈üarƒ±yla kaydedildi');
            setTimeout(() => location.reload(), 1500);
        } else {
            showError(data.message || 'Bilinmeyen hata');
        }
        
    } catch (error) {
        console.error('Stok giri≈üi hatasƒ±:', error);
        showError(error.message, 'Stok Giri≈üi Hatasƒ±');
    }
});
</script>
-->
<!-- Modal JavaScript SONU -->

<!-- ƒ∞lk Stok Y√ºkleme Modal -->
<div id="ilkStokModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
        <div class="fixed inset-0 transition-opacity bg-slate-500 bg-opacity-75 dark:bg-slate-900 dark:bg-opacity-75"
            onclick="closeIlkStokModal()"></div>

        <div
            class="relative inline-block w-full max-w-2xl overflow-hidden text-left align-bottom transition-all transform bg-white dark:bg-slate-800 rounded-lg shadow-xl sm:my-8 sm:align-middle">
            <!-- Header -->
            <div
                class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-slate-900 dark:to-slate-800">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-slate-100 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-emerald-600 dark:text-emerald-400" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        ƒ∞lk Stok Y√ºkleme
                    </h3>
                    <button onclick="closeIlkStokModal()"
                        class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <p class="mt-1 text-sm text-slate-600 dark:text-slate-400" id="ilkStokOtelAdi"></p>
            </div>

            <!-- Body -->
            <div class="px-6 py-4">
                <!-- Adƒ±m 1: Dosya Y√ºkleme -->
                <div id="ilkStokStep1">
                    <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                        <p class="text-sm text-blue-800 dark:text-blue-300">
                            <i class="fas fa-info-circle mr-2"></i>
                            Excel dosyanƒ±zda <strong>urun_adi</strong> ve <strong>adet</strong> s√ºtunlarƒ± olmalƒ±dƒ±r.
                        </p>
                    </div>

                    <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-lg p-8 text-center"
                        id="dropZone">
                        <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12">
                            </path>
                        </svg>
                        <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">Excel dosyasƒ±nƒ± s√ºr√ºkleyip bƒ±rakƒ±n
                            veya</p>
                        <label
                            class="mt-2 inline-flex items-center px-4 py-2 bg-emerald-600 text-white rounded-lg cursor-pointer hover:bg-emerald-700 transition-colors">
                            <span>Dosya Se√ß</span>
                            <input type="file" id="ilkStokFile" accept=".xlsx,.xls" class="hidden"
                                onchange="handleFileSelect(this)">
                        </label>
                        <p class="mt-2 text-xs text-slate-500 dark:text-slate-500" id="selectedFileName"></p>
                    </div>

                    <div class="mt-4 flex justify-end">
                        <button type="button" onclick="previewIlkStok()" id="previewBtn" disabled
                            class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                            <i class="fas fa-eye mr-2"></i>√ñnizle
                        </button>
                    </div>
                </div>

                <!-- Adƒ±m 2: √ñnizleme -->
                <div id="ilkStokStep2" class="hidden">
                    <div class="mb-4 grid grid-cols-2 gap-4">
                        <div class="p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                            <p class="text-sm text-green-800 dark:text-green-300">
                                <i class="fas fa-check-circle mr-1"></i>
                                E≈üle≈üen: <strong id="eslesenSayisi">0</strong> √ºr√ºn
                            </p>
                        </div>
                        <div class="p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                            <p class="text-sm text-yellow-800 dark:text-yellow-300">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                E≈üle≈ümeyen: <strong id="eslesmeyenSayisi">0</strong> √ºr√ºn
                            </p>
                        </div>
                    </div>

                    <!-- E≈üle≈üen √úr√ºnler Tablosu -->
                    <div class="max-h-64 overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                            <thead class="bg-slate-50 dark:bg-slate-900 sticky top-0">
                                <tr>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">
                                        √úr√ºn Adƒ±</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">
                                        Adet</th>
                                    <th
                                        class="px-4 py-2 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase">
                                        Birim</th>
                                </tr>
                            </thead>
                            <tbody id="eslesenUrunlerBody"
                                class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                            </tbody>
                        </table>
                    </div>

                    <!-- E≈üle≈ümeyen √úr√ºnler -->
                    <div id="eslesmeyenContainer" class="mt-4 hidden">
                        <p class="text-sm font-medium text-yellow-700 dark:text-yellow-400 mb-2">
                            <i class="fas fa-exclamation-triangle mr-1"></i>E≈üle≈ümeyen √úr√ºnler (Y√ºklenmeyecek):
                        </p>
                        <div class="max-h-32 overflow-y-auto bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-3">
                            <ul id="eslesmeyenList" class="text-sm text-yellow-800 dark:text-yellow-300 space-y-1"></ul>
                        </div>
                    </div>

                    <div class="mt-4 flex justify-between">
                        <button type="button" onclick="backToStep1()"
                            class="px-4 py-2 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-slate-300 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>Geri
                        </button>
                        <button type="button" onclick="confirmIlkStok()" id="confirmBtn"
                            class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">
                            <i class="fas fa-check mr-2"></i>Onayla ve Y√ºkle
                        </button>
                    </div>
                </div>

                <!-- Loading -->
                <div id="ilkStokLoading" class="hidden text-center py-8">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto"></div>
                    <p class="mt-4 text-slate-600 dark:text-slate-400">ƒ∞≈üleniyor...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ƒ∞lk Stok Y√ºkleme JavaScript
    let selectedFile = null;
    let previewData = null;
    let currentOtelId = null;

    // Modal a√ß
    function openIlkStokModal(otelId, otelAdi) {
        currentOtelId = otelId;
        document.getElementById('ilkStokOtelAdi').textContent = otelAdi + ' i√ßin ilk stok y√ºklemesi';
        document.getElementById('ilkStokModal').classList.remove('hidden');
        resetModal();
    }

    // Modal kapat
    function closeIlkStokModal() {
        document.getElementById('ilkStokModal').classList.add('hidden');
        resetModal();
    }

    // Modal sƒ±fƒ±rla
    function resetModal() {
        selectedFile = null;
        previewData = null;
        document.getElementById('ilkStokFile').value = '';
        document.getElementById('selectedFileName').textContent = '';
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('ilkStokStep1').classList.remove('hidden');
        document.getElementById('ilkStokStep2').classList.add('hidden');
        document.getElementById('ilkStokLoading').classList.add('hidden');
    }

    // Dosya se√ßimi
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            selectedFile = input.files[0];
            document.getElementById('selectedFileName').textContent = selectedFile.name;
            document.getElementById('previewBtn').disabled = false;
        }
    }

    // √ñnizleme
    async function previewIlkStok() {
        if (!selectedFile || !currentOtelId) return;

        showLoading();

        const formData = new FormData();
        formData.append('excel_file', selectedFile);
        formData.append('action', 'preview');

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        try {
            const response = await fetch(`/admin/ilk-stok-yukleme/${currentOtelId}`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });

            const data = await response.json();

            if (data.success && data.preview) {
                previewData = data;
                showPreview(data);
            } else {
                hideLoading();
                showError(data.message || '√ñnizleme olu≈üturulamadƒ±');
            }
        } catch (error) {
            hideLoading();
            showError('Bir hata olu≈ütu: ' + error.message);
        }
    }

    // √ñnizleme g√∂ster
    function showPreview(data) {
        document.getElementById('eslesenSayisi').textContent = data.toplam_eslesen;
        document.getElementById('eslesmeyenSayisi').textContent = data.toplam_eslesmeyen;

        // E≈üle≈üen √ºr√ºnler tablosu
        const tbody = document.getElementById('eslesenUrunlerBody');
        tbody.innerHTML = '';
        data.eslesen_urunler.forEach(urun => {
            tbody.innerHTML += `<tr><td class="px-4 py-2 text-sm text-slate-900 dark:text-slate-100">${urun.urun_adi}</td><td class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400">${urun.adet}</td><td class="px-4 py-2 text-sm text-slate-600 dark:text-slate-400">${urun.birim}</td></tr>`;
        });

        // E≈üle≈ümeyen √ºr√ºnler
        const eslesmeyenContainer = document.getElementById('eslesmeyenContainer');
        const eslesmeyenList = document.getElementById('eslesmeyenList');
        if (data.eslesmeyen_urunler.length > 0) {
            eslesmeyenContainer.classList.remove('hidden');
            eslesmeyenList.innerHTML = '';
            data.eslesmeyen_urunler.forEach(urun => {
                eslesmeyenList.innerHTML += `<li>‚Ä¢ ${urun.excel_urun_adi} (${urun.adet} adet)</li>`;
            });
        } else {
            eslesmeyenContainer.classList.add('hidden');
        }

        // Confirm butonu durumu
        document.getElementById('confirmBtn').disabled = data.toplam_eslesen === 0;

        hideLoading();
        document.getElementById('ilkStokStep1').classList.add('hidden');
        document.getElementById('ilkStokStep2').classList.remove('hidden');
    }

    // Geri d√∂n
    function backToStep1() {
        document.getElementById('ilkStokStep1').classList.remove('hidden');
        document.getElementById('ilkStokStep2').classList.add('hidden');
    }

    // Onayla ve y√ºkle
    async function confirmIlkStok() {
        if (!selectedFile || !currentOtelId) return;

        showLoading();

        const formData = new FormData();
        formData.append('excel_file', selectedFile);
        formData.append('action', 'confirm');

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        try {
            const response = await fetch(`/admin/ilk-stok-yukleme/${currentOtelId}`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                closeIlkStokModal();
                showSuccess(data.message);
                setTimeout(() => location.reload(), 1500);
            } else {
                hideLoading();
                showError(data.message || 'Y√ºkleme ba≈üarƒ±sƒ±z');
            }
        } catch (error) {
            hideLoading();
            showError('Bir hata olu≈ütu: ' + error.message);
        }
    }

    function showLoading() {
        document.getElementById('ilkStokStep1').classList.add('hidden');
        document.getElementById('ilkStokStep2').classList.add('hidden');
        document.getElementById('ilkStokLoading').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('ilkStokLoading').classList.add('hidden');
    }

    // Drag & Drop
    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('border-emerald-500', 'bg-emerald-50', 'dark:bg-emerald-900/20'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('border-emerald-500', 'bg-emerald-50', 'dark:bg-emerald-900/20'), false);
        });

        dropZone.addEventListener('drop', function (e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    selectedFile = file;
                    document.getElementById('selectedFileName').textContent = file.name;
                    document.getElementById('previewBtn').disabled = false;
                } else {
                    showWarning('Sadece Excel dosyalarƒ± (.xlsx, .xls) kabul edilir.');
                }
            }
        }, false);
    }
</script>

{% endblock %}