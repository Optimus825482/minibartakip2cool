{% extends "base.html" %}

{% block title %}Minibar ƒ∞≈ülemleri - Admin Panel{% endblock %}
{% block page_title %}Minibar ƒ∞≈ülemleri{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Filtreler -->
    <div class="bg-white shadow rounded-lg p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Filtreler</h3>
        <form method="GET" action="{{ url_for('admin_minibar_islemleri') }}" class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Oda</label>
                <select name="oda_id" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    <option value="">T√ºm√º</option>
                    {% for oda in odalar %}
                    <option value="{{ oda.id }}" {% if oda_id == oda.id %}selected{% endif %}>
                        {{ oda.oda_no }} - {{ oda.kat.kat_adi }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Personel</label>
                <select name="personel_id" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    <option value="">T√ºm√º</option>
                    {% for personel in personeller %}
                    <option value="{{ personel.id }}" {% if personel_id == personel.id %}selected{% endif %}>
                        {{ personel.ad }} {{ personel.soyad }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">ƒ∞≈ülem Tipi</label>
                <select name="islem_tipi" class="w-full px-4 py-2 border border-slate-300 rounded-lg">
                    <option value="">T√ºm√º</option>
                    <option value="kontrol" {% if islem_tipi == 'kontrol' %}selected{% endif %}>Kontrol</option>
                    <option value="dolum" {% if islem_tipi == 'dolum' %}selected{% endif %}>Dolum</option>
                </select>
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Ba≈ülangƒ±√ß Tarihi</label>
                <input type="date" name="baslangic_tarih" value="{{ baslangic_tarih }}"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">Biti≈ü Tarihi</label>
                <input type="date" name="bitis_tarih" value="{{ bitis_tarih }}"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg">
            </div>
            
            <div class="md:col-span-5 flex justify-end space-x-4">
                <a href="{{ url_for('admin_minibar_islemleri') }}"
                    class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                    Temizle
                </a>
                <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Filtrele
                </button>
            </div>
        </form>
    </div>
    
    <!-- Minibar ƒ∞≈ülemleri Tablosu -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">
                Minibar ƒ∞≈ülemleri ({{ islemler.total }} kayƒ±t)
            </h3>
        </div>
        
        {% if islemler.items %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-slate-200">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Tarih</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Oda</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">ƒ∞≈ülem Tipi</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Personel</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">√úr√ºn Sayƒ±sƒ±</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">A√ßƒ±klama</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase">ƒ∞≈ülemler</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-slate-200">
                    {% for islem in islemler.items %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                            {{ islem.islem_tarihi.strftime('%d.%m.%Y %H:%M') }}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-900">
                            {{ islem.oda.oda_no }} - {{ islem.oda.kat.kat_adi }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full
                                {% if islem.islem_tipi == 'kontrol' %}bg-blue-100 text-blue-800
                                {% else %}bg-green-100 text-green-800{% endif %}">
                                {{ islem.islem_tipi.title() }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">
                            {% if islem.personel %}
                            {{ islem.personel.ad }} {{ islem.personel.soyad }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
                            {{ islem.detaylar|length }} √ºr√ºn
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">
                            {{ islem.aciklama or '-' }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="showDetayModal({{ islem.id }})"
                                class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 transition-colors">
                                Detay
                            </button>
                            <button onclick="silIslem({{ islem.id }})"
                                class="text-red-600 hover:text-red-900">
                                Sil
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Sayfalama -->
        {% if islemler.pages > 1 %}
        <div class="px-6 py-4 border-t border-slate-200 flex justify-between items-center">
            <div class="text-sm text-slate-600">
                Sayfa {{ islemler.page }} / {{ islemler.pages }}
            </div>
            <div class="flex space-x-2">
                {% if islemler.has_prev %}
                <a href="{{ url_for('admin_minibar_islemleri', sayfa=islemler.prev_num, oda_id=oda_id, personel_id=personel_id, islem_tipi=islem_tipi, baslangic_tarih=baslangic_tarih, bitis_tarih=bitis_tarih) }}"
                    class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                    √ñnceki
                </a>
                {% endif %}
                {% if islemler.has_next %}
                <a href="{{ url_for('admin_minibar_islemleri', sayfa=islemler.next_num, oda_id=oda_id, personel_id=personel_id, islem_tipi=islem_tipi, baslangic_tarih=baslangic_tarih, bitis_tarih=bitis_tarih) }}"
                    class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                    Sonraki
                </a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        {% else %}
        <div class="px-6 py-12 text-center text-slate-500">
            Minibar i≈ülemi bulunamadƒ±.
        </div>
        {% endif %}
    </div>
</div>

<!-- Minibar ƒ∞≈ülem Modal -->
<div id="minibarIslemModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-slate-900">Yeni Minibar ƒ∞≈ülemi</h3>
            <button onclick="closeMinibarIslemModal()" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="minibarIslemForm" class="p-6 space-y-6">
            <!-- Oda Se√ßimi -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    Oda <span class="text-red-500">*</span>
                </label>
                <select id="odaSelect" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Oda Se√ßin</option>
                </select>
            </div>
            
            <!-- ƒ∞≈ülem Tipi -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    ƒ∞≈ülem Tipi <span class="text-red-500">*</span>
                </label>
                <select id="islemTipiSelect" required
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">ƒ∞≈ülem Tipi Se√ßin</option>
                    <option value="kontrol">Kontrol</option>
                    <option value="dolum">Dolum</option>
                </select>
            </div>
            
            <!-- √úr√ºnler Tablosu -->
            <div id="urunlerContainer" class="hidden">
                <h4 class="text-sm font-medium text-slate-700 mb-3">√úr√ºnler</h4>
                <div class="border border-slate-300 rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-slate-500">√úr√ºn</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-slate-500">Mevcut</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-slate-500">Ba≈ülangƒ±√ß</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-slate-500">Biti≈ü</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-slate-500">T√ºketim</th>
                            </tr>
                        </thead>
                        <tbody id="urunlerTableBody" class="bg-white divide-y divide-slate-200">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- A√ßƒ±klama -->
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-2">
                    A√ßƒ±klama
                </label>
                <textarea id="aciklamaInput" rows="3"
                    class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    placeholder="ƒ∞steƒüe baƒülƒ± a√ßƒ±klama"></textarea>
            </div>
            
            <!-- Butonlar -->
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeMinibarIslemModal()"
                    class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                    ƒ∞ptal
                </button>
                <button type="submit"
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    ƒ∞≈ülemi Kaydet
                </button>
            </div>
        </form>
    </div>
</div>

<!-- jQuery (Select2 i√ßin gerekli) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS & JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Select2 Dark Mode CSS -->
<style>
.dark .select2-container--default .select2-selection--single {
    background-color: rgb(51 65 85);
    border-color: rgb(71 85 105);
    color: rgb(226 232 240);
}

.dark .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: rgb(226 232 240);
}

.dark .select2-container--default .select2-selection--single .select2-selection__arrow b {
    border-color: rgb(148 163 184) transparent transparent transparent;
}

.dark .select2-dropdown {
    background-color: rgb(51 65 85);
    border-color: rgb(71 85 105);
}

.dark .select2-container--default .select2-results__option {
    color: rgb(226 232 240);
}

.dark .select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: rgb(30 41 59);
}

.dark .select2-container--default .select2-search--dropdown .select2-search__field {
    background-color: rgb(30 41 59);
    border-color: rgb(71 85 105);
    color: rgb(226 232 240);
}

.dark .select2-container--default.select2-container--disabled .select2-selection--single {
    background-color: rgb(15 23 42);
}
</style>

<script>
let odalar = [];
let minibarUrunler = [];
let mevcutStoklar = {};

// Modal a√ßma
function openMinibarIslemModal() {
    document.getElementById('minibarIslemModal').classList.remove('hidden');
    loadOdalar();
}

// Modal kapatma
function closeMinibarIslemModal() {
    document.getElementById('minibarIslemModal').classList.add('hidden');
    document.getElementById('minibarIslemForm').reset();
    document.getElementById('urunlerContainer').classList.add('hidden');
}

// Odalarƒ± y√ºkle
async function loadOdalar() {
    try {
        const response = await fetch('/api/odalar');
        odalar = await response.json();
        
        const odaSelect = document.getElementById('odaSelect');
        odaSelect.innerHTML = '<option value="">Oda Se√ßin</option>';
        
        odalar.forEach(oda => {
            const option = document.createElement('option');
            option.value = oda.id;
            option.textContent = `${oda.oda_no} - ${oda.kat_adi}`;
            odaSelect.appendChild(option);
        });
        
        // Select2 ba≈ülat
        $('#odaSelect').select2({
            placeholder: 'Oda ara...',
            allowClear: true,
            dropdownParent: $('#minibarIslemModal'),
            theme: 'default'
        });
        
        // Select2 change event'i
        $('#odaSelect').on('change', loadMinibarUrunler);
        
    } catch (error) {
        console.error('Odalar y√ºklenemedi:', error);
        alert('Odalar y√ºklenirken hata olu≈ütu');
    }
}

// ƒ∞≈ülem tipi se√ßildiƒüinde √ºr√ºnleri y√ºkle
document.getElementById('islemTipiSelect').addEventListener('change', loadMinibarUrunler);

async function loadMinibarUrunler() {
    const odaId = document.getElementById('odaSelect').value;
    const islemTipi = document.getElementById('islemTipiSelect').value;
    
    if (!odaId || !islemTipi) {
        document.getElementById('urunlerContainer').classList.add('hidden');
        return;
    }
    
    try {
        // Minibar i√ßeriƒüini getir
        const response = await fetch(`/api/minibar-icerigi/${odaId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'Minibar i√ßeriƒüi alƒ±namadƒ±');
        }
        
        mevcutStoklar = {};
        const tbody = document.getElementById('urunlerTableBody');
        tbody.innerHTML = '';
        
        // √úr√ºn yoksa bilgi g√∂ster
        if (!data.urunler || data.urunler.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-slate-500">Bu odada hen√ºz minibar √ºr√ºn√º yok. L√ºtfen √∂nce minibar dolumu yapƒ±n.</td></tr>';
            document.getElementById('urunlerContainer').classList.remove('hidden');
            return;
        }
        
        data.urunler.forEach(urun => {
            const mevcutStok = urun.mevcut_stok || 0;
            mevcutStoklar[urun.urun_id] = mevcutStok;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-4 py-2 text-sm text-slate-900">${urun.urun_adi}</td>
                <td class="px-4 py-2 text-center text-sm font-medium text-slate-900">${mevcutStok}</td>
                <td class="px-4 py-2 text-center">
                    <input type="number" min="0" value="${mevcutStok}"
                        data-urun-id="${urun.urun_id}"
                        class="baslangic-input w-20 px-2 py-1 border border-slate-300 rounded text-center"
                        onchange="hesaplaTuketim(${urun.urun_id})">
                </td>
                <td class="px-4 py-2 text-center">
                    <input type="number" min="0" value="0"
                        data-urun-id="${urun.urun_id}"
                        class="bitis-input w-20 px-2 py-1 border border-slate-300 rounded text-center"
                        onchange="hesaplaTuketim(${urun.urun_id})">
                </td>
                <td class="px-4 py-2 text-center">
                    <span id="tuketim-${urun.urun_id}" class="text-sm font-semibold text-red-600">0</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
        
        document.getElementById('urunlerContainer').classList.remove('hidden');
        
    } catch (error) {
        console.error('Minibar √ºr√ºnleri y√ºklenemedi:', error);
        alert('Minibar √ºr√ºnleri y√ºklenirken hata olu≈ütu');
    }
}

// T√ºketim hesapla
function hesaplaTuketim(urunId) {
    const baslangic = parseInt(document.querySelector(`.baslangic-input[data-urun-id="${urunId}"]`).value) || 0;
    const bitis = parseInt(document.querySelector(`.bitis-input[data-urun-id="${urunId}"]`).value) || 0;
    const tuketim = baslangic - bitis;
    
    document.getElementById(`tuketim-${urunId}`).textContent = tuketim;
}

// Form submit
document.getElementById('minibarIslemForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const odaId = document.getElementById('odaSelect').value;
    const islemTipi = document.getElementById('islemTipiSelect').value;
    const aciklama = document.getElementById('aciklamaInput').value;
    
    if (!odaId || !islemTipi) {
        alert('L√ºtfen t√ºm zorunlu alanlarƒ± doldurun');
        return;
    }
    
    // √úr√ºn detaylarƒ±nƒ± topla
    const detaylar = [];
    document.querySelectorAll('.baslangic-input').forEach(input => {
        const urunId = input.dataset.urunId;
        const baslangic = parseInt(input.value) || 0;
        const bitis = parseInt(document.querySelector(`.bitis-input[data-urun-id="${urunId}"]`).value) || 0;
        
        detaylar.push({
            urun_id: parseInt(urunId),
            baslangic_stok: baslangic,
            bitis_stok: bitis,
            tuketim: baslangic - bitis
        });
    });
    
    try {
        const response = await fetch('/api/minibar-islem-kaydet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                oda_id: parseInt(odaId),
                islem_tipi: islemTipi,
                aciklama: aciklama,
                detaylar: detaylar
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Minibar i≈ülemi ba≈üarƒ±yla kaydedildi');
            closeMinibarIslemModal();
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
        
    } catch (error) {
        console.error('Minibar i≈ülemi hatasƒ±:', error);
        alert('Minibar i≈ülemi sƒ±rasƒ±nda hata olu≈ütu');
    }
});

async function silIslem(islemId) {
    const result = await showConfirm(
        'Bu minibar i≈ülemini silmek istediƒüinizden emin misiniz?\n\nƒ∞lgili stok hareketleri geri alƒ±nacaktƒ±r.',
        'Minibar ƒ∞≈ülemi Sil'
    );
    
    if (!result.isConfirmed) {
        return;
    }
    
    try {
        // CSRF token'ƒ± al
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
        
        const response = await fetch(`/admin/minibar-islem-sil/${islemId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess('ƒ∞≈ülem ba≈üarƒ±yla silindi');
            setTimeout(() => location.reload(), 1500);
        } else {
            showError(data.message || 'Silme i≈ülemi ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        console.error('Silme hatasƒ±:', error);
        showError(error.message, 'Silme Hatasƒ±');
    }
}

// ƒ∞lk Dolum Modal Fonksiyonlarƒ±
let tumUrunler = [];
let tumGruplar = [];
let secilenGrupId = null;

function openIlkDolumModal() {
    document.getElementById('ilkDolumModal').classList.remove('hidden');
    loadOdalarForIlkDolum();
    loadGruplarForIlkDolum();
}

function closeIlkDolumModal() {
    document.getElementById('ilkDolumModal').classList.add('hidden');
    document.getElementById('ilkDolumForm').reset();
    document.getElementById('urunListesi').innerHTML = '';
    document.getElementById('grupSecimDiv').classList.add('hidden');
    document.getElementById('urunListesiDiv').classList.add('hidden');
    secilenGrupId = null;
}

async function loadOdalarForIlkDolum() {
    try {
        const response = await fetch('/api/odalar');
        const odalar = await response.json();
        
        const odaSelect = document.getElementById('ilkDolumOdaSelect');
        odaSelect.innerHTML = '<option value="">Oda Se√ßin</option>';
        
        odalar.forEach(oda => {
            const option = document.createElement('option');
            option.value = oda.id;
            option.textContent = `${oda.oda_no} - ${oda.kat_adi}`;
            odaSelect.appendChild(option);
        });
        
        // Oda se√ßildiƒüinde grup se√ßimini g√∂ster
        odaSelect.addEventListener('change', function() {
            if (this.value) {
                document.getElementById('grupSecimDiv').classList.remove('hidden');
            } else {
                document.getElementById('grupSecimDiv').classList.add('hidden');
                document.getElementById('urunListesiDiv').classList.add('hidden');
            }
        });
    } catch (error) {
        console.error('Odalar y√ºklenemedi:', error);
        showError('Odalar y√ºklenirken hata olu≈ütu');
    }
}

async function loadGruplarForIlkDolum() {
    try {
        const response = await fetch('/api/urun-gruplari');
        tumGruplar = await response.json();
        
        const grupSelect = document.getElementById('ilkDolumGrupSelect');
        grupSelect.innerHTML = '<option value="">T√ºm Gruplar</option>';
        
        tumGruplar.forEach(grup => {
            const option = document.createElement('option');
            option.value = grup.id;
            option.textContent = grup.grup_adi;
            grupSelect.appendChild(option);
        });
        
        // Grup se√ßildiƒüinde √ºr√ºnleri y√ºkle
        grupSelect.addEventListener('change', function() {
            secilenGrupId = this.value ? parseInt(this.value) : null;
            loadUrunlerForIlkDolum();
        });
    } catch (error) {
        console.error('Gruplar y√ºklenemedi:', error);
        showError('Gruplar y√ºklenirken hata olu≈ütu');
    }
}

async function loadUrunlerForIlkDolum() {
    try {
        // Grup se√ßiliyse o grubun √ºr√ºnlerini, deƒüilse t√ºm √ºr√ºnleri getir
        const url = secilenGrupId 
            ? `/api/urunler-by-grup/${secilenGrupId}`
            : '/api/urunler';
            
        const response = await fetch(url);
        tumUrunler = await response.json();
        
        console.log('Y√ºklenen √ºr√ºnler:', tumUrunler);
        console.log('Stokta olan √ºr√ºnler:', tumUrunler.filter(u => u.stok_miktari > 0));
        console.log('Stokta olmayan √ºr√ºnler:', tumUrunler.filter(u => u.stok_miktari === 0));
        
        // √úr√ºn listesini g√∂ster
        document.getElementById('urunListesiDiv').classList.remove('hidden');
        renderUrunListesi();
    } catch (error) {
        console.error('√úr√ºnler y√ºklenemedi:', error);
        showError('√úr√ºnler y√ºklenirken hata olu≈ütu');
    }
}

function renderUrunListesi() {
    const container = document.getElementById('urunListesi');
    container.innerHTML = '';
    
    // Sadece stokta olan √ºr√ºnleri g√∂ster
    const stokluUrunler = tumUrunler.filter(u => u.stok_miktari > 0);
    
    if (stokluUrunler.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-slate-500 dark:text-slate-400">
                <svg class="w-12 h-12 mx-auto mb-3 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <p class="font-medium">Stokta √ºr√ºn yok</p>
                <p class="text-sm mt-1">L√ºtfen √∂nce depo stok giri≈üi yapƒ±n</p>
            </div>
        `;
        return;
    }
    
    stokluUrunler.forEach(urun => {
        const ilkDolumYapilmis = ilkDolumYapilmisUrunler.includes(urun.id);
        const stokYok = urun.stok_miktari === 0;
        const disabled = ilkDolumYapilmis || stokYok;
        
        const div = document.createElement('div');
        div.className = `flex items-center justify-between p-3 rounded-lg ${
            disabled
                ? 'bg-slate-200 dark:bg-slate-900 opacity-60' 
                : 'bg-slate-50 dark:bg-slate-700'
        }`;
        
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <input type="checkbox" id="urun_${urun.id}" 
                    class="w-4 h-4 text-blue-600 rounded"
                    onchange="toggleUrunMiktar(${urun.id})"
                    ${disabled ? 'disabled' : ''}>
                <label for="urun_${urun.id}" class="text-sm font-medium ${
                    disabled
                        ? 'text-slate-500 dark:text-slate-500 line-through' 
                        : 'text-slate-900 dark:text-slate-100'
                }">
                    ${urun.urun_adi}
                    ${ilkDolumYapilmis ? '<span class="ml-2 text-xs text-red-500">‚úì ƒ∞lk dolum yapƒ±lmƒ±≈ü</span>' : ''}
                    ${stokYok ? '<span class="ml-2 text-xs text-orange-500">‚ö†Ô∏è Stokta yok</span>' : ''}
                </label>
                <span class="text-xs ${stokYok ? 'text-orange-500 font-semibold' : 'text-slate-500 dark:text-slate-400'}">
                    (Stok: ${urun.stok_miktari} ${urun.birim})
                </span>
            </div>
            <div id="miktar_${urun.id}" class="hidden">
                <input type="number" min="1" ${urun.stok_miktari > 0 ? `max="${urun.stok_miktari}"` : ''} value="1"
                    class="w-20 px-2 py-1 border border-slate-300 dark:border-slate-600 rounded dark:bg-slate-800 dark:text-slate-200 text-sm"
                    placeholder="Miktar"
                    ${urun.stok_miktari === 0 ? 'disabled title="Stokta yok"' : ''}>
                ${urun.stok_miktari === 0 ? '<span class="ml-2 text-xs text-red-500">Stokta yok</span>' : ''}
            </div>
        `;
        container.appendChild(div);
    });
    
    // Eƒüer hi√ß se√ßilebilir √ºr√ºn yoksa uyarƒ± g√∂ster
    const secilebilirUrunler = tumUrunler.filter(u => !ilkDolumYapilmisUrunler.includes(u.id));
    if (secilebilirUrunler.length === 0 && tumUrunler.length > 0) {
        const uyariDiv = document.createElement('div');
        uyariDiv.className = 'text-center py-8 text-slate-500 dark:text-slate-400';
        uyariDiv.innerHTML = `
            <svg class="w-12 h-12 mx-auto mb-3 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="font-medium">Bu oda i√ßin t√ºm √ºr√ºnlere ilk dolum yapƒ±lmƒ±≈ü</p>
            <p class="text-sm mt-1">Yeni √ºr√ºn eklendiƒüinde buradan ilk dolum yapabilirsiniz</p>
        `;
        container.appendChild(uyariDiv);
    }
}

function toggleUrunMiktar(urunId) {
    const checkbox = document.getElementById(`urun_${urunId}`);
    const miktarDiv = document.getElementById(`miktar_${urunId}`);
    
    if (checkbox.checked) {
        miktarDiv.classList.remove('hidden');
    } else {
        miktarDiv.classList.add('hidden');
    }
}

// Oda se√ßildiƒüinde ilk dolum yapƒ±lmƒ±≈ü √ºr√ºnleri kontrol et
let ilkDolumYapilmisUrunler = [];

document.addEventListener('DOMContentLoaded', function() {
    const odaSelect = document.getElementById('ilkDolumOdaSelect');
    if (odaSelect) {
        odaSelect.addEventListener('change', async function() {
            const odaId = this.value;
            
            // Oda se√ßimi temizlendiyse t√ºm √ºr√ºnleri aktif et
            if (!odaId) {
                ilkDolumYapilmisUrunler = [];
                renderUrunListesi();
                return;
            }
            
            try {
                const response = await fetch(`/api/minibar-ilk-dolum-kontrol/${odaId}`);
                const data = await response.json();
                
                if (data.success && data.ilk_dolum_urunler.length > 0) {
                    ilkDolumYapilmisUrunler = data.ilk_dolum_urunler.map(u => u.urun_id);
                    
                    // √úr√ºn listesini g√ºncelle
                    renderUrunListesi();
                    
                    // Bilgilendirme mesajƒ±
                    const urunAdlari = data.ilk_dolum_urunler.map(u => u.urun_adi).join(', ');
                    showInfo(
                        `Bu oda i√ßin ≈üu √ºr√ºnlere daha √∂nce ilk dolum yapƒ±lmƒ±≈ü:\n\n${urunAdlari}\n\nBu √ºr√ºnler listede devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±.`,
                        'Bilgilendirme'
                    );
                } else {
                    ilkDolumYapilmisUrunler = [];
                    renderUrunListesi();
                }
            } catch (error) {
                console.error('Kontrol hatasƒ±:', error);
                showError('ƒ∞lk dolum kontrol√º yapƒ±lƒ±rken hata olu≈ütu');
            }
        });
    }
});

// ƒ∞lk Dolum Form Submit
document.addEventListener('DOMContentLoaded', function() {
    const ilkDolumForm = document.getElementById('ilkDolumForm');
    
    if (!ilkDolumForm) {
        console.error('ƒ∞lk Dolum Form bulunamadƒ±!');
        return;
    }
    
    console.log('ƒ∞lk Dolum Form event listener eklendi');
    
    ilkDolumForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log('Form submit tetiklendi!');
        
        const odaId = document.getElementById('ilkDolumOdaSelect').value;
        const aciklama = document.getElementById('ilkDolumAciklama').value;
        
        console.log('Oda ID:', odaId);
        
        if (!odaId) {
            showWarning('L√ºtfen oda se√ßin');
            return;
        }
    
    // Se√ßili √ºr√ºnleri topla
    const urunler = [];
    tumUrunler.forEach(urun => {
        const checkbox = document.getElementById(`urun_${urun.id}`);
        if (checkbox && checkbox.checked) {
            const miktarInput = document.querySelector(`#miktar_${urun.id} input`);
            const miktar = parseInt(miktarInput.value) || 0;
            if (miktar > 0) {
                urunler.push({
                    urun_id: urun.id,
                    miktar: miktar
                });
            }
        }
    });
    
    if (urunler.length === 0) {
        showWarning('L√ºtfen en az bir √ºr√ºn se√ßin ve miktar girin');
        return;
    }
    
    // CSRF token
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    if (!csrfToken) {
        showError('CSRF token bulunamadƒ±', 'G√ºvenlik Hatasƒ±');
        return;
    }
    
    try {
        console.log('ƒ∞lk dolum isteƒüi g√∂nderiliyor:', {
            oda_id: parseInt(odaId),
            aciklama: aciklama,
            urunler: urunler
        });
        
        const response = await fetch('/api/minibar-ilk-dolum', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                oda_id: parseInt(odaId),
                aciklama: aciklama,
                urunler: urunler
            })
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
            const errorText = await response.text();
            console.error('API Hatasƒ±:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('JSON deƒüil:', text.substring(0, 500));
            throw new Error('Sunucu JSON d√∂nd√ºrmedi. L√ºtfen console\'u kontrol edin.');
        }
        
        const data = await response.json();
        console.log('Response data:', data);
        
        if (data.success) {
            closeIlkDolumModal();
            showSuccess(data.message);
            setTimeout(() => location.reload(), 1500);
        } else {
            showError(data.message || 'ƒ∞≈ülem ba≈üarƒ±sƒ±z');
        }
    } catch (error) {
        console.error('ƒ∞lk dolum hatasƒ±:', error);
        showError(error.message, 'ƒ∞lk Dolum Hatasƒ±');
    }
    });
});
</script>

<!-- ƒ∞lk Dolum Modal -->
<div id="ilkDolumModal" class="hidden fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-800 z-10">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">üéØ ƒ∞lk Dolum ƒ∞≈ülemi</h3>
            <button onclick="closeIlkDolumModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <form id="ilkDolumForm" class="p-6 space-y-6">
            <!-- Oda Se√ßimi -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    Oda <span class="text-red-500">*</span>
                </label>
                <select id="ilkDolumOdaSelect" required
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-slate-700 dark:text-slate-200">
                    <option value="">Oda Se√ßin</option>
                </select>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    ‚ö†Ô∏è Her oda i√ßin her √ºr√ºne sadece bir kez ilk dolum yapƒ±labilir
                </p>
            </div>
            
            <!-- √úr√ºn Grubu Se√ßimi -->
            <div id="grupSecimDiv" class="hidden">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    √úr√ºn Grubu <span class="text-red-500">*</span>
                </label>
                <select id="ilkDolumGrupSelect"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-slate-700 dark:text-slate-200">
                    <option value="">T√ºm Gruplar</option>
                </select>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    üí° Grup se√ßerek √ºr√ºnleri filtreleyebilirsiniz
                </p>
            </div>
            
            <!-- √úr√ºn Listesi -->
            <div id="urunListesiDiv" class="hidden">
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    √úr√ºnler <span class="text-red-500">*</span>
                </label>
                <div id="urunListesi" class="space-y-2 max-h-96 overflow-y-auto border border-slate-200 dark:border-slate-700 rounded-lg p-4">
                    <!-- √úr√ºnler buraya y√ºklenecek -->
                </div>
            </div>
            
            <!-- A√ßƒ±klama -->
            <div>
                <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">
                    A√ßƒ±klama
                </label>
                <textarea id="ilkDolumAciklama" rows="2"
                    class="w-full px-4 py-2 border border-slate-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-purple-500 dark:bg-slate-700 dark:text-slate-200"
                    placeholder="ƒ∞steƒüe baƒülƒ± a√ßƒ±klama"></textarea>
            </div>
            
            <!-- Butonlar -->
            <div class="flex justify-end space-x-4 pt-4 border-t border-slate-200 dark:border-slate-700">
                <button type="button" onclick="closeIlkDolumModal()"
                    class="px-6 py-2 border border-slate-300 dark:border-slate-600 rounded-lg text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors">
                    ƒ∞ptal
                </button>
                <button type="submit"
                    class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
                    ƒ∞lk Dolumu Tamamla
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Detay Modal -->
<div id="detayModal" class="hidden fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-slate-800 rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center sticky top-0 bg-white dark:bg-slate-800 z-10">
            <h3 class="text-lg font-semibold text-slate-900 dark:text-slate-100">üìã Minibar ƒ∞≈ülem Detayƒ±</h3>
            <button onclick="closeDetayModal()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>
        
        <div id="detayContent" class="p-6">
            <!-- ƒ∞√ßerik buraya y√ºklenecek -->
        </div>
    </div>
</div>

<script>
// Detay Modal Fonksiyonlarƒ±
async function showDetayModal(islemId) {
    document.getElementById('detayModal').classList.remove('hidden');
    document.getElementById('detayContent').innerHTML = '<div class="text-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div><p class="mt-4 text-slate-600 dark:text-slate-400">Y√ºkleniyor...</p></div>';
    
    try {
        const response = await fetch(`/api/minibar-islem-detay/${islemId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            renderDetayContent(data.islem);
        } else {
            showError(data.message || 'Detaylar y√ºklenemedi');
            closeDetayModal();
        }
    } catch (error) {
        console.error('Detay y√ºkleme hatasƒ±:', error);
        showError('Detaylar y√ºklenirken hata olu≈ütu');
        closeDetayModal();
    }
}

function closeDetayModal() {
    document.getElementById('detayModal').classList.add('hidden');
}

function renderDetayContent(islem) {
    const islemTipiClass = {
        'ilk_dolum': 'bg-purple-100 dark:bg-purple-900/30 text-purple-800 dark:text-purple-400',
        'kontrol': 'bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-400',
        'doldurma': 'bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400'
    };
    
    const islemTipiText = {
        'ilk_dolum': 'ƒ∞lk Dolum',
        'kontrol': 'Kontrol',
        'doldurma': 'Doldurma'
    };
    
    const html = `
        <!-- ƒ∞≈ülem Bilgileri -->
        <div class="bg-slate-50 dark:bg-slate-900 rounded-lg p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <span class="text-sm text-slate-500 dark:text-slate-400">Oda:</span>
                    <p class="text-slate-900 dark:text-slate-100 font-medium">${islem.oda_no} - ${islem.kat_adi}</p>
                </div>
                <div>
                    <span class="text-sm text-slate-500 dark:text-slate-400">ƒ∞≈ülem Tipi:</span>
                    <p class="mt-1">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full ${islemTipiClass[islem.islem_tipi] || ''}">
                            ${islemTipiText[islem.islem_tipi] || islem.islem_tipi}
                        </span>
                    </p>
                </div>
                <div>
                    <span class="text-sm text-slate-500 dark:text-slate-400">Tarih:</span>
                    <p class="text-slate-900 dark:text-slate-100 font-medium">${islem.islem_tarihi}</p>
                </div>
                <div>
                    <span class="text-sm text-slate-500 dark:text-slate-400">ƒ∞≈ülem Yapan:</span>
                    <p class="text-slate-900 dark:text-slate-100 font-medium">${islem.personel}</p>
                </div>
                ${islem.aciklama ? `
                <div class="md:col-span-2">
                    <span class="text-sm text-slate-500 dark:text-slate-400">A√ßƒ±klama:</span>
                    <p class="text-slate-900 dark:text-slate-100">${islem.aciklama}</p>
                </div>
                ` : ''}
            </div>
        </div>

        <!-- √úr√ºn Detaylarƒ± -->
        <div>
            <h4 class="text-md font-semibold text-slate-900 dark:text-slate-100 mb-3">√úr√ºn Detaylarƒ±</h4>
            ${islem.detaylar.length > 0 ? `
                <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                    <table class="min-w-full divide-y divide-slate-200 dark:divide-slate-700">
                        <thead class="bg-slate-50 dark:bg-slate-900">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">√úr√ºn</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Ba≈ülangƒ±√ß</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Eklenen</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">T√ºketim</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Biti≈ü</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-slate-800 divide-y divide-slate-200 dark:divide-slate-700">
                            ${islem.detaylar.map(detay => `
                                <tr class="hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors">
                                    <td class="px-4 py-3 text-sm font-medium text-slate-900 dark:text-slate-100">
                                        ${detay.urun_adi}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-center">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-slate-100 dark:bg-slate-700 text-slate-700 dark:text-slate-300">
                                            ${detay.baslangic_stok}
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 text-sm text-center">
                                        ${detay.eklenen_miktar > 0 ? `
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">
                                                +${detay.eklenen_miktar}
                                            </span>
                                        ` : '<span class="text-slate-400">-</span>'}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-center">
                                        ${detay.tuketim > 0 ? `
                                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400">
                                                -${detay.tuketim}
                                            </span>
                                        ` : '<span class="text-slate-400">-</span>'}
                                    </td>
                                    <td class="px-4 py-3 text-sm text-center">
                                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400">
                                            ${detay.bitis_stok}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            ` : '<p class="text-center py-8 text-slate-500 dark:text-slate-400">Detay bulunamadƒ±</p>'}
        </div>
    `;
    
    document.getElementById('detayContent').innerHTML = html;
}
</script>

{% endblock %}
