{% extends "base.html" %} {% block title %}{{ kat.kat_adi }} Doluluk Detayı -
Minibar Takip Sistemi{% endblock %} {% block page_title %}{{ kat.kat_adi }}
Doluluk Detayı{% endblock %} {% block content %}
<div class="space-y-6">
  <!-- Geri Dön Butonu -->
  <div>
    <a
      href="{{ url_for('doluluk.gunluk_doluluk') }}"
      class="inline-flex items-center text-sm text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-white"
    >
      <i class="fas fa-arrow-left mr-2"></i>
      Günlük Doluluk Raporuna Dön
    </a>
  </div>

  <!-- Başlık ve Tarih -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">
          <i
            class="fas fa-building mr-2 text-slate-600 dark:text-slate-400"
          ></i>
          {{ kat.kat_adi }}
        </h2>
        <p class="text-sm text-slate-600 dark:text-slate-400 mt-1">
          {{ secili_tarih.strftime('%d %B %Y - %A') }}
        </p>
      </div>
      <div class="text-right">
        <div class="text-3xl font-bold text-slate-900 dark:text-white">
          {{ dolu_sayisi }}/{{ toplam_oda }}
        </div>
        <div class="text-sm text-slate-600 dark:text-slate-400">Dolu Oda</div>
      </div>
    </div>
  </div>

  <!-- Özet İstatistikler -->
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <!-- Toplam Oda -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-4">
      <div class="text-slate-500 dark:text-slate-400 text-sm mb-1">
        Toplam Oda
      </div>
      <div class="text-2xl font-bold text-slate-900 dark:text-white">
        {{ toplam_oda }}
      </div>
    </div>

    <!-- Dolu Oda -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-4">
      <div class="text-slate-500 dark:text-slate-400 text-sm mb-1">
        Dolu Oda
      </div>
      <div class="text-2xl font-bold text-red-600 dark:text-red-400">
        {{ dolu_sayisi }}
      </div>
    </div>

    <!-- Bugün Giriş -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-4">
      <div class="text-slate-500 dark:text-slate-400 text-sm mb-1">
        Bugün Giriş
      </div>
      <div class="text-2xl font-bold text-green-600 dark:text-green-400">
        {{ bugun_giris_sayisi }}
      </div>
    </div>

    <!-- Bugün Çıkış -->
    <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-4">
      <div class="text-slate-500 dark:text-slate-400 text-sm mb-1">
        Bugün Çıkış
      </div>
      <div class="text-2xl font-bold text-orange-600 dark:text-orange-400">
        {{ bugun_cikis_sayisi }}
      </div>
    </div>
  </div>

  <!-- Filtreler -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-4">
    <div class="flex flex-wrap items-center gap-2">
      <button
        onclick="filterOdalar('all')"
        class="filter-btn active px-4 py-2 rounded-lg text-sm font-medium transition-colors"
      >
        Tümü ({{ toplam_oda }})
      </button>
      <button
        onclick="filterOdalar('dolu')"
        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors"
      >
        Dolu ({{ dolu_sayisi }})
      </button>
      <button
        onclick="filterOdalar('bos')"
        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors"
      >
        Boş ({{ bos_sayisi }})
      </button>
      <button
        onclick="filterOdalar('bugun_giris')"
        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors"
      >
        Bugün Giriş ({{ bugun_giris_sayisi }})
      </button>
      <button
        onclick="filterOdalar('bugun_cikis')"
        class="filter-btn px-4 py-2 rounded-lg text-sm font-medium transition-colors"
      >
        Bugün Çıkış ({{ bugun_cikis_sayisi }})
      </button>
    </div>
  </div>

  <!-- Oda Listesi -->
  <div class="bg-white dark:bg-slate-800 shadow rounded-lg p-6">
    <div
      class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4"
    >
      <div class="flex items-center gap-4">
        <h3 class="text-lg font-medium text-slate-900 dark:text-white">
          Oda Detayları
        </h3>
        <!-- Bos Odalar Toggle -->
        <!-- Bos Odalar Toggle Switch -->
        <div id="bos_oda_toggle" class="flex items-center gap-2">
          <span class="text-sm font-medium text-slate-600 dark:text-slate-300"
            >Boş Odalar:</span
          >
          <div class="bos-oda-toggle-wrapper">
            <input
              type="checkbox"
              id="bosOdalarSwitch"
              checked
              onchange="setBosOdalar(this.checked)"
            />
            <label for="bosOdalarSwitch" class="bos-oda-toggle">
              <span class="toggle-handler"></span>
              <span class="toggle-on">Göster</span>
              <span class="toggle-off">Gizle</span>
            </label>
          </div>
        </div>
      </div>
      <div class="flex flex-wrap items-center gap-3 text-xs">
        <span class="inline-flex items-center gap-1">
          <span
            class="w-4 h-4 rounded bg-yellow-300 dark:bg-yellow-600 border border-yellow-500"
          ></span>
          <span class="text-slate-600 dark:text-slate-400">In House</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span
            class="w-4 h-4 rounded bg-emerald-200 dark:bg-emerald-800 border border-emerald-500"
          ></span>
          <span class="text-slate-600 dark:text-slate-400">Arrivals</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span
            class="w-4 h-4 rounded bg-purple-200 dark:bg-purple-800 border border-purple-500"
          ></span>
          <span class="text-slate-600 dark:text-slate-400">Departures</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span
            class="w-4 h-4 rounded bg-green-100 dark:bg-green-900/40 border-2 border-green-500"
          ></span>
          <span class="text-slate-600 dark:text-slate-400">Kontrol Edildi</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span
            class="w-4 h-4 rounded bg-orange-100 dark:bg-orange-900/40 border-2 border-orange-500"
          ></span>
          <span class="text-slate-600 dark:text-slate-400">DND</span>
        </span>
        <span class="inline-flex items-center gap-1">
          <span
            class="w-4 h-4 rounded bg-slate-200 dark:bg-slate-700 border border-slate-400"
          ></span>
          <span class="text-slate-600 dark:text-slate-400">Boş</span>
        </span>
      </div>
    </div>

    <div
      class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"
      id="odaGrid"
    >
      {% for oda_detay in oda_detaylari %}
      <div class="oda-card h-full" data-durum="{{ oda_detay.durum }}">
        {% if oda_detay.durum == 'bos' %}
        <!-- Boş Oda - Tıklanabilir -->
        <a
          href="{{ url_for('oda_kontrol') }}?kat_id={{ kat.id }}&oda_id={{ oda_detay.oda.id }}&from_kat_detay=1"
          class="relative block h-full min-h-[160px] p-4 rounded-lg bg-slate-50 dark:bg-slate-900 flex flex-col justify-center transition-colors {% if oda_detay.kontrol_durumu == 'dnd' %} border-4 border-orange-500 dark:border-orange-400 shadow-lg shadow-orange-200 dark:shadow-orange-900/30 {% elif oda_detay.kontrol_durumu == 'completed' %} border-4 border-green-500 dark:border-green-400 shadow-lg shadow-green-200 dark:shadow-green-900/30 {% else %} border-2 border-slate-300 dark:border-slate-600 {% endif %}"
        >
          {% if oda_detay.kontrol_durumu == 'completed' %}
          <span
            class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center rounded-full bg-green-500 text-white"
          >
            <i class="fas fa-check text-xs"></i>
          </span>
          {% elif oda_detay.kontrol_durumu == 'dnd' %}
          <span
            class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center rounded-full bg-orange-500 text-white"
          >
            <i class="fas fa-exclamation text-xs"></i>
          </span>
          {% endif %}
          <div class="text-center">
            <div class="text-xl font-bold text-slate-900 dark:text-white mb-2">
              {{ oda_detay.oda.oda_no }} {% if oda_detay.kontrol_durumu ==
              'completed' %}
              <i
                class="fas fa-check-circle text-green-600 dark:text-green-400 text-sm"
                title="Bugün kontrol edildi"
              ></i>
              {% elif oda_detay.kontrol_durumu == 'dnd' %}
              <i
                class="fas fa-door-closed text-orange-600 dark:text-orange-400 text-sm"
                title="DND"
              ></i>
              {% endif %}
            </div>
            <div class="text-sm text-slate-500 dark:text-slate-400">
              <i class="fas fa-door-open mr-1"></i>Boş
            </div>
            {% if oda_detay.kontrol_durumu %}
            <div
              class="mt-2 text-xs {% if oda_detay.kontrol_durumu == 'dnd' %}text-orange-600 dark:text-orange-400{% else %}text-green-600 dark:text-green-400{% endif %} font-medium"
            >
              {% if oda_detay.kontrol_durumu == 'dnd' %}
              <i class="fas fa-ban mr-1"></i>DND {% else %}
              <i class="fas fa-check mr-1"></i>Kontrol Edildi {% endif %}
            </div>
            {% endif %}
          </div>
        </a>
        {% else %}
        <!-- Dolu Oda -->
        <a
          href="{{ url_for('oda_kontrol') }}?kat_id={{ kat.id }}&oda_id={{ oda_detay.oda.id }}&from_kat_detay=1"
          class="relative block h-full min-h-[160px] p-4 rounded-lg transition-colors flex flex-col {% if oda_detay.kontrol_durumu == 'dnd' or oda_detay.gorev_durumu == 'dnd_pending' %} border-4 border-orange-500 dark:border-orange-400 shadow-lg shadow-orange-200 dark:shadow-orange-900/30 bg-orange-100 dark:bg-orange-900/40 {% elif oda_detay.kontrol_durumu == 'completed' or oda_detay.gorev_durumu == 'completed' %} border-4 border-green-500 dark:border-green-400 shadow-lg shadow-green-200 dark:shadow-green-900/30 bg-green-100 dark:bg-green-900/40 {% elif oda_detay.durum == 'bugun_giris' %} border-2 border-emerald-400 dark:border-emerald-500 bg-emerald-100 dark:bg-emerald-900/40 {% elif oda_detay.durum == 'bugun_cikis' %} border-2 border-purple-400 dark:border-purple-600 bg-purple-100 dark:bg-purple-900/40 {% else %} border-2 border-yellow-400 dark:border-yellow-500 bg-yellow-200 dark:bg-yellow-700 {% endif %}"
        >
          {% if oda_detay.kontrol_durumu == 'completed' or
          oda_detay.gorev_durumu == 'completed' %}
          <span
            class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center rounded-full bg-green-500 text-white"
          >
            <i class="fas fa-check text-xs"></i>
          </span>
          {% elif oda_detay.kontrol_durumu == 'dnd' or oda_detay.gorev_durumu ==
          'dnd_pending' %}
          <span
            class="absolute top-2 right-2 w-6 h-6 flex items-center justify-center rounded-full bg-orange-500 text-white"
          >
            <i class="fas fa-exclamation text-xs"></i>
          </span>
          {% endif %}
          <div class="text-center flex-1 flex flex-col justify-between">
            <div>
              <div
                class="text-xl font-bold mb-1 {% if oda_detay.gorev_durumu == 'completed' %}text-green-900 dark:text-white {% elif oda_detay.gorev_durumu == 'dnd_pending' %}text-orange-900 dark:text-white {% elif oda_detay.durum == 'bugun_giris' %}text-emerald-900 dark:text-white {% elif oda_detay.durum == 'bugun_cikis' %}text-purple-900 dark:text-white {% elif oda_detay.gorev_durumu == 'pending' %}text-yellow-900 dark:text-white {% else %}text-slate-900 dark:text-white{% endif %}"
              >
                {{ oda_detay.oda.oda_no }} {% if oda_detay.gorev_durumu ==
                'completed' %}
                <i
                  class="fas fa-check-circle text-green-700 dark:text-green-200 text-sm"
                  title="Kontrol edildi"
                ></i>
                {% elif oda_detay.gorev_durumu == 'dnd_pending' %}
                <i
                  class="fas fa-door-closed text-orange-800 dark:text-orange-200 text-sm"
                  title="DND"
                ></i>
                {% else %}
                <i
                  class="fas fa-clock text-yellow-700 dark:text-yellow-200 text-sm"
                  title="Bekliyor"
                ></i>
                {% endif %}
              </div>
              <div
                class="text-xs mb-2 {% if oda_detay.gorev_durumu == 'completed' %}text-green-800 dark:text-green-100 {% elif oda_detay.gorev_durumu == 'dnd_pending' %}text-orange-800 dark:text-orange-100 {% elif oda_detay.durum == 'bugun_giris' %}text-emerald-800 dark:text-emerald-100 {% elif oda_detay.durum == 'bugun_cikis' %}text-purple-800 dark:text-purple-100 {% elif oda_detay.gorev_durumu == 'pending' %}text-yellow-800 dark:text-yellow-100 {% else %}text-slate-600 dark:text-slate-400{% endif %}"
              >
                <i class="fas fa-users mr-1"></i>{{
                oda_detay.misafir.misafir_sayisi }} Misafir
              </div>

              {% if oda_detay.durum == 'bugun_giris' %}
              <div
                class="text-xs font-semibold text-emerald-700 dark:text-emerald-300 mb-1"
              >
                <i class="fas fa-plane-arrival mr-1"></i>Arrivals
              </div>
              {% if oda_detay.varis_saati %}
              <div
                data-saat="{{ oda_detay.varis_saati }}"
                class="countdown-timer inline-block px-2 py-1 rounded text-xs font-mono font-bold bg-emerald-600 text-white mb-1"
              >
                --:--:--
              </div>
              {% endif %} {% elif oda_detay.durum == 'bugun_cikis' %}
              <div
                class="text-xs font-semibold text-purple-700 dark:text-purple-300 mb-1"
              >
                <i class="fas fa-plane-departure mr-1"></i>Departures
              </div>
              {% if oda_detay.cikis_saati %}
              <div
                data-saat="{{ oda_detay.cikis_saati }}"
                class="countdown-timer inline-block px-2 py-1 rounded text-xs font-mono font-bold bg-purple-600 text-white mb-1"
              >
                --:--:--
              </div>
              {% endif %} {% else %}
              <div
                class="text-xs font-semibold text-yellow-700 dark:text-yellow-300 mb-1"
              >
                <i class="fas fa-home mr-1"></i>In House
              </div>
              {% endif %}
            </div>

            <div
              class="text-xs space-y-1 {% if oda_detay.gorev_durumu == 'completed' %}text-green-800 dark:text-green-100 {% elif oda_detay.gorev_durumu == 'dnd_pending' %}text-orange-800 dark:text-orange-100 {% elif oda_detay.durum == 'bugun_giris' %}text-emerald-800 dark:text-emerald-100 {% elif oda_detay.durum == 'bugun_cikis' %}text-purple-800 dark:text-purple-100 {% elif oda_detay.gorev_durumu == 'pending' %}text-yellow-800 dark:text-yellow-100 {% else %}text-slate-500 dark:text-slate-400{% endif %}"
            >
              <div>
                Giriş: {{ oda_detay.misafir.giris_tarihi.strftime('%d.%m') }}
              </div>
              <div>
                Çıkış: {{ oda_detay.misafir.cikis_tarihi.strftime('%d.%m') }}
              </div>
              {% if oda_detay.misafir.kalan_gun > 0 %}
              <div class="font-medium">
                {{ oda_detay.misafir.kalan_gun }} gün kaldı
              </div>
              {% endif %}
            </div>
          </div>
        </a>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .filter-btn {
    background: #f1f5f9;
    color: #475569;
  }

  .dark .filter-btn {
    background: #1e293b;
    color: #cbd5e1;
  }

  .filter-btn:hover {
    background: #e2e8f0;
  }

  .dark .filter-btn:hover {
    background: #334155;
  }

  .filter-btn.active {
    background: #3b82f6;
    color: white;
  }

  .dark .filter-btn.active {
    background: #2563eb;
    color: white;
  }

  /* Bos Odalar Toggle Switch */
  .bos-oda-toggle-wrapper {
    display: inline-block;
  }
  .bos-oda-toggle-wrapper input[type="checkbox"] {
    display: none;
  }
  .bos-oda-toggle {
    position: relative;
    display: inline-flex;
    align-items: center;
    width: 100px;
    height: 32px;
    background: linear-gradient(to bottom, #64748b 0%, #475569 100%);
    border-radius: 16px;
    cursor: pointer;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
  }
  .toggle-handler {
    position: absolute;
    left: 2px;
    width: 28px;
    height: 28px;
    background: linear-gradient(to bottom, #f8fafc 0%, #e2e8f0 100%);
    border-radius: 50%;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    transition: left 0.3s ease;
    z-index: 3;
  }
  .toggle-on,
  .toggle-off {
    position: absolute;
    font-size: 11px;
    font-weight: 600;
    transition: opacity 0.3s;
  }
  .toggle-on {
    left: 10px;
    color: white;
    opacity: 0;
  }
  .toggle-off {
    right: 10px;
    color: white;
    opacity: 1;
  }
  .bos-oda-toggle-wrapper input:checked + .bos-oda-toggle {
    background: linear-gradient(to bottom, #2563eb 0%, #1d4ed8 100%);
  }
  .bos-oda-toggle-wrapper input:checked + .bos-oda-toggle .toggle-handler {
    left: 70px;
  }
  .bos-oda-toggle-wrapper input:checked + .bos-oda-toggle .toggle-on {
    opacity: 1;
  }
  .bos-oda-toggle-wrapper input:checked + .bos-oda-toggle .toggle-off {
    opacity: 0;
  }
</style>

<script>
  let mevcutFiltre = "all";
  let bosOdalarGoster = true;

  function filterOdalar(durum) {
    mevcutFiltre = durum;
    const cards = document.querySelectorAll(".oda-card");
    const buttons = document.querySelectorAll(".filter-btn");
    const toggleDiv = document.getElementById("bos_oda_toggle");

    buttons.forEach((btn) => btn.classList.remove("active"));
    event.target.classList.add("active");

    // Toggle sadece Tumu seciliyken gorunsun
    if (toggleDiv) {
      toggleDiv.style.display = durum === "all" ? "flex" : "none";
    }

    cards.forEach((card) => {
      const cardDurum = card.dataset.durum;
      let goster = false;

      if (durum === "all") {
        goster = cardDurum === "bos" ? bosOdalarGoster : true;
      } else if (durum === "dolu") {
        goster = cardDurum !== "bos";
      } else {
        goster = cardDurum === durum;
      }

      card.style.display = goster ? "block" : "none";
    });
  }

  function setBosOdalar(goster) {
    bosOdalarGoster = goster;
    if (mevcutFiltre === "all") {
      document.querySelectorAll(".oda-card").forEach((card) => {
        if (card.dataset.durum === "bos") {
          card.style.display = goster ? "block" : "none";
        }
      });
    }
  }

  // Geri sayım sayaçları
  function updateCountdowns() {
    const timers = document.querySelectorAll(".countdown-timer");
    const now = new Date();

    timers.forEach((timer) => {
      const saatStr = timer.dataset.saat;
      if (!saatStr) return;

      // Saat formatını parse et (HH:MM veya HH:MM:SS)
      const parts = saatStr.split(":");
      const hedefSaat = parseInt(parts[0]) || 0;
      const hedefDakika = parseInt(parts[1]) || 0;
      const hedefSaniye = parseInt(parts[2]) || 0;

      // Bugünün tarihiyle hedef zamanı oluştur
      const hedef = new Date();
      hedef.setHours(hedefSaat, hedefDakika, hedefSaniye, 0);

      // Farkı hesapla (milisaniye)
      const fark = hedef - now;

      if (fark <= 0) {
        // Süre geçmiş
        timer.textContent = "GEÇTİ";
        timer.classList.remove(
          "bg-emerald-600",
          "bg-purple-600",
          "bg-yellow-500"
        );
        timer.classList.add("bg-gray-500");
      } else {
        // Kalan süreyi hesapla
        const saat = Math.floor(fark / (1000 * 60 * 60));
        const dakika = Math.floor((fark % (1000 * 60 * 60)) / (1000 * 60));
        const saniye = Math.floor((fark % (1000 * 60)) / 1000);

        timer.textContent = `${String(saat).padStart(2, "0")}:${String(
          dakika
        ).padStart(2, "0")}:${String(saniye).padStart(2, "0")}`;

        // 30 dakikadan az kaldıysa uyarı rengi
        if (fark < 30 * 60 * 1000) {
          timer.classList.remove("bg-emerald-600", "bg-purple-600");
          timer.classList.add("bg-red-500", "animate-pulse");
        } else if (fark < 60 * 60 * 1000) {
          timer.classList.remove("bg-emerald-600", "bg-purple-600");
          timer.classList.add("bg-yellow-500");
        }
      }
    });
  }

  // Sayfa yüklendiğinde ve her saniye güncelle
  document.addEventListener("DOMContentLoaded", function () {
    updateCountdowns();
    setInterval(updateCountdowns, 1000);
  });
</script>

{% endblock %}
