{% extends "base.html" %}

{% block title %}Minibar Kontrol - Minibar Takip Sistemi{% endblock %}
{% block page_title %}Minibar Kontrol{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Kontrol Formu -->
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-slate-900 mb-6">Minibar Kontrol ve İşlemleri</h3>

            <form id="kontrol_form" method="POST" class="space-y-6">
                <!-- Kat, Oda ve İşlem Tipi Seçimi -->
                <div class="grid grid-cols-1 gap-6 sm:grid-cols-3">
                    <div>
                        <label for="kat_id" class="block text-sm font-medium text-slate-700">
                            Kat <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1">
                            <select id="kat_id" name="kat_id" required
                                class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                <option value="">Kat seçiniz...</option>
                                {% for kat in katlar %}
                                <option value="{{ kat.id }}">{{ kat.kat_adi }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="oda_id" class="block text-sm font-medium text-slate-700">
                            Oda <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1">
                            <select id="oda_id" name="oda_id" required disabled
                                class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                <option value="">Önce kat seçiniz...</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="islem_tipi" class="block text-sm font-medium text-slate-700">
                            İşlem Tipi <span class="text-red-500">*</span>
                        </label>
                        <div class="mt-1">
                            <select id="islem_tipi" name="islem_tipi" required disabled
                                class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                <option value="">Önce oda seçiniz...</option>
                                <option value="ilk_dolum">İlk Dolum</option>
                                <option value="kontrol">Kontrol</option>
                                <option value="doldurma">Doldurma</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Ürün Seçimi Bölümü -->
                <div id="urun_secim_bolumu" class="hidden">
                    <h4 class="text-md font-medium text-slate-900 mb-4">Ürün Seçimi ve Ekleme</h4>

                    <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4 mb-4">
                        <!-- Ürün Grubu Seçimi -->
                        <div>
                            <label for="urun_grubu" class="block text-sm font-medium text-slate-700">
                                Ürün Grubu <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <select id="urun_grubu"
                                    class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                    <option value="">Ürün grubu seçiniz...</option>
                                    {% for grup in urun_gruplari %}
                                    <option value="{{ grup.id }}">{{ grup.grup_adi }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Ürün Seçimi -->
                        <div>
                            <label for="urun_secim" class="block text-sm font-medium text-slate-700">
                                Ürün <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <select id="urun_secim" disabled
                                    class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm">
                                    <option value="">Önce grup seçiniz...</option>
                                </select>
                            </div>
                        </div>

                        <!-- Miktar veya Kontrol Alanları (İşlem tipine göre) -->
                        <div id="miktar_container">
                            <label for="urun_miktar" class="block text-sm font-medium text-slate-700">
                                Miktar <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <input type="number" id="urun_miktar" min="0" step="0.01" disabled
                                    class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"
                                    placeholder="Miktar">
                            </div>
                        </div>

                        <!-- Kontrol için Başlangıç Miktarı -->
                        <div id="baslangic_container" class="hidden">
                            <label for="baslangic_miktar" class="block text-sm font-medium text-slate-700">
                                Başlangıç <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <input type="number" id="baslangic_miktar" min="0" step="0.01" disabled
                                    class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"
                                    placeholder="Başlangıç">
                            </div>
                        </div>

                        <!-- Kontrol için Bitiş Miktarı -->
                        <div id="bitis_container" class="hidden">
                            <label for="bitis_miktar" class="block text-sm font-medium text-slate-700">
                                Bitiş <span class="text-red-500">*</span>
                            </label>
                            <div class="mt-1">
                                <input type="number" id="bitis_miktar" min="0" step="0.01" disabled
                                    class="appearance-none block w-full px-3 py-2 border border-slate-300 rounded-md placeholder-slate-400 focus:outline-none focus:ring-slate-500 focus:border-slate-500 sm:text-sm"
                                    placeholder="Bitiş">
                            </div>
                        </div>
                    </div>

                    <!-- Ürün Detay Bilgisi -->
                    <div id="urun_detay" class="hidden mb-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                        <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-slate-700">Ürün Adı:</span>
                                <p class="text-slate-900 mt-1" id="detay_urun_adi">-</p>
                            </div>
                            <div>
                                <span class="font-medium text-slate-700">Grup:</span>
                                <p class="text-slate-900 mt-1" id="detay_grup_adi">-</p>
                            </div>
                            <div>
                                <span class="font-medium text-slate-700">Birim:</span>
                                <p class="text-slate-900 mt-1" id="detay_birim">-</p>
                            </div>
                            <div>
                                <span class="font-medium text-slate-700">Zimmetimde:</span>
                                <p class="text-slate-900 mt-1">
                                    <span id="zimmet_miktar">-</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Ekle Butonu -->
                    <div class="flex justify-end mb-4">
                        <button type="button" id="urun_ekle_btn" disabled
                            class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            Listeye Ekle
                        </button>
                    </div>

                    <!-- Seçilen Ürünler Listesi -->
                    <div id="secilen_urunler_container" class="hidden">
                        <h5 class="text-sm font-medium text-slate-900 mb-3">Seçilen Ürünler:</h5>
                        <div class="table-wrapper border border-slate-200 rounded-lg">
                            <table class="min-w-full divide-y divide-slate-200">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">
                                            Ürün Adı</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">
                                            Grup</th>
                                        <th id="th_miktar"
                                            class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">
                                            Miktar</th>
                                        <th id="th_baslangic"
                                            class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase hidden">
                                            Başlangıç</th>
                                        <th id="th_bitis"
                                            class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase hidden">
                                            Bitiş</th>
                                        <th id="th_tuketim"
                                            class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase hidden">
                                            Tüketim</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">
                                            İşlem</th>
                                    </tr>
                                </thead>
                                <tbody id="secilen_urunler_tbody" class="bg-white divide-y divide-slate-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Hidden inputs for selected products -->
                <div id="hidden_inputs"></div>

                <div class="flex justify-end space-x-3">
                    <a href="{{ url_for('kat_sorumlusu_dashboard') }}"
                        class="inline-flex justify-center py-2 px-4 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
                        İptal
                    </a>
                    <button type="submit" id="submit_btn" disabled
                        class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-slate-600 hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500 disabled:opacity-50 disabled:cursor-not-allowed">
                        Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    let secilenUrunler = [];
    let mevcutUrunDetay = null;
    let islemTipi = null;
    let mevcutZimmetler = {};

    // Kat değiştiğinde
    document.getElementById( 'kat_id' ).addEventListener( 'change', async function () {
        const katId = this.value;
        const odaSelect = document.getElementById( 'oda_id' );
        const islemSelect = document.getElementById( 'islem_tipi' );

        // Reset
        odaSelect.innerHTML = '<option value="">Oda seçiniz...</option>';
        odaSelect.disabled = true;
        islemSelect.value = '';
        islemSelect.disabled = true;
        document.getElementById( 'urun_secim_bolumu' ).classList.add( 'hidden' );
        secilenUrunler = [];

        if ( !katId ) {
            return;
        }

        try {
            const response = await fetch( `/api/odalar-by-kat/${katId}` );
            const odalar = await response.json();

            if ( odalar.length === 0 ) {
                odaSelect.innerHTML = '<option value="">Bu katta oda yok</option>';
            } else {
                odalar.forEach( oda => {
                    const option = document.createElement( 'option' );
                    option.value = oda.id;
                    option.textContent = oda.oda_numarasi;
                    odaSelect.appendChild( option );
                } );
                odaSelect.disabled = false;
            }
        } catch ( error ) {
            console.error( 'Odalar yüklenirken hata:', error );
            alert( 'Odalar yüklenirken bir hata oluştu!' );
        }
    } );

    // Oda seçildiğinde işlem tipi aktif olsun
    document.getElementById( 'oda_id' ).addEventListener( 'change', function () {
        const odaId = this.value;
        const islemSelect = document.getElementById( 'islem_tipi' );

        if ( odaId ) {
            islemSelect.disabled = false;
        } else {
            islemSelect.disabled = true;
            islemSelect.value = '';
            document.getElementById( 'urun_secim_bolumu' ).classList.add( 'hidden' );
            secilenUrunler = [];
        }
    } );

    // İşlem tipi değiştiğinde
    document.getElementById( 'islem_tipi' ).addEventListener( 'change', async function () {
        islemTipi = this.value;
        const urunSecimBolumu = document.getElementById( 'urun_secim_bolumu' );
        const miktarContainer = document.getElementById( 'miktar_container' );
        const baslangicContainer = document.getElementById( 'baslangic_container' );
        const bitisContainer = document.getElementById( 'bitis_container' );

        const thMiktar = document.getElementById( 'th_miktar' );
        const thBaslangic = document.getElementById( 'th_baslangic' );
        const thBitis = document.getElementById( 'th_bitis' );
        const thTuketim = document.getElementById( 'th_tuketim' );

        // Reset
        secilenUrunler = [];
        updateSecilenUrunlerTable();
        document.getElementById( 'urun_grubu' ).value = '';
        document.getElementById( 'urun_secim' ).innerHTML = '<option value="">Önce grup seçiniz...</option>';
        document.getElementById( 'urun_secim' ).disabled = true;
        document.getElementById( 'urun_detay' ).classList.add( 'hidden' );

        if ( !islemTipi ) {
            urunSecimBolumu.classList.add( 'hidden' );
            return;
        }

        // İşlem tipine göre input alanlarını göster/gizle
        if ( islemTipi === 'kontrol' ) {
            miktarContainer.classList.add( 'hidden' );
            baslangicContainer.classList.remove( 'hidden' );
            bitisContainer.classList.remove( 'hidden' );

            thMiktar.classList.add( 'hidden' );
            thBaslangic.classList.remove( 'hidden' );
            thBitis.classList.remove( 'hidden' );
            thTuketim.classList.remove( 'hidden' );
        } else {
            miktarContainer.classList.remove( 'hidden' );
            baslangicContainer.classList.add( 'hidden' );
            bitisContainer.classList.add( 'hidden' );

            thMiktar.classList.remove( 'hidden' );
            thBaslangic.classList.add( 'hidden' );
            thBitis.classList.add( 'hidden' );
            thTuketim.classList.add( 'hidden' );
        }

        urunSecimBolumu.classList.remove( 'hidden' );

        // Zimmet bilgilerini yükle
        await loadZimmetBilgileri();
    } );

    // Zimmet bilgilerini yükle
    async function loadZimmetBilgileri() {
        try {
            const response = await fetch( '/api/zimmetim' );
            const zimmetler = await response.json();

            mevcutZimmetler = {};
            zimmetler.forEach( z => {
                mevcutZimmetler[z.urun_id] = {
                    kullanilan: z.kullanilan_miktar,
                    kalan: z.kalan_miktar,
                    toplam: z.toplam_miktar,
                    birim: z.birim
                };
            } );
        } catch ( error ) {
            console.error( 'Zimmet bilgileri yüklenirken hata:', error );
        }
    }

    // Ürün grubu değiştiğinde
    document.getElementById( 'urun_grubu' ).addEventListener( 'change', async function () {
        const grupId = this.value;
        const urunSelect = document.getElementById( 'urun_secim' );
        const miktarInput = document.getElementById( 'urun_miktar' );
        const baslangicInput = document.getElementById( 'baslangic_miktar' );
        const bitisInput = document.getElementById( 'bitis_miktar' );
        const urunDetay = document.getElementById( 'urun_detay' );

        // Reset
        urunSelect.innerHTML = '<option value="">Ürün seçiniz...</option>';
        miktarInput.value = '';
        miktarInput.disabled = true;
        baslangicInput.value = '';
        baslangicInput.disabled = true;
        bitisInput.value = '';
        bitisInput.disabled = true;
        urunDetay.classList.add( 'hidden' );
        mevcutUrunDetay = null;
        document.getElementById( 'urun_ekle_btn' ).disabled = true;

        if ( !grupId ) {
            urunSelect.disabled = true;
            return;
        }

        try {
            const response = await fetch( `/api/urunler-by-grup/${grupId}` );
            const urunler = await response.json();

            if ( urunler.length === 0 ) {
                urunSelect.innerHTML = '<option value="">Bu grupta ürün yok</option>';
                urunSelect.disabled = true;
            } else {
                urunler.forEach( urun => {
                    const option = document.createElement( 'option' );
                    option.value = urun.id;
                    option.textContent = urun.urun_adi;
                    urunSelect.appendChild( option );
                } );
                urunSelect.disabled = false;
            }
        } catch ( error ) {
            console.error( 'Ürünler yüklenirken hata:', error );
            alert( 'Ürünler yüklenirken bir hata oluştu!' );
        }
    } );

    // Ürün seçildiğinde
    document.getElementById( 'urun_secim' ).addEventListener( 'change', async function () {
        const urunId = this.value;
        const miktarInput = document.getElementById( 'urun_miktar' );
        const baslangicInput = document.getElementById( 'baslangic_miktar' );
        const bitisInput = document.getElementById( 'bitis_miktar' );
        const urunDetay = document.getElementById( 'urun_detay' );

        if ( !urunId ) {
            miktarInput.disabled = true;
            miktarInput.value = '';
            baslangicInput.disabled = true;
            baslangicInput.value = '';
            bitisInput.disabled = true;
            bitisInput.value = '';
            urunDetay.classList.add( 'hidden' );
            mevcutUrunDetay = null;
            document.getElementById( 'urun_ekle_btn' ).disabled = true;
            return;
        }

        try {
            const response = await fetch( `/api/urun-stok/${urunId}` );
            mevcutUrunDetay = await response.json();

            // Detay bilgilerini göster
            document.getElementById( 'detay_urun_adi' ).textContent = mevcutUrunDetay.urun_adi;
            document.getElementById( 'detay_grup_adi' ).textContent = mevcutUrunDetay.grup_adi;
            document.getElementById( 'detay_birim' ).textContent = mevcutUrunDetay.birim;

            // Zimmet bilgisini göster
            const zimmetInfo = mevcutZimmetler[urunId];
            if ( zimmetInfo ) {
                document.getElementById( 'zimmet_miktar' ).textContent =
                    `${zimmetInfo.kalan} ${zimmetInfo.birim} (Toplam: ${zimmetInfo.toplam})`;
            } else {
                document.getElementById( 'zimmet_miktar' ).textContent = 'Zimmetinizde yok';
            }

            urunDetay.classList.remove( 'hidden' );

            // İşlem tipine göre input aktif et
            if ( islemTipi === 'kontrol' ) {
                baslangicInput.disabled = false;
                bitisInput.disabled = false;
                baslangicInput.focus();
            } else {
                miktarInput.disabled = false;
                miktarInput.focus();
            }

        } catch ( error ) {
            console.error( 'Ürün bilgisi yüklenirken hata:', error );
            alert( 'Ürün bilgisi yüklenirken bir hata oluştu!' );
        }
    } );

    // Miktar input değişikliklerini dinle
    document.getElementById( 'urun_miktar' ).addEventListener( 'input', validateInputs );
    document.getElementById( 'baslangic_miktar' ).addEventListener( 'input', validateInputs );
    document.getElementById( 'bitis_miktar' ).addEventListener( 'input', validateInputs );

    function validateInputs() {
        const ekleBtn = document.getElementById( 'urun_ekle_btn' );

        if ( !mevcutUrunDetay ) {
            ekleBtn.disabled = true;
            return;
        }

        if ( islemTipi === 'kontrol' ) {
            const baslangic = parseFloat( document.getElementById( 'baslangic_miktar' ).value );
            const bitis = parseFloat( document.getElementById( 'bitis_miktar' ).value );
            ekleBtn.disabled = !( baslangic >= 0 && bitis >= 0 );
        } else {
            const miktar = parseFloat( document.getElementById( 'urun_miktar' ).value );
            ekleBtn.disabled = !( miktar > 0 );
        }
    }

    // Listeye ekle butonu
    document.getElementById( 'urun_ekle_btn' ).addEventListener( 'click', function () {
        const urunId = document.getElementById( 'urun_secim' ).value;

        if ( !urunId || !mevcutUrunDetay ) {
            return;
        }

        let urunData = {
            id: urunId,
            urun_adi: mevcutUrunDetay.urun_adi,
            grup_adi: mevcutUrunDetay.grup_adi,
            birim: mevcutUrunDetay.birim
        };

        if ( islemTipi === 'kontrol' ) {
            const baslangic = parseFloat( document.getElementById( 'baslangic_miktar' ).value );
            const bitis = parseFloat( document.getElementById( 'bitis_miktar' ).value );

            if ( !( baslangic >= 0 && bitis >= 0 ) ) {
                alert( 'Lütfen geçerli değerler giriniz!' );
                return;
            }

            const tuketim = baslangic - bitis;
            urunData.baslangic = baslangic;
            urunData.bitis = bitis;
            urunData.tuketim = tuketim;
        } else {
            const miktar = parseFloat( document.getElementById( 'urun_miktar' ).value );

            if ( !( miktar > 0 ) ) {
                alert( 'Lütfen geçerli bir miktar giriniz!' );
                return;
            }

            // Zimmet kontrolü (ilk_dolum ve doldurma işlemlerinde)
            if ( islemTipi === 'ilk_dolum' || islemTipi === 'doldurma' ) {
                const zimmetInfo = mevcutZimmetler[urunId];
                if ( !zimmetInfo || zimmetInfo.kalan < miktar ) {
                    const kalanMiktar = zimmetInfo ? zimmetInfo.kalan : 0;
                    alert( `Yetersiz zimmet! Zimmetinizdeki kalan miktar: ${kalanMiktar} ${mevcutUrunDetay.birim}` );
                    return;
                }
            }

            urunData.miktar = miktar;
        }

        // Aynı ürün kontrol et
        const mevcutIndex = secilenUrunler.findIndex( u => u.id == urunId );
        if ( mevcutIndex !== -1 ) {
            secilenUrunler[mevcutIndex] = urunData;
        } else {
            secilenUrunler.push( urunData );
        }

        // Listeyi güncelle
        updateSecilenUrunlerTable();

        // Formu sıfırla
        document.getElementById( 'urun_grubu' ).value = '';
        document.getElementById( 'urun_secim' ).innerHTML = '<option value="">Önce grup seçiniz...</option>';
        document.getElementById( 'urun_secim' ).disabled = true;
        document.getElementById( 'urun_miktar' ).value = '';
        document.getElementById( 'urun_miktar' ).disabled = true;
        document.getElementById( 'baslangic_miktar' ).value = '';
        document.getElementById( 'baslangic_miktar' ).disabled = true;
        document.getElementById( 'bitis_miktar' ).value = '';
        document.getElementById( 'bitis_miktar' ).disabled = true;
        document.getElementById( 'urun_detay' ).classList.add( 'hidden' );
        document.getElementById( 'urun_ekle_btn' ).disabled = true;
        mevcutUrunDetay = null;
    } );

    // Seçilen ürünler tablosunu güncelle
    function updateSecilenUrunlerTable() {
        const container = document.getElementById( 'secilen_urunler_container' );
        const tbody = document.getElementById( 'secilen_urunler_tbody' );
        const hiddenInputs = document.getElementById( 'hidden_inputs' );
        const submitBtn = document.getElementById( 'submit_btn' );

        if ( secilenUrunler.length === 0 ) {
            container.classList.add( 'hidden' );
            hiddenInputs.innerHTML = '';
            submitBtn.disabled = true;
            return;
        }

        container.classList.remove( 'hidden' );
        submitBtn.disabled = false;
        tbody.innerHTML = '';
        hiddenInputs.innerHTML = '';

        secilenUrunler.forEach( ( urun, index ) => {
            // Tablo satırı
            const tr = document.createElement( 'tr' );

            if ( islemTipi === 'kontrol' ) {
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-slate-900">${urun.urun_adi}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${urun.grup_adi}</td>
                    <td class="px-4 py-3 text-sm text-slate-900 hidden"></td>
                    <td class="px-4 py-3 text-sm text-slate-900">${urun.baslangic} ${urun.birim}</td>
                    <td class="px-4 py-3 text-sm text-slate-900">${urun.bitis} ${urun.birim}</td>
                    <td class="px-4 py-3 text-sm font-medium ${urun.tuketim > 0 ? 'text-red-600' : 'text-green-600'}">
                        ${urun.tuketim} ${urun.birim}
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button type="button" onclick="removeUrun(${index})" 
                            class="text-red-600 hover:text-red-900 font-medium">
                            Sil
                        </button>
                    </td>
                `;
            } else {
                tr.innerHTML = `
                    <td class="px-4 py-3 text-sm text-slate-900">${urun.urun_adi}</td>
                    <td class="px-4 py-3 text-sm text-slate-600">${urun.grup_adi}</td>
                    <td class="px-4 py-3 text-sm text-slate-900">${urun.miktar} ${urun.birim}</td>
                    <td class="px-4 py-3 text-sm text-slate-900 hidden"></td>
                    <td class="px-4 py-3 text-sm text-slate-900 hidden"></td>
                    <td class="px-4 py-3 text-sm text-slate-900 hidden"></td>
                    <td class="px-4 py-3 text-sm">
                        <button type="button" onclick="removeUrun(${index})" 
                            class="text-red-600 hover:text-red-900 font-medium">
                            Sil
                        </button>
                    </td>
                `;
            }

            tbody.appendChild( tr );

            // Hidden inputs for form submission
            const hiddenUrunId = document.createElement( 'input' );
            hiddenUrunId.type = 'hidden';
            hiddenUrunId.name = 'urun_ids';
            hiddenUrunId.value = urun.id;
            hiddenInputs.appendChild( hiddenUrunId );

            if ( islemTipi === 'kontrol' ) {
                const hiddenBaslangic = document.createElement( 'input' );
                hiddenBaslangic.type = 'hidden';
                hiddenBaslangic.name = `baslangic_${urun.id}`;
                hiddenBaslangic.value = urun.baslangic;
                hiddenInputs.appendChild( hiddenBaslangic );

                const hiddenBitis = document.createElement( 'input' );
                hiddenBitis.type = 'hidden';
                hiddenBitis.name = `bitis_${urun.id}`;
                hiddenBitis.value = urun.bitis;
                hiddenInputs.appendChild( hiddenBitis );

                const hiddenTuketim = document.createElement( 'input' );
                hiddenTuketim.type = 'hidden';
                hiddenTuketim.name = `tuketim_${urun.id}`;
                hiddenTuketim.value = urun.tuketim;
                hiddenInputs.appendChild( hiddenTuketim );
            } else {
                const hiddenMiktar = document.createElement( 'input' );
                hiddenMiktar.type = 'hidden';
                hiddenMiktar.name = `miktar_${urun.id}`;
                hiddenMiktar.value = urun.miktar;
                hiddenInputs.appendChild( hiddenMiktar );
            }
        } );
    }

    // Ürünü listeden kaldır
    function removeUrun( index ) {
        secilenUrunler.splice( index, 1 );
        updateSecilenUrunlerTable();
    }

    // Form submit kontrolü
    document.getElementById( 'kontrol_form' ).addEventListener( 'submit', function ( e ) {
        if ( secilenUrunler.length === 0 ) {
            e.preventDefault();
            alert( 'Lütfen en az bir ürün ekleyiniz!' );
            return false;
        }
    } );
</script>
{% endblock %}