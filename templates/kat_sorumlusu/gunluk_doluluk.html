{% extends "base.html" %}

{% block title %}Günlük Doluluk Raporu - Minibar Takip Sistemi{% endblock %}
{% block page_title %}
    <div class="flex items-center gap-4">
        {% if secili_otel %}
            {% if secili_otel.logo %}
            <img src="data:image/png;base64,{{ secili_otel.logo }}" 
                 alt="{{ secili_otel.ad }}" 
                 class="w-16 h-16 rounded-xl object-cover border-2 border-slate-300 dark:border-slate-600 shadow-md">
            {% else %}
            <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-xl flex items-center justify-center shadow-md">
                <i class="fas fa-hotel text-white text-2xl"></i>
            </div>
            {% endif %}
            <div>
                <div class="text-3xl font-bold text-slate-900 dark:text-white">{{ secili_otel.ad }}</div>
                <div class="text-base text-slate-500 dark:text-slate-400 flex items-center gap-2">
                    <i class="fas fa-chart-line"></i>
                    Günlük Doluluk Raporu
                </div>
            </div>
        {% else %}
            Günlük Doluluk Raporu
        {% endif %}
    </div>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Otel Bilgisi Kartı -->
    {% if secili_otel %}
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-slate-800 dark:to-slate-900 rounded-lg shadow border border-blue-200 dark:border-blue-800 p-4">
        <div class="flex items-center gap-3">
            {% if secili_otel.logo %}
            <img src="data:image/png;base64,{{ secili_otel.logo }}" 
                 alt="{{ secili_otel.ad }}" 
                 class="w-14 h-14 rounded-lg object-cover border border-white dark:border-slate-700 shadow">
            {% else %}
            <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow">
                <i class="fas fa-hotel text-white text-xl"></i>
            </div>
            {% endif %}
            <div class="flex-1">
                <h2 class="text-xl font-bold text-slate-900 dark:text-white">{{ secili_otel.ad }}</h2>
                <p class="text-sm text-slate-600 dark:text-slate-400 flex items-center gap-2">
                    <i class="fas fa-chart-line text-xs"></i>
                    Günlük Doluluk Raporu
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tarih Seçimi - Otomatik Submit -->
    <div class="bg-white dark:bg-slate-800 shadow-lg rounded-lg border border-slate-200 dark:border-slate-700">
        <div class="px-4 py-3 sm:p-4">
            <form method="GET" id="tarihForm">
                <!-- Otel ID'yi hidden olarak gönder -->
                {% if secili_otel_id %}
                <input type="hidden" name="otel_id" value="{{ secili_otel_id }}">
                {% endif %}
                
                <div class="max-w-xs">
                    <label for="tarih" class="block text-xs font-medium text-slate-700 dark:text-slate-300 mb-1">
                        <i class="fas fa-calendar mr-1"></i> Tarih Seçin
                    </label>
                    <input type="date" 
                           id="tarih" 
                           name="tarih" 
                           value="{{ secili_tarih.strftime('%Y-%m-%d') }}" 
                           min="2020-01-01"
                           onchange="this.form.submit()"
                           class="appearance-none block w-full px-2 py-1.5 border border-slate-300 dark:border-slate-600 rounded-md bg-white dark:bg-slate-700 text-slate-900 dark:text-white focus:outline-none focus:ring-slate-500 focus:border-slate-500 text-sm cursor-pointer">
                </div>
            </form>
        </div>
    </div>

    <!-- Özet İstatistikler -->
    <div class="grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
        <!-- Toplam Oda -->
        <div class="bg-white dark:bg-slate-800 overflow-hidden shadow-md hover:shadow-lg transition-shadow rounded-lg border border-slate-200 dark:border-slate-700">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-door-open text-3xl text-slate-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400 truncate">
                                Toplam Oda
                            </dt>
                            <dd class="text-3xl font-semibold text-slate-900 dark:text-white">
                                {{ rapor.toplam_oda }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dolu Oda -->
        <div class="bg-white dark:bg-slate-800 overflow-hidden shadow-md hover:shadow-lg transition-shadow rounded-lg border border-slate-200 dark:border-slate-700">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-user-check text-3xl text-red-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400 truncate">
                                Dolu Oda
                            </dt>
                            <dd class="text-3xl font-semibold text-red-600 dark:text-red-400">
                                {{ rapor.dolu_oda }}
                            </dd>
                            <dd class="text-xs text-slate-500 dark:text-slate-400">
                                Boş: {{ rapor.bos_oda }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Giriş Yapacak -->
        <div class="bg-white dark:bg-slate-800 overflow-hidden shadow-md hover:shadow-lg transition-shadow rounded-lg border border-slate-200 dark:border-slate-700">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-sign-in-alt text-3xl text-green-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">
                                Giriş Yapacak<br><span class="text-xs">Bugün</span>
                            </dt>
                            <dd class="text-3xl font-semibold text-green-600 dark:text-green-400">
                                {{ rapor.giris_sayisi }}
                            </dd>
                            <dd class="text-xs text-slate-500 dark:text-slate-400">
                                Misafir
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Çıkış Yapacak -->
        <div class="bg-white dark:bg-slate-800 overflow-hidden shadow-md hover:shadow-lg transition-shadow rounded-lg border border-slate-200 dark:border-slate-700">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-sign-out-alt text-3xl text-orange-600"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-slate-500 dark:text-slate-400">
                                Çıkış Yapacak<br><span class="text-xs">Bugün</span>
                            </dt>
                            <dd class="text-3xl font-semibold text-orange-600 dark:text-orange-400">
                                {{ rapor.cikis_sayisi }}
                            </dd>
                            <dd class="text-xs text-slate-500 dark:text-slate-400">
                                Misafir
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Haftalık Özet -->
    {% if haftalik_ozet %}
    <div class="bg-white dark:bg-slate-800 shadow-lg rounded-lg border border-slate-200 dark:border-slate-700">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white mb-4">
                <i class="fas fa-chart-line mr-2 text-slate-600"></i>
                Haftalık Doluluk Özeti
            </h3>

            <div class="grid grid-cols-7 gap-2">
                {% for gun in haftalik_ozet %}
                <div
                    class="text-center p-3 rounded-lg {% if gun.tarih == secili_tarih %}bg-slate-100 dark:bg-slate-700 border-2 border-slate-400 dark:border-slate-500 shadow-md{% else %}bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800{% endif %}">
                    <div class="text-xs font-medium text-slate-500 dark:text-slate-400 mb-1">
                        {{ gun.gun_adi[:3] }}
                    </div>
                    <div class="text-sm font-semibold text-slate-900 dark:text-white mb-1">
                        {{ gun.tarih.strftime('%d.%m') }}
                    </div>
                    <div
                        class="text-lg font-bold {% if gun.doluluk_orani >= 80 %}text-red-600{% elif gun.doluluk_orani >= 50 %}text-orange-600{% else %}text-green-600{% endif %}">
                        {{ gun.doluluk_orani }}%
                    </div>
                    <div class="text-xs text-slate-500 dark:text-slate-400">
                        {{ gun.dolu_oda }}/{{ gun.toplam_oda }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Kat Bazlı Dolu Odalar (Ekran Görünümü) -->
    {% if rapor.kat_bazli %}
    <div class="bg-white dark:bg-slate-800 shadow-lg rounded-lg border border-slate-200 dark:border-slate-700 screen-only">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-slate-900 dark:text-white mb-4">
                <i class="fas fa-building mr-2 text-slate-600"></i>
                Kat Bazlı Dolu Odalar
            </h3>

            <div class="space-y-6">
                {% for kat_id, kat_info in rapor.kat_bazli.items() %}
                <div class="border-2 border-slate-200 dark:border-slate-700 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <a href="{{ url_for('doluluk.kat_doluluk_detay', kat_id=kat_info.kat.id, tarih=secili_tarih.strftime('%Y-%m-%d')) }}"
                           class="inline-flex items-center px-4 py-2 bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg border border-slate-300 dark:border-slate-600 transition-colors group">
                            <i class="fas fa-building mr-2 text-slate-600 dark:text-slate-400 group-hover:text-slate-900 dark:group-hover:text-white"></i>
                            <span class="text-md font-semibold text-slate-900 dark:text-white">
                                {{ kat_info.kat.kat_adi }}
                            </span>
                            <i class="fas fa-arrow-right ml-2 text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300 text-sm"></i>
                        </a>
                        <span
                            class="px-3 py-1 bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200 rounded-full text-sm font-medium">
                            {{ kat_info.dolu_oda_sayisi }} Dolu Oda
                        </span>
                    </div>

                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        {% for oda_info in kat_info.odalar %}
                        <a href="{{ url_for('doluluk.oda_doluluk_detay', oda_id=oda_info.oda.id) }}"
                            class="block p-3 border-2 border-red-300 dark:border-red-700 rounded-lg hover:bg-red-50 dark:hover:bg-red-900 transition-all shadow-sm hover:shadow-md">
                            <div class="text-center">
                                <div class="text-lg font-bold text-slate-900 dark:text-white mb-1">
                                    {{ oda_info.oda.oda_no }}
                                </div>
                                <div class="text-xs text-slate-600 dark:text-slate-400 mb-1">
                                    <i class="fas fa-bed mr-1"></i>{{ oda_info.oda.oda_tipi if oda_info.oda.oda_tipi else '---' }}
                                </div>
                                <div class="text-xs text-slate-600 dark:text-slate-400">
                                    <i class="fas fa-users mr-1"></i>{{ oda_info.misafir.misafir_sayisi }}
                                </div>
                                <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">
                                    {% if oda_info.kalan_gun == 0 %}
                                    <span class="text-red-600 dark:text-red-400 font-semibold">Bugün Çıkış</span>
                                    {% elif oda_info.kalan_gun == 1 %}
                                    <span class="text-orange-600 dark:text-orange-400">1 gün</span>
                                    {% else %}
                                    {{ oda_info.kalan_gun }} gün
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Dolu Odalar Listesi (Yazdırma Görünümü) -->
    <div class="print-only" style="display: none;">
        <h3 style="font-size: 16pt; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #333; padding-bottom: 8px;">
            Dolu Odalar Listesi
        </h3>
        
        {% for kat_id, kat_info in rapor.kat_bazli.items() %}
        <div style="margin-bottom: 25px; page-break-inside: avoid;">
            <h4 style="font-size: 12pt; font-weight: bold; margin-bottom: 10px; background: #f0f0f0; padding: 8px; border-radius: 4px;">
                {{ kat_info.kat.kat_adi }} - {{ kat_info.dolu_oda_sayisi }} Dolu Oda
            </h4>
            
            <table style="width: 100%; border-collapse: collapse; border: 1px solid #999; font-size: 10pt; margin-bottom: 15px;">
                <thead>
                    <tr style="background: #e8e8e8;">
                        <th style="border: 1px solid #999; padding: 8px; text-align: left; font-weight: bold;">Oda No</th>
                        <th style="border: 1px solid #999; padding: 8px; text-align: left; font-weight: bold;">Oda Tipi</th>
                        <th style="border: 1px solid #999; padding: 8px; text-align: center; font-weight: bold;">Misafir</th>
                        <th style="border: 1px solid #999; padding: 8px; text-align: left; font-weight: bold;">Giriş Tarihi</th>
                        <th style="border: 1px solid #999; padding: 8px; text-align: left; font-weight: bold;">Çıkış Tarihi</th>
                        <th style="border: 1px solid #999; padding: 8px; text-align: center; font-weight: bold;">Kalan Gün</th>
                    </tr>
                </thead>
                <tbody>
                    {% for oda_info in kat_info.odalar %}
                    <tr>
                        <td style="border: 1px solid #ccc; padding: 6px 8px; font-weight: bold; font-size: 11pt;">{{ oda_info.oda.oda_no }}</td>
                        <td style="border: 1px solid #ccc; padding: 6px 8px;">{{ oda_info.oda.oda_tipi if oda_info.oda.oda_tipi else '---' }}</td>
                        <td style="border: 1px solid #ccc; padding: 6px 8px; text-align: center;">{{ oda_info.misafir.misafir_sayisi }}</td>
                        <td style="border: 1px solid #ccc; padding: 6px 8px;">{{ oda_info.misafir.giris_tarihi.strftime('%d.%m.%Y') }}</td>
                        <td style="border: 1px solid #ccc; padding: 6px 8px;">{{ oda_info.misafir.cikis_tarihi.strftime('%d.%m.%Y') }}</td>
                        <td style="border: 1px solid #ccc; padding: 6px 8px; text-align: center;">
                            {% if oda_info.kalan_gun == 0 %}
                            <strong>Bugün Çıkış</strong>
                            {% else %}
                            {{ oda_info.kalan_gun }} gün
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-white dark:bg-slate-800 shadow-lg rounded-lg border border-slate-200 dark:border-slate-700">
        <div class="px-4 py-5 sm:p-6">
            <div class="text-center py-12">
                <i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i>
                <h3 class="text-lg font-medium text-slate-900 dark:text-white mb-2">
                    Tüm Odalar Boş
                </h3>
                <p class="text-slate-500 dark:text-slate-400">
                    {{ secili_tarih.strftime('%d.%m.%Y') }} tarihinde dolu oda bulunmamaktadır.
                </p>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Yazdırma Butonu -->
    <div class="flex justify-end gap-2 no-print">
        <a href="{{ url_for('doluluk.gunluk_doluluk_yazdir', tarih=secili_tarih.strftime('%Y-%m-%d'), otel_id=secili_otel_id) }}" target="_blank"
            class="inline-flex items-center px-4 py-2 border border-slate-300 dark:border-slate-600 text-sm font-medium rounded-md text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 hover:bg-slate-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">
            <i class="fas fa-print mr-2"></i>
            Yazdır
        </a>
    </div>
</div>

<style>
    /* Ekran görünümü */
    .print-only {
        display: none !important;
    }

    .screen-only {
        display: block;
    }

    /* Yazdırma başlığı (ekranda gizli) */
    .print-header {
        display: none;
    }

    @media print {
        /* Görünüm değiştir */
        .screen-only {
            display: none !important;
        }

        .print-only {
            display: block !important;
        }
        
        /* Inline stilleri zorla */
        .print-only * {
            visibility: visible !important;
        }

        /* Yazdırma için gereksiz elemanları gizle */
        nav, .no-print, button, form, .shadow, 
        [class*="hover:"], [class*="focus:"],
        a[href] {
            display: none !important;
        }

        /* Sayfa düzeni */
        @page {
            size: A4 portrait;
            margin: 1.5cm;
        }

        body {
            background: white !important;
            color: black !important;
            font-size: 10pt;
        }

        /* Dark mode renklerini düzelt */
        .dark\:bg-slate-800,
        .dark\:bg-slate-900,
        .dark\:bg-slate-700 {
            background: white !important;
        }

        .dark\:text-white,
        .dark\:text-slate-100,
        .dark\:text-slate-300 {
            color: black !important;
        }

        .dark\:text-slate-400,
        .dark\:text-slate-500 {
            color: #666 !important;
        }

        /* Kenarlıkları düzelt */
        .dark\:border-slate-700,
        .dark\:border-slate-600 {
            border-color: #ddd !important;
        }

        /* Sayfa başlığı */
        .print-header {
            display: block !important;
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #333;
        }

        .print-header h1 {
            font-size: 18pt;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .print-header .print-date {
            font-size: 11pt;
            color: #666;
        }

        /* Kartları düzelt */
        .bg-white, .bg-slate-50 {
            background: white !important;
            box-shadow: none !important;
        }

        /* Özet kartları */
        .grid {
            page-break-inside: avoid;
            margin-bottom: 15px;
        }

        /* Özet kartları küçült */
        .grid-cols-1.gap-5 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            font-size: 9pt;
        }

        /* Renkli badge'ler */
        .bg-red-100 {
            background: #fee !important;
            color: #c00 !important;
        }

        .bg-green-100 {
            background: #efe !important;
            color: #060 !important;
        }

        .bg-orange-100 {
            background: #ffe !important;
            color: #c60 !important;
        }

        .bg-blue-100 {
            background: #eef !important;
            color: #00c !important;
        }

        /* İkonları gizle */
        .fas, .far {
            display: none;
        }

        /* Sayfa sonları */
        .space-y-6 > div {
            page-break-inside: avoid;
        }

        /* Haftalık özet küçült */
        .grid-cols-7 {
            font-size: 8pt;
        }

        /* Tablo stilleri */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            page-break-inside: avoid;
        }

        table th {
            background: #f5f5f5 !important;
            font-weight: bold;
            padding: 8px;
            border: 1px solid #999;
        }

        table td {
            padding: 6px 8px;
            border: 1px solid #ccc;
        }

        /* Liste başlıkları */
        h3, h4 {
            page-break-after: avoid;
        }
    }
</style>

<!-- Yazdırma Başlığı -->
<div class="print-header">
    <h1>Günlük Doluluk Raporu</h1>
    <div class="print-date">{{ secili_tarih.strftime('%d.%m.%Y %A') }}</div>
</div>

{% endblock %}
