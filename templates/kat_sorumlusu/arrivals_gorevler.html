{% extends "base.html" %} {% block title %}Arrivals Görevleri - Minibar Takip
Sistemi{% endblock %} {% block page_title %}Arrivals Kontrol Görevleri{%
endblock %} {% block content %}
<div class="space-y-6">
  <div class="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-6">
      <div>
        <h3 class="text-lg font-medium text-slate-900 dark:text-white">
          <i class="fas fa-plane-arrival mr-2 text-purple-600"></i>{{
          tarih.strftime('%d.%m.%Y') }} - Arrivals Görevleri
        </h3>
        <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">
          <i class="fas fa-sort-amount-down mr-1"></i>Varış saatine göre öncelik
          sıralı
        </p>
      </div>
      <a
        href="{{ url_for('gorev.gorev_listesi') }}"
        class="px-4 py-2 bg-slate-200 dark:bg-slate-700 text-slate-700 dark:text-slate-300 rounded-lg text-sm"
      >
        <i class="fas fa-arrow-left mr-1"></i>Geri
      </a>
    </div>

    <!-- Bekleyen -->
    <h4 class="text-md font-medium text-slate-900 dark:text-white mb-4">
      <i class="fas fa-clock mr-2 text-purple-500"></i>Bekleyen ({{
      bekleyen|length }})
    </h4>
    {% set bekleyen_sirali = bekleyen|sort(attribute='varis_saati') %} {% if
    bekleyen_sirali %}
    <div class="grid gap-3 mb-6">
      {% for gorev in bekleyen_sirali %}
      <div
        class="flex items-center justify-between p-4 rounded-lg border {% if gorev.countdown and gorev.countdown.gecmis %}bg-gray-100 dark:bg-gray-900/20 border-gray-300 dark:border-gray-700{% elif gorev.countdown and gorev.countdown.uyari %}bg-red-50 dark:bg-red-900/20 border-red-300 dark:border-red-800{% elif gorev.countdown and gorev.countdown.toplam_saniye and gorev.countdown.toplam_saniye < 1800 %}bg-yellow-50 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-800{% else %}bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800{% endif %}"
      >
        <div class="flex items-center gap-4">
          <!-- Öncelik Sırası -->
          <div
            class="w-8 h-8 {% if gorev.countdown and gorev.countdown.uyari %}bg-red-200 dark:bg-red-800 text-red-700 dark:text-red-200{% else %}bg-purple-200 dark:bg-purple-800 text-purple-700 dark:text-purple-200{% endif %} rounded-full flex items-center justify-center text-sm font-bold"
          >
            {{ loop.index }}
          </div>
          <div
            class="w-12 h-12 bg-purple-100 dark:bg-purple-900/30 rounded-lg flex items-center justify-center"
          >
            <span class="text-purple-600 dark:text-purple-400 font-bold"
              >{{ gorev.oda_no }}</span
            >
          </div>
          <div>
            <div class="font-medium text-slate-900 dark:text-white">
              Oda {{ gorev.oda_no }}
            </div>
            <div class="text-sm text-slate-500 dark:text-slate-400">
              <i class="fas fa-clock mr-1"></i>Varış: {{ gorev.varis_saati[:5]
              if gorev.varis_saati else 'Belirtilmemiş' }}
            </div>
          </div>
          <!-- Geri Sayım Sayacı -->
          {% if gorev.countdown %}
          <div class="flex flex-col items-center">
            <div class="text-xs text-slate-500 dark:text-slate-400 mb-1">
              Kalan Süre
            </div>
            <div
              id="countdown-{{ gorev.detay_id }}"
              data-varis-saati="{{ gorev.varis_saati }}"
              class="countdown-timer px-4 py-2 rounded-lg text-lg font-mono font-bold {% if gorev.countdown.gecmis %}bg-gray-500 text-white{% elif gorev.countdown.uyari %}bg-red-500 text-white animate-pulse{% elif gorev.countdown.toplam_saniye and gorev.countdown.toplam_saniye < 1800 %}bg-yellow-500 text-white{% else %}bg-purple-500 text-white{% endif %}"
            >
              {% if gorev.countdown.gecmis %}
              <i class="fas fa-exclamation-triangle mr-1"></i>GEÇTİ {% else %}
              {{ '%02d'|format(gorev.countdown.saat) }}:{{
              '%02d'|format(gorev.countdown.dakika) }}:{{
              '%02d'|format(gorev.countdown.saniye) }} {% endif %}
            </div>
            {% if gorev.countdown.uyari and not gorev.countdown.gecmis %}
            <div
              class="text-xs text-red-600 dark:text-red-400 mt-1 font-medium"
            >
              <i class="fas fa-bell mr-1"></i>Acil!
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        <div class="flex gap-2">
          <form
            method="POST"
            action="{{ url_for('gorev.gorev_tamamla', gorev_detay_id=gorev.detay_id) }}"
            class="inline"
          >
            <button
              type="submit"
              class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm"
            >
              <i class="fas fa-check mr-1"></i>Tamamla
            </button>
          </form>
          <form
            method="POST"
            action="{{ url_for('gorev.gorev_dnd', gorev_detay_id=gorev.detay_id) }}"
            class="inline"
          >
            <button
              type="submit"
              class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm"
            >
              <i class="fas fa-door-closed mr-1"></i>DND
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-8 text-slate-500 dark:text-slate-400 mb-6">
      <i class="fas fa-check-circle text-4xl mb-2 text-green-500"></i>
      <p>Tüm Arrivals görevleri tamamlandı!</p>
    </div>
    {% endif %}

    <!-- Tamamlanan -->
    <h4 class="text-md font-medium text-slate-900 dark:text-white mb-4">
      Tamamlanan ({{ tamamlanan|length }})
    </h4>
    {% if tamamlanan %}
    <div class="grid gap-3">
      {% for gorev in tamamlanan %}
      <div
        class="flex items-center justify-between p-4 bg-green-50 dark:bg-green-900/20 rounded-lg border border-green-200 dark:border-green-800"
      >
        <div class="flex items-center gap-4">
          <div
            class="w-12 h-12 bg-green-100 dark:bg-green-900/30 rounded-lg flex items-center justify-center"
          >
            <i class="fas fa-check text-green-600 dark:text-green-400"></i>
          </div>
          <div>
            <div
              class="font-medium text-slate-900 dark:text-white flex items-center gap-2"
            >
              Oda {{ gorev.oda_no }} {% if gorev.kaynak_silindi %}
              <span
                class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-400"
                title="Kaynak doluluk verisi silindi"
              >
                <i class="fas fa-unlink mr-1"></i>Kaynak silindi
              </span>
              {% endif %}
            </div>
            <div class="text-sm text-green-600 dark:text-green-400">
              Tamamlandı: {{ gorev.kontrol_zamani }}
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<script>
  // Geri sayım güncelleme - Client-side hesaplama
  function updateCountdowns() {
    document.querySelectorAll(".countdown-timer").forEach((el) => {
      const varisSaati = el.dataset.varisSaati;
      if (!varisSaati) return;

      const [saat, dakika, saniye] = varisSaati.split(":").map(Number);
      const now = new Date();
      const varisDate = new Date(
        now.getFullYear(),
        now.getMonth(),
        now.getDate(),
        saat,
        dakika,
        saniye || 0
      );
      const fark = varisDate - now;

      if (fark <= 0) {
        el.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>GEÇTİ';
        el.className =
          "countdown-timer px-4 py-2 rounded-lg text-lg font-mono font-bold bg-gray-500 text-white";
        return;
      }

      const toplamSaniye = Math.floor(fark / 1000);
      const kalanSaat = Math.floor(toplamSaniye / 3600);
      const kalanDakika = Math.floor((toplamSaniye % 3600) / 60);
      const kalanSaniye = toplamSaniye % 60;

      el.textContent = `${String(kalanSaat).padStart(2, "0")}:${String(
        kalanDakika
      ).padStart(2, "0")}:${String(kalanSaniye).padStart(2, "0")}`;

      el.classList.remove(
        "bg-purple-500",
        "bg-yellow-500",
        "bg-red-500",
        "animate-pulse",
        "bg-gray-500"
      );
      el.classList.add("text-white");

      if (toplamSaniye < 900) {
        el.classList.add("bg-red-500", "animate-pulse");
      } else if (toplamSaniye < 1800) {
        el.classList.add("bg-yellow-500");
      } else {
        el.classList.add("bg-purple-500");
      }
    });
  }

  setInterval(updateCountdowns, 1000);
  updateCountdowns();
</script>
{% endblock %}
