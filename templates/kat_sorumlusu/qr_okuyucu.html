{% extends "base.html" %} {% block title %}QR Kod Okuyucu - Minibar Takip
Sistemi{% endblock %} {% block page_title %}QR Kod Okuyucu{% endblock %} {%
block content %}
<div class="max-w-4xl mx-auto space-y-6">
  <!-- QR Okuyucu Kartı -->
  <div class="bg-white shadow rounded-lg overflow-hidden">
    <div class="px-4 py-5 sm:p-6">
      <div class="text-center mb-6">
        <div
          class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-indigo-100 mb-4"
        >
          <svg
            class="h-10 w-10 text-indigo-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"
            ></path>
          </svg>
        </div>
        <h3 class="text-lg leading-6 font-medium text-slate-900">
          QR Kod Okutun
        </h3>
        <p class="mt-2 text-sm text-slate-500">
          Kamera ile oda kapısındaki QR kodu okutun
        </p>
      </div>

      <!-- Kamera Önizleme -->
      <div class="relative mb-4">
        <div
          id="camera_container"
          class="relative bg-slate-900 rounded-lg overflow-hidden"
          style="aspect-ratio: 4/3"
        >
          <video
            id="qr_video"
            class="w-full h-full object-cover"
            playsinline
          ></video>

          <!-- Tarama Çerçevesi -->
          <div
            class="absolute inset-0 flex items-center justify-center pointer-events-none"
          >
            <div class="relative w-64 h-64">
              <!-- Köşe İşaretleri -->
              <div
                class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-indigo-500"
              ></div>
              <div
                class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-indigo-500"
              ></div>
              <div
                class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-indigo-500"
              ></div>
              <div
                class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-indigo-500"
              ></div>

              <!-- Tarama Çizgisi -->
              <div
                id="scan_line"
                class="absolute left-0 right-0 h-0.5 bg-indigo-500 shadow-lg shadow-indigo-500/50"
                style="top: 0; animation: scan 2s ease-in-out infinite"
              ></div>
            </div>
          </div>

          <!-- Kamera Kapalı Mesajı -->
          <div
            id="camera_off_message"
            class="absolute inset-0 flex items-center justify-center bg-slate-800"
          >
            <div class="text-center text-white p-6">
              <svg
                class="h-16 w-16 mx-auto mb-4 text-slate-400"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
                ></path>
              </svg>
              <p class="text-lg font-medium mb-2">Kamera Başlatılıyor...</p>
              <p class="text-sm text-slate-400">
                Lütfen kamera erişimine izin verin
              </p>
            </div>
          </div>
        </div>

        <!-- Canvas (QR decode için) -->
        <canvas id="qr_canvas" class="hidden"></canvas>
      </div>

      <!-- Durum Mesajı -->
      <div id="status_message" class="hidden mb-4 p-4 rounded-md border">
        <p id="status_text" class="text-sm font-medium"></p>
      </div>

      <!-- Butonlar -->
      <div class="flex space-x-3">
        <button
          type="button"
          id="toggle_camera_btn"
          class="flex-1 inline-flex justify-center items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
        >
          <svg
            class="h-5 w-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"
            ></path>
          </svg>
          <span id="camera_btn_text">Kamerayı Durdur</span>
        </button>
        <button
          type="button"
          onclick="window.history.back()"
          class="inline-flex justify-center items-center px-4 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500"
        >
          <svg
            class="h-5 w-5 mr-2"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
          İptal
        </button>
      </div>
    </div>
  </div>

  <!-- Yönergeler -->
  <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg
          class="h-5 w-5 text-blue-400"
          fill="currentColor"
          viewBox="0 0 20 20"
        >
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
            clip-rule="evenodd"
          ></path>
        </svg>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-800">Nasıl Kullanılır?</h3>
        <div class="mt-2 text-sm text-blue-700">
          <ul class="list-disc list-inside space-y-1">
            <li>Kamera otomatik olarak açılacak</li>
            <li>QR kodu kamera önüne tutun</li>
            <li>
              Kod otomatik olarak okunup oda kontrolüne yönlendirileceksiniz
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  @keyframes scan {
    0%,
    100% {
      top: 0;
    }
    50% {
      top: calc(100% - 2px);
    }
  }
</style>

<script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
<script>
  const csrfToken = "{{ csrf_token() }}";
  const video = document.getElementById("qr_video");
  const canvas = document.getElementById("qr_canvas");
  const ctx = canvas.getContext("2d");
  const statusMessage = document.getElementById("status_message");
  const statusText = document.getElementById("status_text");
  const cameraOffMessage = document.getElementById("camera_off_message");
  const toggleCameraBtn = document.getElementById("toggle_camera_btn");
  const cameraBtnText = document.getElementById("camera_btn_text");

  let stream = null;
  let scanning = false;
  let lastScannedCode = null;
  let scanTimeout = null;

  // URL parametresinden redirect hedefini al
  const urlParams = new URLSearchParams(window.location.search);
  const redirectPage = urlParams.get("redirect") || "oda-kontrol";

  // Kamera başlat
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" }, // Arka kamera
      });

      video.srcObject = stream;
      video.setAttribute("playsinline", true);
      await video.play();

      cameraOffMessage.classList.add("hidden");
      scanning = true;
      cameraBtnText.textContent = "Kamerayı Durdur";

      requestAnimationFrame(scanQRCode);

      showStatus("info", "Kamera hazır. QR kodu okutabilirsiniz.");
    } catch (error) {
      console.error("Kamera başlatma hatası:", error);
      showStatus("error", "Kamera erişimi reddedildi veya kullanılamıyor");
      cameraOffMessage.querySelector("p").textContent =
        "Kamera erişimi reddedildi";
    }
  }

  // Kamera durdur
  function stopCamera() {
    scanning = false;

    if (stream) {
      stream.getTracks().forEach((track) => track.stop());
      stream = null;
    }

    video.srcObject = null;
    cameraOffMessage.classList.remove("hidden");
    cameraBtnText.textContent = "Kamerayı Başlat";

    showStatus("info", "Kamera durduruldu");
  }

  // Kamera toggle
  toggleCameraBtn.addEventListener("click", function () {
    if (scanning) {
      stopCamera();
    } else {
      startCamera();
    }
  });

  // QR kod tarama
  function scanQRCode() {
    if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
      if (scanning) {
        requestAnimationFrame(scanQRCode);
      }
      return;
    }

    // Canvas boyutunu video boyutuna ayarla
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    // Video frame'ini canvas'a çiz
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Canvas'tan image data al
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

    // QR kod tara
    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "dontInvert",
    });

    if (code && code.data) {
      // Aynı kodu tekrar okumayı önle (3 saniye)
      if (code.data !== lastScannedCode) {
        lastScannedCode = code.data;
        handleQRCode(code.data);

        // 3 saniye sonra aynı kodu tekrar okuyabilsin
        clearTimeout(scanTimeout);
        scanTimeout = setTimeout(() => {
          lastScannedCode = null;
        }, 3000);
      }
    }

    // Taramaya devam et
    if (scanning) {
      requestAnimationFrame(scanQRCode);
    }
  }

  // QR kod işle
  async function handleQRCode(token) {
    console.log("QR Kod okundu:", token);
    showStatus("info", "QR kod okundu, işleniyor...");

    try {
      const response = await fetch("/api/kat-sorumlusu/qr-parse", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken,
        },
        body: JSON.stringify({ token: token }),
      });

      const data = await response.json();

      if (data.success) {
        showStatus("success", `✓ ${data.message} - Yönlendiriliyor...`);

        // Kamerayı durdur
        stopCamera();

        // Yönlendirme yap
        setTimeout(() => {
          const odaData = data.data;
          window.location.href = `/kat-sorumlusu/${redirectPage}?kat_id=${odaData.kat_id}&oda_id=${odaData.oda_id}`;
        }, 1500);
      } else {
        showStatus("error", data.message);
        // 2 saniye sonra tekrar taramaya izin ver
        setTimeout(() => {
          lastScannedCode = null;
          showStatus("info", "Kamera hazır. QR kodu okutabilirsiniz.");
        }, 2000);
      }
    } catch (error) {
      console.error("QR okutma hatası:", error);
      showStatus("error", "QR kod işlenirken bir hata oluştu");
      // 2 saniye sonra tekrar taramaya izin ver
      setTimeout(() => {
        lastScannedCode = null;
        showStatus("info", "Kamera hazır. QR kodu okutabilirsiniz.");
      }, 2000);
    }
  }

  // Durum mesajı göster
  function showStatus(type, message) {
    statusMessage.classList.remove(
      "hidden",
      "bg-red-50",
      "bg-green-50",
      "bg-blue-50",
      "border-red-200",
      "border-green-200",
      "border-blue-200"
    );
    statusText.classList.remove(
      "text-red-800",
      "text-green-800",
      "text-blue-800"
    );

    if (type === "error") {
      statusMessage.classList.add("bg-red-50", "border-red-200");
      statusText.classList.add("text-red-800");
    } else if (type === "success") {
      statusMessage.classList.add("bg-green-50", "border-green-200");
      statusText.classList.add("text-green-800");
    } else {
      statusMessage.classList.add("bg-blue-50", "border-blue-200");
      statusText.classList.add("text-blue-800");
    }

    statusText.textContent = message;
    statusMessage.classList.remove("hidden");
  }

  // Sayfa yüklendiğinde kamerayı başlat
  window.addEventListener("DOMContentLoaded", function () {
    startCamera();
  });

  // Sayfa kapatılırken kamerayı durdur
  window.addEventListener("beforeunload", function () {
    stopCamera();
  });
</script>
{% endblock %}
