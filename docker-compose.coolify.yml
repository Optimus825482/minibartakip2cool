version: "3.8"

# Coolify için Docker Compose Konfigürasyonu
# Redis (sadece Celery broker) + Celery Worker + Celery Beat

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: minibar-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-minibar_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME:-minibar_takip}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      TZ: Europe/Istanbul
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - minibar_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-minibar_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      postgres
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB

  # Redis - Sadece Celery Broker (cache yok)
  redis:
    image: redis:7-alpine
    container_name: minibar-redis
    restart: unless-stopped
    command: redis-server --maxmemory 128mb --maxmemory-policy noeviction
    networks:
      - minibar_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Flask Application
  web:
    build:
      context: .
      dockerfile: Dockerfile.coolify
    container_name: minibar-app
    restart: unless-stopped
    ports:
      - "${PORT:-5000}:5000"
    environment:
      DATABASE_URL: postgresql://${DB_USER:-minibar_user}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-minibar_takip}
      DB_TYPE: postgresql
      SECRET_KEY: ${SECRET_KEY}
      FLASK_ENV: production
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      ML_ENABLED: ${ML_ENABLED:-true}
      ML_MIN_DATA_POINTS: ${ML_MIN_DATA_POINTS:-30}
      ML_MODELS_DIR: /app/ml_models
      GUNICORN_WORKERS: ${GUNICORN_WORKERS:-2}
      GUNICORN_THREADS: ${GUNICORN_THREADS:-4}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-120}
      TZ: Europe/Istanbul
      PYTHONUNBUFFERED: 1
    volumes:
      - ./uploads:/app/uploads
      - ./xls:/app/xls
      - ./static:/app/static
      - ./backups:/app/backups
      - ml_models:/app/ml_models
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minibar_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Worker - Arka plan görevleri
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile.coolify
    container_name: minibar-celery-worker
    restart: unless-stopped
    command: celery -A celery_app worker --loglevel=info --concurrency=2
    environment:
      DATABASE_URL: postgresql://${DB_USER:-minibar_user}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-minibar_takip}
      DB_TYPE: postgresql
      SECRET_KEY: ${SECRET_KEY}
      FLASK_ENV: production
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      ML_ENABLED: ${ML_ENABLED:-true}
      ML_MIN_DATA_POINTS: ${ML_MIN_DATA_POINTS:-30}
      ML_MODELS_DIR: /app/ml_models
      TZ: Europe/Istanbul
      PYTHONUNBUFFERED: 1
    volumes:
      - ./uploads:/app/uploads
      - ./backups:/app/backups
      - ml_models:/app/ml_models
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minibar_network

  # Celery Beat - Zamanlanmış görevler (scheduler)
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.coolify
    container_name: minibar-celery-beat
    restart: unless-stopped
    command: celery -A celery_app beat --loglevel=info
    environment:
      DATABASE_URL: postgresql://${DB_USER:-minibar_user}:${DB_PASSWORD}@postgres:5432/${DB_NAME:-minibar_takip}
      DB_TYPE: postgresql
      SECRET_KEY: ${SECRET_KEY}
      FLASK_ENV: production
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      TZ: Europe/Istanbul
      PYTHONUNBUFFERED: 1
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minibar_network

volumes:
  postgres_data:
    driver: local
  ml_models:
    driver: local

networks:
  minibar_network:
    driver: bridge
