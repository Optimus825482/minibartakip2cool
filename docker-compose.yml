version: "3.8"

services:
  # PostgreSQL Database (Primary)
  postgres:
    image: postgres:15-alpine
    container_name: minibar_postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-minibar_user}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-minibar123}
      POSTGRES_DB: ${DB_NAME:-minibar_takip}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      TZ: UTC
    ports:
      - "5433:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - minibar_network
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${DB_USER:-minibar_user} -d ${DB_NAME:-minibar_takip}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    command: >
      postgres
      -c shared_preload_libraries=pg_stat_statements
      -c pg_stat_statements.track=all
      -c max_connections=100
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=64MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=4MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

  # MySQL Database (Legacy - Migration source)
  mysql:
    image: mysql:8.0
    container_name: minibar_mysql
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${DB_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${DB_NAME:-minibar_takip}
      MYSQL_USER: ${DB_USER:-minibar_user}
      MYSQL_PASSWORD: ${DB_PASSWORD:-minibar123}
    ports:
      - "3307:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init_db.sql:/docker-entrypoint-initdb.d/init_db.sql:ro
    networks:
      - minibar_network
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${DB_PASSWORD:-rootpassword}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - migration # Sadece migration sırasında çalıştır

  # Redis - Sadece Celery Broker (cache yok)
  redis:
    image: redis:7-alpine
    container_name: minibar_redis
    restart: unless-stopped
    command: redis-server --maxmemory 128mb --maxmemory-policy noeviction
    ports:
      - "6379:6379"
    networks:
      - minibar_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Flask Application
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: minibar_app
    restart: unless-stopped
    ports:
      - "5001:5000"
    environment:
      # Database Configuration
      DB_TYPE: postgresql
      DB_HOST: postgres
      DB_USER: ${DB_USER:-minibar_user}
      DB_PASSWORD: ${DB_PASSWORD:-minibar123}
      DB_NAME: ${DB_NAME:-minibar_takip}
      DB_PORT: 5432

      # Flask Configuration
      FLASK_ENV: ${FLASK_ENV:-production}
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}

      # Celery (Redis sadece broker)
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0

      # ML System
      ML_ENABLED: "true"
      ML_MIN_DATA_POINTS: 30

      # Backup Configuration
      BACKUP_DIR: /backups

      # Python Configuration
      PYTHONUNBUFFERED: 1
    volumes:
      - ./uploads:/app/uploads
      - ./xls:/app/xls
      - ./static:/app/static
      - ./backups:/backups
      - ml_models:/app/ml_models
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minibar_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Celery Worker - Arka plan görevleri
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: minibar_celery_worker
    restart: unless-stopped
    command: celery -A celery_app worker --loglevel=info --concurrency=2
    environment:
      DB_TYPE: postgresql
      DB_HOST: postgres
      DB_USER: ${DB_USER:-minibar_user}
      DB_PASSWORD: ${DB_PASSWORD:-minibar123}
      DB_NAME: ${DB_NAME:-minibar_takip}
      DB_PORT: 5432
      FLASK_ENV: ${FLASK_ENV:-production}
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      ML_ENABLED: "true"
      ML_MIN_DATA_POINTS: 30
      PYTHONUNBUFFERED: 1
    volumes:
      - ./uploads:/app/uploads
      - ./backups:/backups
      - ml_models:/app/ml_models
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minibar_network

  # Celery Beat - Zamanlanmış görevler
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: minibar_celery_beat
    restart: unless-stopped
    command: celery -A celery_app beat --loglevel=info
    environment:
      DB_TYPE: postgresql
      DB_HOST: postgres
      DB_USER: ${DB_USER:-minibar_user}
      DB_PASSWORD: ${DB_PASSWORD:-minibar123}
      DB_NAME: ${DB_NAME:-minibar_takip}
      DB_PORT: 5432
      FLASK_ENV: ${FLASK_ENV:-production}
      SECRET_KEY: ${SECRET_KEY:-change-this-secret-key-in-production}
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      PYTHONUNBUFFERED: 1
    volumes:
      - celery_beat_data:/app/celerybeat
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - minibar_network

  # pgAdmin (PostgreSQL yönetimi için)
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: minibar_pgadmin
    restart: unless-stopped
    ports:
      - "${PGADMIN_PORT:-8080}:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@minibar.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin123}
      PGADMIN_CONFIG_SERVER_MODE: "False"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - minibar_network
    profiles:
      - tools

  # phpMyAdmin (MySQL yönetimi için - Migration sırasında)
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: minibar_phpmyadmin
    restart: unless-stopped
    ports:
      - "8082:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: ${DB_USER:-minibar_user}
      PMA_PASSWORD: ${DB_PASSWORD:-minibar123}
    depends_on:
      - mysql
    networks:
      - minibar_network
    profiles:
      - migration

volumes:
  postgres_data:
    driver: local
  mysql_data:
    driver: local
  pgadmin_data:
    driver: local
  ml_models:
    driver: local
  celery_beat_data:
    driver: local

networks:
  minibar_network:
    driver: bridge
